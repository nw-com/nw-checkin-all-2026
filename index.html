<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>西北打卡系統</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 24 24'%3E%3Crect width='24' height='24' rx='5' fill='%23dc2626'/%3E%3Cpath d='M12 20a8 8 0 1 0-8-8 8 8 0 0 0 8 8Z' fill='none' stroke='white' stroke-width='2'/%3E%3Cpath d='M12 8v4l3 1' stroke='white' stroke-width='2' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E" />
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Map for Modules -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0"
      }
    }
    </script>

    <style>
        /* Mobile optimization */
        body {
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
    <script src="./firebase-config.js"></script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAzhLdWtycJgfz8UsXWlji63DkXpA4kmyY&loading=async"></script>
</head>
<body class="bg-gray-100 text-gray-900 font-sans antialiased">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import ReactDOM from 'react-dom/client';
        import { initializeApp, setLogLevel } from 'firebase/app';
        import { 
            getAuth,
            onAuthStateChanged,
            signInWithCustomToken,
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            signOut
        } from 'firebase/auth';
        import { 
            getFirestore, 
            initializeFirestore,
            collection, 
            addDoc, 
            query, 
            where, 
            onSnapshot, 
            orderBy, 
            serverTimestamp,
            getDocs,
            updateDoc,
            setDoc,
            deleteDoc,
            doc
        } from 'firebase/firestore';
        import { 
            Clock, 
            LogOut, 
            Shield, 
            Users, 
            FileText, 
            Briefcase, 
            AlertCircle, 
            CheckCircle, 
            MapPin, 
            Calendar, 
            LayoutDashboard,
            Building2,
            Eye,
            EyeOff,
            Home,
            BarChart3,
            ClipboardList,
            Settings
        } from 'lucide-react';

        // --- Firebase Configuration ---
        // 如果您在本地打開此檔案，請在此處填入您的 Firebase Config
        const manualConfig = null; 
        
        // 嘗試從環境變數或手動設定中獲取配置
        const getFirebaseConfig = () => {
            if (manualConfig) return manualConfig;
            if (typeof window !== 'undefined' && window.FIREBASE_CONFIG) {
                return window.FIREBASE_CONFIG;
            }
            if (typeof __firebase_config !== 'undefined') {
                try {
                    return JSON.parse(__firebase_config);
                } catch (e) {
                    return {};
                }
            }
            return {};
        };

        const firebaseConfig = getFirebaseConfig();
        setLogLevel('silent');
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = initializeFirestore(app, {
            experimentalAutoDetectLongPolling: true,
            ignoreUndefinedProperties: true
        });
        
        // App ID logic for compatibility
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-attendance-app';

        // --- Components ---

        // 1. Loading Spinner (Red Theme)
        const Loading = () => (
            <div className="min-h-screen flex items-center justify-center bg-gray-50">
                <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-red-600"></div>
            </div>
        );

        // 2. Login Component (Mobile Optimized, Red Theme)
        const Login = ({ onLogin, onRegister, isOnline }) => {
            const [email, setEmail] = useState('admin@sys.com');
            const [password, setPassword] = useState('123456');
            const [error, setError] = useState('');
            const [isSeeding, setIsSeeding] = useState(false);
            const [rememberMe, setRememberMe] = useState(true);
            const [showPassword, setShowPassword] = useState(false);

            const handleLogin = async (e) => {
                e.preventDefault();
                if (!email || !password) {
                    setError('請輸入帳號密碼');
                    return;
                }
                try {
                    await onLogin(email, password, rememberMe);
                } catch (e) {
                    if (e && e.code === 'auth/network-request-failed') {
                        setError('網路連線失敗，請確認網路與允許網域設定後重試');
                    } else if (e && e.code === 'auth/invalid-email') {
                        setError('Email 格式不正確');
                    } else if (e && e.code === 'auth/invalid-credential') {
                        setError('帳號或密碼錯誤');
                    } else {
                        setError('登入錯誤，請重試');
                    }
                }
            };


            return (
                <div className="min-h-screen flex flex-col justify-center bg-gray-50 px-6 py-12">
                    <div className="w-full max-w-sm mx-auto bg-white p-8 rounded-3xl shadow-xl border border-gray-100">
                        <div className="text-center mb-8">
                            <div className="bg-red-600 w-20 h-20 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg shadow-red-200 transform rotate-3">
                                <Clock className="text-white w-10 h-10" />
                            </div>
                            <h1 className="text-2xl font-bold text-gray-800 tracking-tight">西北社區打卡系統</h1>
                            <p className="text-gray-400 text-sm mt-2">安居管家 · 智慧服務</p>
                        </div>

                        <form onSubmit={handleLogin} className="space-y-5">
                            <div>
                                <div className="flex items-center justify-between mb-2">
                                    <label className="block text-xs font-bold text-gray-500 uppercase tracking-wider">帳號 (Email)</label>
                                    <label className="flex items-center gap-1 text-[11px] text-gray-500">
                                        <input type="checkbox" checked={rememberMe} onChange={(e) => setRememberMe(e.target.checked)} /> 記住我
                                    </label>
                                </div>
                                <input
                                    type="email"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    className="w-full px-5 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-red-500 outline-none transition text-gray-700 font-medium"
                                    placeholder="user@example.com"
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">密碼</label>
                                <div className="relative">
                                    <input
                                        type={showPassword ? 'text' : 'password'}
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        className="w-full pr-12 px-5 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-red-500 outline-none transition text-gray-700 font-medium"
                                        placeholder="••••••"
                                    />
                                    <button type="button" onClick={() => setShowPassword(!showPassword)} className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-700">
                                        {showPassword ? <EyeOff className="w-5 h-5" /> : <Eye className="w-5 h-5" />}
                                    </button>
                                </div>
                            </div>

                            {error && (
                                <div className={`text-sm text-center p-3 rounded-xl font-medium ${error.includes('完成') ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-600'}`}>
                                    {error}
                                </div>
                            )}

                            <button
                                type="submit"
                                disabled={!isOnline}
                                className="w-full bg-red-600 hover:bg-red-700 active:bg-red-800 text-white font-bold py-4 rounded-xl transition duration-200 shadow-lg shadow-red-200 text-lg disabled:opacity-50"
                            >
                                登入系統
                            </button>
                            <button
                                type="button"
                                disabled={!isOnline}
                                onClick={async () => {
                                    if (!email || !password) {
                                        setError('請輸入帳號密碼');
                                        return;
                                    }
                                    try {
                                        await onRegister(email, password, rememberMe);
                                    } catch (e) {
                                        if (e && e.code === 'auth/network-request-failed') {
                                            setError('網路連線失敗，請確認網路與允許網域設定後重試');
                                        } else if (e && e.code === 'auth/email-already-in-use') {
                                            setError('Email 已被使用，請改用其他帳號');
                                        } else if (e && e.code === 'auth/weak-password') {
                                            setError('密碼強度不足');
                                        } else {
                                            setError('註冊錯誤，請重試');
                                        }
                                    }
                                }}
                                className="w-full mt-3 bg-white hover:bg-gray-50 text-red-600 font-bold py-3 rounded-xl transition border border-red-200 disabled:opacity-50"
                            >
                                註冊帳號
                            </button>
                            
                            {!isOnline && (
                                <div className="mt-3 text-center text-xs text-yellow-700 bg-yellow-50 border border-yellow-200 rounded-xl py-2">
                                    目前離線，請確認網路後再試
                                </div>
                            )}
                        </form>

                        
                    </div>
                </div>
            );
        };

        // 3. Admin Dashboard (System Config)
        const AdminDashboard = ({ currentUser, users, communities, roles, companies, areas, pages, onAddUser, onAddCommunity, subtab }) => {
            const [newCommName, setNewCommName] = useState('');
            const [newUser, setNewUser] = useState({ name: '', email: '', role: 'staff', communityId: '' });
            const [showAddModal, setShowAddModal] = useState(false);
            const [modalUser, setModalUser] = useState({ role: 'admin', title: '', name: '', email: '', phone: '', communityId: '', avatarUrl: '' });
            const [showRoleModal, setShowRoleModal] = useState(false);
            const [roleForm, setRoleForm] = useState({ name: '', permissions: [] });
            const [roleSaving, setRoleSaving] = useState(false);
            const [roleError, setRoleError] = useState('');
            const [showCompanyModal, setShowCompanyModal] = useState(false);
            const [companyForm, setCompanyForm] = useState({ id: '', name: '' });
            const [companySaving, setCompanySaving] = useState(false);
            const [companyError, setCompanyError] = useState('');
            const [showAreaModal, setShowAreaModal] = useState(false);
            const [areaForm, setAreaForm] = useState({ id: '', name: '' });
            const [areaSaving, setAreaSaving] = useState(false);
            const [areaError, setAreaError] = useState('');
            const [userSaving, setUserSaving] = useState(false);
            const [userError, setUserError] = useState('');
            const [confirmDelete, setConfirmDelete] = useState(null);
            const [toast, setToast] = useState('');
            const [editingUserId, setEditingUserId] = useState(null);
            const [showCommunityModal, setShowCommunityModal] = useState(false);
            const [communityForm, setCommunityForm] = useState({ id:'', name:'', companyId:'', areaId:'', gmCount:0, secretaryCount:0, cleanCount:0, mechCount:0, guardCount:0, dayGuardCount:0, nightGuardCount:0, address:'', coordLat:'', coordLng:'', radiusMeters:100 });
            const [communitySaving, setCommunitySaving] = useState(false);
            const [communityError, setCommunityError] = useState('');
            const [mapTarget, setMapTarget] = useState(null);
            const mapTargetElRef = useRef(null);
            const mapTargetMapRef = useRef(null);
            const mapTargetCircleRef = useRef(null);

            const communityMapElRef = useRef(null);
            const communityGMapRef = useRef(null);
            const communityGCircleRef = useRef(null);
            const communityGMarkerRef = useRef(null);
            const communityGClickListenerRef = useRef(null);

            useEffect(()=>{
                if (!showCommunityModal) return;
                if (!window.google || !window.google.maps) return;
                const lat = parseFloat(communityForm.coordLat);
                const lng = parseFloat(communityForm.coordLng);
                const hasCoords = !isNaN(lat) && !isNaN(lng);
                const defaultCenter = { lat: 25.0330, lng: 121.5654 };
                const center = hasCoords ? { lat, lng } : defaultCenter;
                if (!communityGMapRef.current && communityMapElRef.current) {
                    communityGMapRef.current = new google.maps.Map(communityMapElRef.current, { center, zoom: 16 });
                } else if (communityGMapRef.current) {
                    communityGMapRef.current.setCenter(center);
                    communityGMapRef.current.setZoom(16);
                }
                if (hasCoords) {
                    if (!communityGMarkerRef.current) {
                        communityGMarkerRef.current = new google.maps.Marker({ position: center, map: communityGMapRef.current });
                    } else {
                        communityGMarkerRef.current.setPosition(center);
                    }
                }
                if (communityGCircleRef.current) {
                    communityGCircleRef.current.setMap(null);
                    communityGCircleRef.current = null;
                }
                if (hasCoords) {
                    communityGCircleRef.current = new google.maps.Circle({ center, radius: communityForm.radiusMeters || 0, strokeColor: '#dc2626', fillColor: '#dc2626', fillOpacity: 0.15, map: communityGMapRef.current });
                }
                if (communityGClickListenerRef.current) {
                    google.maps.event.removeListener(communityGClickListenerRef.current);
                    communityGClickListenerRef.current = null;
                }
                communityGClickListenerRef.current = google.maps.event.addListener(communityGMapRef.current, 'click', (e) => {
                    const latLng = e.latLng;
                    const newLat = latLng.lat();
                    const newLng = latLng.lng();
                    setCommunityForm(prev => ({ ...prev, coordLat: newLat, coordLng: newLng }));
                    if (!communityGMarkerRef.current) {
                        communityGMarkerRef.current = new google.maps.Marker({ position: latLng, map: communityGMapRef.current });
                    } else {
                        communityGMarkerRef.current.setPosition(latLng);
                    }
                });
            }, [showCommunityModal, communityForm.coordLat, communityForm.coordLng, communityForm.radiusMeters]);

            useEffect(()=>{
                if (!showCommunityModal && communityGMapRef.current) {
                    if (communityGClickListenerRef.current) {
                        google.maps.event.removeListener(communityGClickListenerRef.current);
                        communityGClickListenerRef.current = null;
                    }
                    communityGMarkerRef.current = null;
                    communityGCircleRef.current = null;
                    communityGMapRef.current = null;
                }
            }, [showCommunityModal]);

            useEffect(() => {
                if (!mapTarget) return;
                const init = () => {
                    if (!mapTargetElRef.current) return;
                    const center = { lat: mapTarget.lat, lng: mapTarget.lng };
                    if (!mapTargetMapRef.current) {
                        mapTargetMapRef.current = new google.maps.Map(mapTargetElRef.current, { center, zoom: 16 });
                    } else {
                        mapTargetMapRef.current.setCenter(center);
                        mapTargetMapRef.current.setZoom(16);
                    }
                    new google.maps.Marker({ position: center, map: mapTargetMapRef.current });
                    if (mapTargetCircleRef.current) {
                        mapTargetCircleRef.current.setMap(null);
                        mapTargetCircleRef.current = null;
                    }
                    mapTargetCircleRef.current = new google.maps.Circle({ center, radius: mapTarget.radius || 0, strokeColor: '#dc2626', fillColor: '#dc2626', fillOpacity: 0.15, map: mapTargetMapRef.current });
                };
                if (window.google && window.google.maps) {
                    init();
                } else {
                    const script = document.querySelector('script[src*="maps.googleapis.com/maps/api/js"]');
                    if (script) {
                        const handler = () => init();
                        script.addEventListener('load', handler, { once: true });
                        return () => { script.removeEventListener('load', handler); };
                    }
                }
                return () => {
                    mapTargetCircleRef.current = null;
                    mapTargetMapRef.current = null;
                };
            }, [mapTarget]);

            useEffect(()=>{ if (!toast) return; const t = setTimeout(()=>setToast(''), 2000); return ()=>clearTimeout(t); }, [toast]);

            const handleAvatarUpload = (file) => {
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = 32; canvas.height = 32;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, 32, 32);
                        const dataUrl = canvas.toDataURL('image/png');
                        setModalUser(prev => ({ ...prev, avatarUrl: dataUrl }));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            };

            const handleAddComm = (e) => {
                e.preventDefault();
                if(newCommName) {
                    onAddCommunity(newCommName);
                    setNewCommName('');
                }
            };

            const handleAddUser = (e) => {
                e.preventDefault();
                if(newUser.name && newUser.email && newUser.communityId) {
                    onAddUser(newUser);
                    setNewUser({ name: '', email: '', role: 'staff', communityId: '' });
                }
            };

            const formatDateTime = (v) => {
                if (!v) return '-';
                const d = v && typeof v.toDate === 'function' ? v.toDate() : new Date(v);
                if (!d || isNaN(d.getTime())) return '-';
                const pad = (n) => String(n).padStart(2, '0');
                return `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
            };

            return (
                <div className="space-y-4 pb-20">
                    <div className="grid grid-cols-1 gap-4">
                        {subtab === 'general' && (
                        <div className="space-y-6">
                            <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                                <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                    <Shield className="w-5 h-5 mr-2 text-red-600" /> 角色列表
                                </h3>
                                <div className="mb-4">
                                    <button onClick={() => { setRoleForm({ name: '', permissions: [] }); setShowRoleModal(true); }} className="bg-red-600 text-white px-4 py-2 rounded-xl text-sm font-bold hover:bg-red-700">新增</button>
                                </div>
                                <div className="max-h-60 overflow-y-auto overflow-x-auto no-scrollbar">
                                    <div className="grid grid-cols-4 gap-2 px-3 py-2 text-[11px] font-bold text-gray-500 whitespace-nowrap min-w-[1020px] text-left">
                                        <div>角色名稱</div>
                                        <div>權限</div>
                                        <div>操作</div>
                                        <div>紀錄</div>
                                    </div>
                                    <div className="space-y-2">
                                        {roles.length === 0 ? (
                                            <div className="flex flex-row gap-4 items-center p-3 bg-gray-50 rounded-xl text-xs whitespace-nowrap min-w-[1020px]">
                                                <div className="font-bold text-gray-300 min-w-[160px]">—</div>
                                                <div className="text-gray-300 min-w-[420px]">—</div>
                                                <div className="flex gap-2 justify-start min-w-[180px]">
                                                    <button disabled className="px-2 py-1 rounded bg-gray-200 text-gray-400">編輯</button>
                                                    <button disabled className="px-2 py-1 rounded bg-gray-200 text-gray-400">刪除</button>
                                                </div>
                                                <div className="min-w-[240px] text-gray-300">—</div>
                                            </div>
                                        ) : roles.map(r => (
                                            <div key={r.id} className="flex flex-row gap-4 items-center p-3 bg-gray-50 rounded-xl text-xs whitespace-nowrap min-w-[1020px]">
                                                <div className="font-bold text-gray-700 min-w-[160px]">{r.name}</div>
                                                <div className="text-gray-700 min-w-[420px]">{(r.permissions || []).map(p => pages.find(x=>x.key===p)?.label || p).join('、') || '-'}</div>
                                                <div className="flex gap-2 justify-start min-w-[180px]">
                                                <button onClick={()=>{ setRoleForm({ name: r.name, permissions: r.permissions || [] }); setShowRoleModal(true); setRoleForm(prev=>({ ...prev, id: r.id })); }} className="px-2 py-1 rounded bg-gray-800 text-white">編輯</button>
                                                <button onClick={()=>{ setConfirmDelete({ type:'role', id:r.id, label:r.name }); }} className="px-2 py-1 rounded bg-red-600 text-white">刪除</button>
                                                </div>
                                                <div className="min-w-[240px] text-gray-700">{r.updatedByName ? `${r.updatedByName} ${formatDateTime(r.updatedAt)}` : '-'}</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                {showRoleModal && (
                                    <div className="fixed inset-0 z-[60] bg-black/40 flex items-center justify-center">
                                        <div className="bg-white rounded-2xl shadow-xl w-[90%] max-w-md p-6 max-h-[90vh] overflow-y-auto">
                                            <h4 className="text-lg font-bold text-gray-800 mb-4">新增/編輯角色</h4>
                                            <div className="space-y-3">
                                                <label className="block text-xs font-bold text-gray-500 uppercase">角色名稱</label>
                                                <input className="w-full bg-gray-50 border-0 p-3 rounded-xl text-sm focus:ring-2 focus:ring-red-100" value={roleForm.name} onChange={e=>setRoleForm(prev=>({...prev, name: e.target.value}))} placeholder="例如：系統管理員" />
                                                <div className="text-[11px] text-gray-500">常用：系統管理員、管理層、人事、幹部、總幹事、秘書、清潔、機電、保全</div>
                                                <label className="block text-xs font-bold text-gray-500 uppercase">權限</label>
                                                <div className="grid grid-cols-2 gap-2">
                                                    {pages.map(p => (
                                                        <label key={p.key} className="flex items-center gap-2 text-sm bg-gray-50 px-3 py-2 rounded-xl">
                                                            <input type="checkbox" checked={roleForm.permissions.includes(p.key)} onChange={(e)=>{
                                                                const checked = e.target.checked;
                                                                setRoleForm(prev=>({ ...prev, permissions: checked ? [...prev.permissions, p.key] : prev.permissions.filter(x=>x!==p.key) }));
                                                            }} />
                                                            <span>{p.label}</span>
                                                        </label>
                                                    ))}
                                                </div>
                                                {roleError && <div className="text-xs text-red-600">{roleError}</div>}
                                            </div>
                                            <div className="flex justify-end gap-2 mt-4">
                                                <button onClick={()=>setShowRoleModal(false)} className="px-3 py-2 rounded-xl bg-gray-100 text-gray-700">取消</button>
                                                <button disabled={roleSaving} onClick={async()=>{ try { setRoleError(''); setRoleSaving(true); if (!roleForm.name.trim()) { setRoleError('請輸入角色名稱'); return; } if (roleForm.id) { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'roles', roleForm.id), { name: roleForm.name.trim(), permissions: roleForm.permissions, updatedByName: (dbUser && dbUser.name) || (user && user.email) || '', updatedAt: serverTimestamp() }); setToast('儲存成功'); } else { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'roles'), { name: roleForm.name.trim(), permissions: roleForm.permissions, updatedByName: (dbUser && dbUser.name) || (user && user.email) || '', updatedAt: serverTimestamp() }); setToast('新增成功'); } setShowRoleModal(false); } catch (e) { console.error(e); setRoleError('儲存失敗，請稍後重試'); } finally { setRoleSaving(false);} }} className="px-3 py-2 rounded-xl bg-red-600 text-white">儲存</button>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>

                            <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                                <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                    <Building2 className="w-5 h-5 mr-2 text-red-600" /> 公司列表
                                </h3>
                                <div className="mb-4">
                                    <button onClick={() => { setCompanyForm({ id: '', name: '' }); setShowCompanyModal(true); }} className="bg-red-600 text-white px-4 py-2 rounded-xl text-sm font-bold hover:bg-red-700">新增</button>
                                </div>
                                <div className="max-h-60 overflow-y-auto overflow-x-auto no-scrollbar">
                                    <div className="grid grid-cols-6 gap-2 px-3 py-2 text-[11px] font-bold text-gray-500 whitespace-nowrap min-w-[1000px] text-left">
                                        <div>公司編號</div>
                                        <div>公司名稱</div>
                                        <div>幹部數</div>
                                        <div>員工數</div>
                                        <div>操作</div>
                                        <div>紀錄</div>
                                    </div>
                                    <div className="space-y-2">
                                        {companies.length === 0 ? (
                                            <div className="grid grid-cols-6 gap-2 items-center p-3 bg-gray-50 rounded-xl text-xs whitespace-nowrap min-w-[1000px]">
                                                <div className="font-bold text-gray-300">—</div>
                                                <div className="text-gray-300">—</div>
                                                <div className="text-gray-300">0</div>
                                                <div className="text-gray-300">0</div>
                                                <div className="flex gap-2 justify-start">
                                                    <button disabled className="px-2 py-1 rounded bg-gray-200 text-gray-400">編輯</button>
                                                    <button disabled className="px-2 py-1 rounded bg-gray-200 text-gray-400">刪除</button>
                                                </div>
                                                <div className="text-gray-300">—</div>
                                            </div>
                                        ) : companies.map(c => {
                                            const execCount = users.filter(u => u.companyId === c.id && u.role === 'hr').length;
                                            const staffRoles = ['總幹事','秘書','清潔','機電','保全'];
                                            const staffCount = users.filter(u => u.companyId === c.id && staffRoles.includes(u.role)).length;
                                            return (
                                            <div key={c.id} className="grid grid-cols-6 gap-2 items-center p-3 bg-gray-50 rounded-xl text-xs whitespace-nowrap min-w-[1000px]">
                                                <div className="font-bold text-gray-700">{c.id}</div>
                                                <div className="text-gray-700">{c.name}</div>
                                                <div className="text-gray-700">{execCount}</div>
                                                <div className="text-gray-700">{staffCount}</div>
                                                <div className="flex gap-2 justify-start">
                                                <button onClick={()=>{ setCompanyForm({ id: c.id, name: c.name }); setShowCompanyModal(true); }} className="px-2 py-1 rounded bg-gray-800 text-white">編輯</button>
                                                <button onClick={()=>{ setConfirmDelete({ type:'company', id:c.id, label:c.name }); }} className="px-2 py-1 rounded bg-red-600 text-white">刪除</button>
                                                </div>
                                                <div className="text-gray-700">{c.updatedByName ? `${c.updatedByName} ${formatDateTime(c.updatedAt)}` : '-'}</div>
                                            </div>
                                            );
                                        })}
                                    </div>
                                </div>
                                {showCompanyModal && (
                                    <div className="fixed inset-0 z-[60] bg-black/40 flex items-center justify-center">
                                        <div className="bg-white rounded-2xl shadow-xl w-[90%] max-w-md p-6 max-h-[90vh] overflow-y-auto">
                                            <h4 className="text-lg font-bold text-gray-800 mb-4">新增/編輯公司</h4>
                                            <div className="space-y-3">
                                                <label className="block text-xs font-bold text-gray-500 uppercase">公司編號</label>
                                                <input className="w-full bg-gray-50 border-0 p-3 rounded-xl text-sm focus:ring-2 focus:ring-red-100" value={companyForm.id} onChange={e=>setCompanyForm(prev=>({...prev, id: e.target.value}))} />
                                                <label className="block text-xs font-bold text-gray-500 uppercase">公司名稱</label>
                                                <input className="w-full bg-gray-50 border-0 p-3 rounded-xl text-sm focus:ring-2 focus:ring-red-100" value={companyForm.name} onChange={e=>setCompanyForm(prev=>({...prev, name: e.target.value}))} />
                                                {companyError && <div className="text-xs text-red-600">{companyError}</div>}
                                            </div>
                                            <div className="flex justify-end gap-2 mt-4">
                                                <button onClick={()=>setShowCompanyModal(false)} className="px-3 py-2 rounded-xl bg-gray-100 text-gray-700">取消</button>
                                                <button disabled={companySaving} onClick={async()=>{ try { setCompanyError(''); setCompanySaving(true); if (!companyForm.id.trim() || !companyForm.name.trim()) { setCompanyError('請輸入公司編號與公司名稱'); return; } if (companies.find(x=>x.id===companyForm.id.trim())) { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'companies', companyForm.id.trim()), { name: companyForm.name.trim(), updatedByName: (dbUser && dbUser.name) || (user && user.email) || '', updatedAt: serverTimestamp() }); setToast('儲存成功'); } else { await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'companies', companyForm.id.trim()), { name: companyForm.name.trim(), updatedByName: (dbUser && dbUser.name) || (user && user.email) || '', updatedAt: serverTimestamp() }); setToast('新增成功'); } setShowCompanyModal(false); } catch (e) { console.error(e); setCompanyError('儲存失敗，請稍後重試'); } finally { setCompanySaving(false);} }} className="px-3 py-2 rounded-xl bg-red-600 text-white">儲存</button>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>

                            <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                                <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                    <LayoutDashboard className="w-5 h-5 mr-2 text-red-600" /> 區域列表
                                </h3>
                                <div className="mb-4">
                                    <button onClick={() => { setAreaForm({ id: '', name: '' }); setShowAreaModal(true); }} className="bg-red-600 text-white px-4 py-2 rounded-xl text-sm font-bold hover:bg-red-700">新增</button>
                                </div>
                                <div className="max-h-60 overflow-y-auto overflow-x-auto no-scrollbar">
                                    <div className="grid grid-cols-4 gap-2 px-3 py-2 text-[11px] font-bold text-gray-500 whitespace-nowrap min-w-[800px] text-left">
                                        <div>區域編號</div>
                                        <div>區域名稱</div>
                                        <div>操作</div>
                                        <div>紀錄</div>
                                    </div>
                                    <div className="space-y-2">
                                        {areas.length === 0 ? (
                                            <div className="grid grid-cols-4 gap-2 items-center p-3 bg-gray-50 rounded-xl text-xs whitespace-nowrap min-w-[800px]">
                                                <div className="font-bold text-gray-300">—</div>
                                                <div className="text-gray-300">—</div>
                                                <div className="flex gap-2 justify-start">
                                                    <button disabled className="px-2 py-1 rounded bg-gray-200 text-gray-400">編輯</button>
                                                    <button disabled className="px-2 py-1 rounded bg-gray-200 text-gray-400">刪除</button>
                                                </div>
                                                <div className="text-gray-300">—</div>
                                            </div>
                                        ) : areas.map(a => (
                                            <div key={a.id} className="grid grid-cols-4 gap-2 items-center p-3 bg-gray-50 rounded-xl text-xs whitespace-nowrap min-w-[800px]">
                                                <div className="font-bold text-gray-700">{a.id}</div>
                                                <div className="text-gray-700">{a.name}</div>
                                                <div className="flex gap-2 justify-start">
                                                <button onClick={()=>{ setAreaForm({ id: a.id, name: a.name }); setShowAreaModal(true); }} className="px-2 py-1 rounded bg-gray-800 text-white">編輯</button>
                                                <button onClick={()=>{ setConfirmDelete({ type:'area', id:a.id, label:a.name }); }} className="px-2 py-1 rounded bg-red-600 text-white">刪除</button>
                                                </div>
                                                <div className="text-gray-700">{a.updatedByName ? `${a.updatedByName} ${formatDateTime(a.updatedAt)}` : '-'}</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                {showAreaModal && (
                                    <div className="fixed inset-0 z-[60] bg-black/40 flex items-center justify-center">
                                        <div className="bg-white rounded-2xl shadow-xl w-[90%] max-w-md p-6 max-h-[90vh] overflow-y-auto">
                                            <h4 className="text-lg font-bold text-gray-800 mb-4">新增/編輯區域</h4>
                                            <div className="space-y-3">
                                                <label className="block text-xs font-bold text-gray-500 uppercase">區域編號</label>
                                                <input className="w-full bg-gray-50 border-0 p-3 rounded-xl text-sm focus:ring-2 focus:ring-red-100" value={areaForm.id} onChange={e=>setAreaForm(prev=>({...prev, id: e.target.value}))} />
                                                <label className="block text-xs font-bold text-gray-500 uppercase">區域名稱</label>
                                                <input className="w-full bg-gray-50 border-0 p-3 rounded-xl text-sm focus:ring-2 focus:ring-red-100" value={areaForm.name} onChange={e=>setAreaForm(prev=>({...prev, name: e.target.value}))} />
                                                {areaError && <div className="text-xs text-red-600">{areaError}</div>}
                                            </div>
                                            <div className="flex justify-end gap-2 mt-4">
                                                <button onClick={()=>setShowAreaModal(false)} className="px-3 py-2 rounded-xl bg-gray-100 text-gray-700">取消</button>
                                                <button disabled={areaSaving} onClick={async()=>{ try { setAreaError(''); setAreaSaving(true); if (!areaForm.id.trim() || !areaForm.name.trim()) { setAreaError('請輸入區域編號與區域名稱'); return; } if (areas.find(x=>x.id===areaForm.id.trim())) { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'areas', areaForm.id.trim()), { name: areaForm.name.trim(), updatedByName: (dbUser && dbUser.name) || (user && user.email) || '', updatedAt: serverTimestamp() }); setToast('儲存成功'); } else { await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'areas', areaForm.id.trim()), { name: areaForm.name.trim(), updatedByName: (dbUser && dbUser.name) || (user && user.email) || '', updatedAt: serverTimestamp() }); setToast('新增成功'); } setShowAreaModal(false); } catch (e) { console.error(e); setAreaError('儲存失敗，請稍後重試'); } finally { setAreaSaving(false);} }} className="px-3 py-2 rounded-xl bg-red-600 text-white">儲存</button>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                        )}
                        {subtab === 'account' && (
                        <>
                        <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                            <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                <Users className="w-5 h-5 mr-2 text-red-600" />
                                人員管理
                            </h3>
                            <div className="mb-4">
                                <button onClick={()=>{ setEditingUserId(null); setModalUser({ role:'admin', title:'', name:'', email:'', phone:'', communityId:'', avatarUrl:'' }); setShowAddModal(true); }} className="bg-red-600 text-white px-4 py-2 rounded-xl text-sm font-bold hover:bg-red-700">新增</button>
                            </div>
                            <div className="max-h-60 overflow-y-auto overflow-x-auto no-scrollbar">
                                <div className="grid grid-cols-10 gap-2 px-3 py-2 text-[11px] font-bold text-gray-500 whitespace-nowrap min-w-[1300px] text-left">
                                    <div>角色</div>
                                    <div>大頭照</div>
                                    <div>職稱</div>
                                    <div>姓名</div>
                                    <div>電子郵件</div>
                                    <div>手機號碼</div>
                                    <div>服務社區</div>
                                    <div>狀況</div>
                                    <div>操作</div>
                                    <div>紀錄</div>
                                </div>
                                <div className="space-y-2">
                                    {users.map(u => (
                                        <div key={u.id} className="grid grid-cols-10 gap-2 items-center p-3 bg-gray-50 rounded-xl text-xs whitespace-nowrap min-w-[1300px]">
                                            <div className="font-bold text-gray-700">
                                                {({admin:'系統管理員', manager:'管理層', hr:'幹部', staff:'員工'}[u.role] || u.role)}
                                            </div>
                                            <div className="flex items-center">
                                                {u.avatarUrl ? (
                                                    <img src={u.avatarUrl} alt="avatar" className="max-w-8 max-h-8 rounded-full" />
                                                ) : (
                                                    <div className="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-xs font-bold text-gray-700">{(u.name || '?').charAt(0)}</div>
                                                )}
                                            </div>
                                            <div className="text-gray-700">{u.title || '-'}</div>
                                            <div className="font-bold text-gray-700">{u.name || '-'}</div>
                                            <div className="text-gray-700">{u.email || '-'}</div>
                                            <div className="text-gray-700">{u.phone || '-'}</div>
                                            <div className="text-gray-700">
                                                {(function(){ const c = communities.find(c => c.id === u.communityId); return c ? c.name : '-'; })()}
                                            </div>
                                            <div className="text-gray-700">{u.status || '在職'}</div>
                                            <div className="flex gap-2 justify-start">
                                                <button onClick={()=>{ setEditingUserId(u.id); setModalUser({ role: u.role || 'staff', title: u.title || '', name: u.name || '', email: u.email || '', phone: u.phone || '', communityId: u.communityId || '', avatarUrl: u.avatarUrl || '' }); setShowAddModal(true); }} className="px-2 py-1 rounded bg-gray-800 text-white">編輯</button>
                                                <button onClick={()=>{ setConfirmDelete({ type:'user', id:u.id, label:u.name || u.email || u.id }); }} className="px-2 py-1 rounded bg-red-600 text-white">刪除</button>
                                            </div>
                                            <div className="text-gray-700">{u.updatedByName ? `${u.updatedByName} ${formatDateTime(u.updatedAt)}` : '-'}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                            {showAddModal && (
                                <div className="fixed inset-0 z-[60] bg-black/40 flex items-center justify-center">
                                    <div className="bg-white rounded-2xl shadow-xl w-[90%] max-w-md p-6 max-h-[90vh] overflow-y-auto">
                                        <h4 className="text-lg font-bold text-gray-800 mb-4">新增/編輯人員</h4>
                                        <div className="space-y-3">
                                            <label className="block text-xs font-bold text-gray-500 uppercase">角色</label>
                                            <select className="w-full bg-gray-50 border-0 p-3 rounded-xl text-sm focus:ring-2 focus:ring-red-100" value={modalUser.role} onChange={e=>setModalUser(prev=>({...prev, role: e.target.value}))}>
                                                <option value="admin">系統管理員</option>
                                                <option value="manager">管理層</option>
                                                <option value="hr">幹部</option>
                                                <option value="staff">員工</option>
                                            </select>
                                            <label className="block text-xs font-bold text-gray-500 uppercase">大頭照</label>
                                            <input type="file" accept="image/*" onChange={(e)=>handleAvatarUpload(e.target.files?.[0])} />
                                            {modalUser.avatarUrl && <img src={modalUser.avatarUrl} alt="preview" className="w-8 h-8 rounded-full" />}
                                            <label className="block text-xs font-bold text-gray-500 uppercase">職稱</label>
                                            <input className="w-full bg-gray-50 border-0 p-3 rounded-xl text-sm focus:ring-2 focus:ring-red-100" value={modalUser.title} onChange={e=>setModalUser(prev=>({...prev, title: e.target.value}))} />
                                            <label className="block text-xs font-bold text-gray-500 uppercase">姓名</label>
                                            <input className="w-full bg-gray-50 border-0 p-3 rounded-xl text-sm focus:ring-2 focus:ring-red-100" value={modalUser.name} onChange={e=>setModalUser(prev=>({...prev, name: e.target.value}))} />
                                            <label className="block text-xs font-bold text-gray-500 uppercase">電子郵件（預設帳號）</label>
                                            <input className="w-full bg-gray-50 border-0 p-3 rounded-xl text-sm focus:ring-2 focus:ring-red-100" value={modalUser.email} onChange={e=>setModalUser(prev=>({...prev, email: e.target.value}))} />
                                            <label className="block text-xs font-bold text-gray-500 uppercase">手機號碼（預設密碼）</label>
                                            <input className="w-full bg-gray-50 border-0 p-3 rounded-xl text-sm focus:ring-2 focus:ring-red-100" value={modalUser.phone} onChange={e=>setModalUser(prev=>({...prev, phone: e.target.value}))} />
                                            <label className="block text-xs font-bold text-gray-500 uppercase">服務社區</label>
                                            <select className="w-full bg-gray-50 border-0 p-3 rounded-xl text-sm focus:ring-2 focus:ring-red-100" value={modalUser.communityId} onChange={e=>setModalUser(prev=>({...prev, communityId: e.target.value}))}>
                                                <option value="">選擇社區</option>
                                                {communities.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                            </select>
                                        </div>
                                            {userError && <div className="text-xs text-red-600">{userError}</div>}
                                            <div className="flex justify-end gap-2 mt-4">
                                                <button onClick={()=>{ setShowAddModal(false); setEditingUserId(null); }} className="px-3 py-2 rounded-xl bg-gray-100 text-gray-700">取消</button>
                                                <button disabled={userSaving} onClick={async()=>{ try { setUserError(''); setUserSaving(true); if (editingUserId) { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', editingUserId), { ...modalUser, status: modalUser.status || '在職', updatedByName: (dbUser && dbUser.name) || (user && user.email) || '', updatedAt: serverTimestamp() }); setToast('儲存成功'); } else { await handleAddUser({ ...modalUser, status: '在職' }); setToast('新增成功'); } setShowAddModal(false); setEditingUserId(null); setModalUser({ role:'admin', title:'', name:'', email:'', phone:'', communityId:'', avatarUrl:'' }); } catch(e) { console.error(e); setUserError('儲存失敗，請稍後重試'); } finally { setUserSaving(false);} }} className="px-3 py-2 rounded-xl bg-red-600 text-white">儲存</button>
                                            </div>
                                    </div>
                                </div>
                            )}
                        </div>
                        {confirmDelete && (
                            <div className="fixed inset-0 z-[70] bg-black/40 flex items-center justify-center">
                                <div className="bg-white rounded-2xl shadow-xl w-[90%] max-w-sm p-6 max-h-[90vh] overflow-y-auto">
                                    <div className="text-sm text-gray-700 mb-4">確認刪除{confirmDelete.type==='role'?'角色':confirmDelete.type==='company'?'公司':confirmDelete.type==='area'?'區域':confirmDelete.type==='community'?'社區':'人員'}「{confirmDelete.label}」？</div>
                                    <div className="flex justify-end gap-2">
                                        <button onClick={()=>setConfirmDelete(null)} className="px-3 py-2 rounded-xl bg-gray-100 text-gray-700">取消</button>
                                        <button onClick={async()=>{ try { if (confirmDelete.type==='role') { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'roles', confirmDelete.id)); } else if (confirmDelete.type==='company') { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'companies', confirmDelete.id)); } else if (confirmDelete.type==='area') { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'areas', confirmDelete.id)); } else if (confirmDelete.type==='community') { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'communities', confirmDelete.id)); } else if (confirmDelete.type==='user') { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', confirmDelete.id)); } setConfirmDelete(null); setToast('刪除成功'); } catch(e) { console.error(e); setConfirmDelete(null);} }} className="px-3 py-2 rounded-xl bg-red-600 text-white">刪除</button>
                                    </div>
                                </div>
                            </div>
                        )}
                        {toast && (
                            <div className="fixed top-[10vh] left-1/2 -translate-x-1/2 z-[75] bg-black/70 text-white text-xs px-3 py-2 rounded-xl">{toast}</div>
                        )}
                        </>
                        )}

                        {subtab === 'community' && (
                        <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                            <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                <Building2 className="w-5 h-5 mr-2 text-red-600" />
                                社區列表
                            </h3>
                            <div className="mb-4">
                                <button onClick={()=>{ setCommunityForm({ id:'', name:'', companyId:'', areaId:'', gmCount:0, secretaryCount:0, cleanCount:0, mechCount:0, guardCount:0, dayGuardCount:0, nightGuardCount:0, address:'', coordLat:'', coordLng:'', radiusMeters:100 }); setShowCommunityModal(true); }} className="bg-red-600 text-white px-4 py-2 rounded-xl text-sm font-bold hover:bg-red-700">新增</button>
                            </div>
                            <div className="max-h-60 overflow-y-auto overflow-x-auto no-scrollbar">
                                <div className="flex flex-row gap-2 px-3 py-2 text-[11px] font-bold text-gray-500 whitespace-nowrap min-w-[1820px] text-left">
                                    <div className="w-[120px]">社區編號</div>
                                    <div className="w-[160px]">社區名稱</div>
                                    <div className="w-[140px]">所屬公司</div>
                                    <div className="w-[120px]">所屬區域</div>
                                    <div className="w-[80px]">總幹事數</div>
                                    <div className="w-[80px]">秘書數</div>
                                    <div className="w-[80px]">清潔數</div>
                                    <div className="w-[80px]">機電數</div>
                                    <div className="w-[80px]">保全數</div>
                                    <div className="w-[80px]">白天哨數</div>
                                    <div className="w-[80px]">晚上哨數</div>
                                    <div className="w-[200px]">社區地址</div>
                                    <div className="w-[160px]">社區座標</div>
                                    <div className="w-[120px]">社區地圖</div>
                                    <div className="w-[140px]">設定打卡範圍(公尺)</div>
                                    <div className="w-[160px]">操作</div>
                                    <div className="w-[220px]">紀錄</div>
                                </div>
                                <div className="space-y-2">
                                    {communities.map(c => {
                                        const companyName = (function(){ const cm = companies.find(x=>x.id === c.companyId); return cm ? cm.name : '-'; })();
                                        const areaName = (function(){ const ar = areas.find(x=>x.id === c.areaId); return ar ? ar.name : '-'; })();
                                        const coord = (c.coordLat && c.coordLng) ? `${c.coordLat}, ${c.coordLng}` : '-';
                                        return (
                                            <div key={c.id} className="flex flex-row gap-2 items-center p-3 bg-gray-50 rounded-xl text-xs whitespace-nowrap min-w-[1820px]">
                                                <div className="w-[120px] font-bold text-gray-700">{c.id}</div>
                                                <div className="w-[160px] text-gray-700">{c.name || '-'}</div>
                                                <div className="w-[140px] text-gray-700">{companyName}</div>
                                                <div className="w-[120px] text-gray-700">{areaName}</div>
                                                <div className="w-[80px] text-gray-700">{c.gmCount || 0}</div>
                                                <div className="w-[80px] text-gray-700">{c.secretaryCount || 0}</div>
                                                <div className="w-[80px] text-gray-700">{c.cleanCount || 0}</div>
                                                <div className="w-[80px] text-gray-700">{c.mechCount || 0}</div>
                                                <div className="w-[80px] text-gray-700">{c.guardCount || 0}</div>
                                                <div className="w-[80px] text-gray-700">{c.dayGuardCount || 0}</div>
                                                <div className="w-[80px] text-gray-700">{c.nightGuardCount || 0}</div>
                                                <div className="w-[200px] text-gray-700">{c.address || '-'}</div>
                                                <div className="w-[160px] text-gray-700">{coord}</div>
                                                <div className="w-[120px]">
                                                    <button onClick={()=>{ if (c.coordLat && c.coordLng) { setMapTarget({ name: c.name, lat: parseFloat(c.coordLat), lng: parseFloat(c.coordLng), radius: c.radiusMeters || 0 }); } }} className="px-2 py-1 rounded bg-gray-800 text-white">社區地圖</button>
                                                </div>
                                                <div className="w-[140px] text-gray-700">{c.radiusMeters || 0}</div>
                                                <div className="w-[160px] flex gap-2 justify-start">
                                                    <button onClick={()=>{ setCommunityForm({ id:c.id, name:c.name || '', companyId:c.companyId || '', areaId:c.areaId || '', gmCount:c.gmCount || 0, secretaryCount:c.secretaryCount || 0, cleanCount:c.cleanCount || 0, mechCount:c.mechCount || 0, guardCount:c.guardCount || 0, dayGuardCount:c.dayGuardCount || 0, nightGuardCount:c.nightGuardCount || 0, address:c.address || '', coordLat:c.coordLat || '', coordLng:c.coordLng || '', radiusMeters:c.radiusMeters || 100 }); setShowCommunityModal(true); }} className="px-2 py-1 rounded bg-gray-800 text-white">編輯</button>
                                                    <button onClick={()=>{ setConfirmDelete({ type:'community', id:c.id, label:c.name || c.id }); }} className="px-2 py-1 rounded bg-red-600 text-white">刪除</button>
                                                </div>
                                                <div className="w-[220px] text-gray-700">{c.updatedByName ? `${c.updatedByName} ${formatDateTime(c.updatedAt)}` : '-'}</div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                            {showCommunityModal && (
                                <div className="fixed inset-0 z-[60] bg-black/40 flex items-center justify-center">
                                    <div className="bg-white rounded-2xl shadow-xl w-[90%] max-w-md p-6 max-h-[90vh] overflow-y-auto">
                                        <h4 className="text-lg font-bold text-gray-800 mb-4">新增/編輯社區</h4>
                                        <div className="space-y-3">
                                            <label className="block text-xs font-bold text-gray-500 uppercase">社區編號</label>
                                            <input className="w-full bg-gray-50 border-0 p-3 rounded-xl text-sm focus:ring-2 focus:ring-red-100" value={communityForm.id} onChange={e=>setCommunityForm(prev=>({...prev, id: e.target.value}))} />
                                            <label className="block text-xs font-bold text-gray-500 uppercase">社區名稱</label>
                                            <input className="w-full bg-gray-50 border-0 p-3 rounded-xl text-sm focus:ring-2 focus:ring-red-100" value={communityForm.name} onChange={e=>setCommunityForm(prev=>({...prev, name: e.target.value}))} />
                                            <label className="block text-xs font-bold text-gray-500 uppercase">所屬公司</label>
                                            <select className="w-full bg-gray-50 border-0 p-3 rounded-xl text-sm focus:ring-2 focus:ring-red-100" value={communityForm.companyId} onChange={e=>setCommunityForm(prev=>({...prev, companyId: e.target.value}))}>
                                                <option value="">選擇公司</option>
                                                {companies.map(cm => <option key={cm.id} value={cm.id}>{cm.name}</option>)}
                                            </select>
                                            <label className="block text-xs font-bold text-gray-500 uppercase">所屬區域</label>
                                            <select className="w-full bg-gray-50 border-0 p-3 rounded-xl text-sm focus:ring-2 focus:ring-red-100" value={communityForm.areaId} onChange={e=>setCommunityForm(prev=>({...prev, areaId: e.target.value}))}>
                                                <option value="">選擇區域</option>
                                                {areas.map(ar => <option key={ar.id} value={ar.id}>{ar.name}</option>)}
                                            </select>
                                            <div className="grid grid-cols-2 gap-2">
                                                <div>
                                                    <label className="block text-xs font-bold text-gray-500 uppercase">總幹事數</label>
                                                    <input type="number" className="w-full bg-gray-50 border-0 p-3 rounded-xl text-sm" value={communityForm.gmCount} onChange={e=>setCommunityForm(prev=>({...prev, gmCount: parseInt(e.target.value||'0',10)}))} />
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-bold text-gray-500 uppercase">秘書數</label>
                                                    <input type="number" className="w-full bg-gray-50 border-0 p-3 rounded-xl text-sm" value={communityForm.secretaryCount} onChange={e=>setCommunityForm(prev=>({...prev, secretaryCount: parseInt(e.target.value||'0',10)}))} />
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-bold text-gray-500 uppercase">清潔數</label>
                                                    <input type="number" className="w-full bg-gray-50 border-0 p-3 rounded-xl text-sm" value={communityForm.cleanCount} onChange={e=>setCommunityForm(prev=>({...prev, cleanCount: parseInt(e.target.value||'0',10)}))} />
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-bold text-gray-500 uppercase">機電數</label>
                                                    <input type="number" className="w-full bg-gray-50 border-0 p-3 rounded-xl text-sm" value={communityForm.mechCount} onChange={e=>setCommunityForm(prev=>({...prev, mechCount: parseInt(e.target.value||'0',10)}))} />
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-bold text-gray-500 uppercase">保全數</label>
                                                    <input type="number" className="w-full bg-gray-50 border-0 p-3 rounded-xl text-sm" value={communityForm.guardCount} onChange={e=>setCommunityForm(prev=>({...prev, guardCount: parseInt(e.target.value||'0',10)}))} />
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-bold text-gray-500 uppercase">白天哨數</label>
                                                    <input type="number" className="w-full bg-gray-50 border-0 p-3 rounded-xl text-sm" value={communityForm.dayGuardCount} onChange={e=>setCommunityForm(prev=>({...prev, dayGuardCount: parseInt(e.target.value||'0',10)}))} />
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-bold text-gray-500 uppercase">晚上哨數</label>
                                                    <input type="number" className="w-full bg-gray-50 border-0 p-3 rounded-xl text-sm" value={communityForm.nightGuardCount} onChange={e=>setCommunityForm(prev=>({...prev, nightGuardCount: parseInt(e.target.value||'0',10)}))} />
                                                </div>
                                            </div>
                                            <label className="block text-xs font-bold text-gray-500 uppercase">社區地址</label>
                                            <input className="w-full bg-gray-50 border-0 p-3 rounded-xl text-sm" value={communityForm.address} onChange={e=>setCommunityForm(prev=>({...prev, address: e.target.value}))} onBlur={async(e)=>{ const addr = e.target.value.trim(); if (!addr) return; try { if (window.google && window.google.maps) { const gc = new google.maps.Geocoder(); gc.geocode({ address: addr }, (res, status)=>{ if (status === 'OK' && res && res[0]) { const loc = res[0].geometry.location; setCommunityForm(prev=>({...prev, coordLat: loc.lat(), coordLng: loc.lng()})); } }); } else { const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(addr)}`); const d = await r.json(); if (d && d[0]) { setCommunityForm(prev=>({...prev, coordLat: d[0].lat, coordLng: d[0].lon})); } } } catch {} }} />
                                            <div className="grid grid-cols-2 gap-2">
                                                <div className="col-span-2">
                                                    <label className="block text-xs font-bold text-gray-500 uppercase">社區座標（緯度, 經度）</label>
                                                    <input className="w-full bg-gray-50 border-0 p-3 rounded-xl text-sm" placeholder="例如：25.0330, 121.5654" value={(communityForm.coordLat!=='' && communityForm.coordLng!=='') ? `${communityForm.coordLat}, ${communityForm.coordLng}` : ''} onChange={e=>{ const v = e.target.value; const parts = v.split(','); if (parts.length >= 2) { const lat = parts[0].trim(); const lng = parts[1].trim(); setCommunityForm(prev=>({...prev, coordLat: lat, coordLng: lng})); } else { setCommunityForm(prev=>({...prev, coordLat: v.trim(), coordLng: prev.coordLng})); } }} />
                                                </div>
                                                <div className="col-span-2">
                                                    <label className="block text-xs font-bold text-gray-500 uppercase">設定打卡範圍(公尺)</label>
                                                    <input type="number" className="w-full bg-gray-50 border-0 p-3 rounded-xl text-sm" value={communityForm.radiusMeters} onChange={e=>setCommunityForm(prev=>({...prev, radiusMeters: parseInt(e.target.value||'0',10)}))} />
                                                </div>
                                            </div>
                                            <div className="mt-3">
                                                <div ref={communityMapElRef} className="w-full h-48 rounded-xl border"></div>
                                            </div>
                                            {communityError && <div className="text-xs text-red-600">{communityError}</div>}
                                        </div>
                                        <div className="flex justify-end gap-2 mt-4">
                                            <button onClick={()=>setShowCommunityModal(false)} className="px-3 py-2 rounded-xl bg-gray-100 text-gray-700">取消</button>
                                            <button disabled={communitySaving} onClick={async()=>{ try { setCommunityError(''); setCommunitySaving(true); const id = (communityForm.id || '').trim(); const name = (communityForm.name || '').trim(); if (!id || !name) { setCommunityError('請輸入社區編號與社區名稱'); return; } const latNum = communityForm.coordLat !== '' && communityForm.coordLat != null ? parseFloat(communityForm.coordLat) : undefined; const lngNum = communityForm.coordLng !== '' && communityForm.coordLng != null ? parseFloat(communityForm.coordLng) : undefined; const payload = { name, companyId: communityForm.companyId || '', areaId: communityForm.areaId || '', gmCount: communityForm.gmCount||0, secretaryCount: communityForm.secretaryCount||0, cleanCount: communityForm.cleanCount||0, mechCount: communityForm.mechCount||0, guardCount: communityForm.guardCount||0, dayGuardCount: communityForm.dayGuardCount||0, nightGuardCount: communityForm.nightGuardCount||0, address: communityForm.address||'', coordLat: latNum, coordLng: lngNum, radiusMeters: communityForm.radiusMeters||0, updatedByName: (dbUser && dbUser.name) || (user && user.email) || '', updatedAt: serverTimestamp() }; await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'communities', id), payload, { merge: true }); setShowCommunityModal(false); setToast(communities.find(x=>x.id===id)?'儲存成功':'新增成功'); } catch(e) { console.error(e); setCommunityError('儲存失敗，請稍後重試'); } finally { setCommunitySaving(false);} }} className="px-3 py-2 rounded-xl bg-red-600 text-white">儲存</button>
                                        </div>
                                    </div>
                                </div>
                            )}
                            {mapTarget && (
                                <div className="fixed inset-0 z-[60] bg-black/40 flex items-center justify-center">
                                    <div className="bg-white rounded-2xl shadow-xl w-[90%] max-w-md p-6 max-h-[90vh] overflow-y-auto">
                                        <h4 className="text-lg font-bold text-gray-800 mb-4">{mapTarget.name || '社區地圖'}</h4>
                                        <div ref={mapTargetElRef} className="w-full h-80 rounded-xl border"></div>
                                        <div className="flex justify-end gap-2 mt-4">
                                            <button onClick={()=>setMapTarget(null)} className="px-3 py-2 rounded-xl bg-gray-100 text-gray-700">關閉</button>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                        )}
                    </div>
                </div>
            );
        };

        // 4. Staff Dashboard
        const StaffDashboard = ({ currentUser, onClockIn, attendanceHistory }) => {
            const [currentTime, setCurrentTime] = useState(new Date());

            useEffect(() => {
                const timer = setInterval(() => setCurrentTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);

            const lastRecord = attendanceHistory[0];
            const isWorking = lastRecord && lastRecord.type === 'in';

            return (
                <div className="max-w-md mx-auto space-y-4 pb-20">
                    {/* Header Info Card */}
                    <div className="bg-gradient-to-br from-red-600 to-red-700 rounded-3xl shadow-xl shadow-red-200 overflow-hidden relative">
                        <div className="absolute top-0 right-0 p-4 opacity-10">
                            <Clock className="w-32 h-32 transform rotate-12 text-white" />
                        </div>
                        <div className="p-6 relative z-10 text-white">
                            <div className="flex justify-between items-start mb-6">
                                <div>
                                    <h2 className="text-2xl font-bold">{currentUser.name}</h2>
                                    <p className="text-red-100 text-sm flex items-center gap-1 mt-1">
                                        <Building2 className="w-3 h-3" />
                                        {currentUser.communityName || '未分配'}
                                    </p>
                                </div>
                                <div className="bg-white/20 backdrop-blur-sm px-3 py-1 rounded-full text-xs font-mono">
                                    {isWorking ? '工作中' : '未打卡'}
                                </div>
                            </div>
                            <div className="text-center py-4">
                                <div className="text-5xl font-bold font-mono tracking-wider drop-shadow-sm">
                                    {currentTime.toLocaleTimeString('zh-TW', { hour12: false, hour: '2-digit', minute:'2-digit' })}
                                </div>
                                <p className="text-red-100 text-sm mt-2 opacity-80">
                                    {currentTime.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' })}
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    {/* Big Action Button */}
                    <div className="px-2">
                        <button
                            onClick={() => onClockIn(isWorking ? 'out' : 'in')}
                            className={`w-full h-32 rounded-3xl flex flex-row items-center justify-center gap-4 shadow-lg transition-all transform active:scale-95 ${
                                isWorking 
                                ? 'bg-gray-800 text-white border-2 border-gray-700' 
                                : 'bg-white text-red-600 border-2 border-red-100'
                            }`}
                        >
                            {isWorking ? (
                                <>
                                    <div className="bg-gray-700 p-3 rounded-full">
                                        <LogOut className="w-8 h-8" />
                                    </div>
                                    <div className="text-left">
                                        <span className="block text-2xl font-bold">下班簽退</span>
                                        <span className="text-xs text-gray-400">結束今日勤務</span>
                                    </div>
                                </>
                            ) : (
                                <>
                                    <div className="bg-red-50 p-3 rounded-full">
                                        <MapPin className="w-8 h-8 text-red-600" />
                                    </div>
                                    <div className="text-left">
                                        <span className="block text-2xl font-bold">上班打卡</span>
                                        <span className="text-xs text-gray-400">紀錄開始時間</span>
                                    </div>
                                </>
                            )}
                        </button>
                        
                        <div className="mt-4 text-center">
                            <div className="inline-flex items-center gap-2 px-4 py-2 bg-gray-100 rounded-full text-xs text-gray-500 font-medium">
                                <CheckCircle className="w-3 h-3 text-green-500" />
                                GPS 定位訊號良好
                            </div>
                        </div>
                    </div>

                    {/* History List */}
                    <div className="bg-white rounded-3xl shadow-sm border border-gray-100 p-5">
                        <h3 className="font-bold text-gray-800 mb-4 text-sm flex items-center justify-between">
                            <span>最近紀錄</span>
                            <span className="text-xs text-gray-400 font-normal">顯示最近 5 筆</span>
                        </h3>
                        <div className="space-y-4">
                            {attendanceHistory.length === 0 ? (
                                <div className="text-center py-8">
                                    <div className="bg-gray-50 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-2">
                                        <Calendar className="w-5 h-5 text-gray-300" />
                                    </div>
                                    <p className="text-gray-400 text-xs">尚無打卡紀錄</p>
                                </div>
                            ) : (
                                attendanceHistory.slice(0, 5).map((record, idx) => (
                                    <div key={record.id} className="flex relative">
                                        {idx !== attendanceHistory.slice(0, 5).length - 1 && (
                                            <div className="absolute left-2.5 top-8 bottom-[-16px] w-0.5 bg-gray-100"></div>
                                        )}
                                        <div className={`relative z-10 w-5 h-5 rounded-full border-2 flex-shrink-0 mt-1 mr-4 ${record.type === 'in' ? 'border-red-500 bg-red-50' : 'border-gray-400 bg-gray-50'}`}></div>
                                        <div className="flex-1 pb-1">
                                            <div className="flex justify-between items-start">
                                                <div>
                                                    <div className={`font-bold text-sm ${record.type === 'in' ? 'text-gray-800' : 'text-gray-500'}`}>
                                                        {record.type === 'in' ? '上班打卡' : '下班簽退'}
                                                    </div>
                                                    <div className="text-xs text-gray-400 mt-0.5">
                                                        {new Date(record.timestamp.seconds * 1000).toLocaleDateString()}
                                                    </div>
                                                </div>
                                                <div className="text-sm font-mono font-medium text-gray-600 bg-gray-50 px-2 py-1 rounded-md">
                                                    {new Date(record.timestamp.seconds * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // 5. Manager Dashboard
        const ManagerDashboard = ({ currentUser, communities, allAttendance }) => {
            const communityLogs = allAttendance.filter(a => a.communityId === currentUser.communityId);
            const today = new Date().toLocaleDateString();

            return (
                <div className="space-y-4 pb-20">
                    <div className="grid grid-cols-2 gap-3">
                        <div className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                            <div className="text-gray-400 text-xs mb-1">今日打卡</div>
                            <div className="text-2xl font-bold text-gray-800">
                                {communityLogs.filter(l => new Date(l.timestamp?.seconds * 1000).toLocaleDateString() === today).length}
                                <span className="text-xs text-gray-400 font-normal ml-1">次</span>
                            </div>
                        </div>
                        <div className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                            <div className="text-gray-400 text-xs mb-1">目前在勤</div>
                            <div className="text-2xl font-bold text-red-600">
                                {communityLogs.filter(l => l.type === 'in' && new Date(l.timestamp?.seconds * 1000).toLocaleDateString() === today).length}
                                <span className="text-xs text-gray-400 font-normal ml-1">人</span>
                            </div>
                        </div>
                    </div>

                    <div className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                        <div className="p-4 border-b border-gray-50 bg-gray-50/50 flex justify-between items-center">
                            <h3 className="font-bold text-gray-700 text-sm">即時動態</h3>
                            <span className="text-[10px] px-2 py-1 bg-red-50 text-red-600 rounded-full font-bold">
                                {currentUser.communityName}
                            </span>
                        </div>
                        <div className="divide-y divide-gray-50">
                            {communityLogs.slice(0, 10).map(log => (
                                <div key={log.id} className="p-4 flex items-center justify-between hover:bg-gray-50 transition">
                                    <div className="flex items-center gap-3">
                                        <div className={`w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold text-white ${log.type === 'in' ? 'bg-red-500' : 'bg-gray-400'}`}>
                                            {log.userName.charAt(0)}
                                        </div>
                                        <div>
                                            <div className="text-sm font-bold text-gray-800">{log.userName}</div>
                                            <div className="text-xs text-gray-400">{log.userRole} · {log.type === 'in' ? '上班' : '下班'}</div>
                                        </div>
                                    </div>
                                    <div className="text-right">
                                        <div className="text-xs font-mono text-gray-600">
                                            {log.timestamp ? new Date(log.timestamp.seconds * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '--:--'}
                                        </div>
                                        {log.type === 'in' && <div className="flex items-center justify-end text-[10px] text-green-500 gap-0.5 mt-0.5"><CheckCircle className="w-2 h-2"/> 正常</div>}
                                    </div>
                                </div>
                            ))}
                            {communityLogs.length === 0 && (
                                <div className="p-8 text-center text-gray-400 text-sm">尚無今日資料</div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // 6. HR Dashboard
        const HRDashboard = ({ currentUser, communities, allAttendance }) => {
            return (
                <div className="space-y-4 pb-20">
                    <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                        <h2 className="text-lg font-bold text-gray-800 mb-4">人事管理中心</h2>
                        <div className="flex gap-2 mb-6 overflow-x-auto pb-2 no-scrollbar">
                            <button className="flex-shrink-0 flex items-center gap-2 px-4 py-2 bg-gray-50 text-gray-600 rounded-xl text-sm font-medium hover:bg-gray-100 transition border border-gray-200">
                                <FileText className="w-4 h-4" /> 月報表
                            </button>
                            <button className="flex-shrink-0 flex items-center gap-2 px-4 py-2 bg-gray-50 text-gray-600 rounded-xl text-sm font-medium hover:bg-gray-100 transition border border-gray-200">
                                <AlertCircle className="w-4 h-4" /> 異常檢視
                            </button>
                            <button className="flex-shrink-0 flex items-center gap-2 px-4 py-2 bg-gray-50 text-gray-600 rounded-xl text-sm font-medium hover:bg-gray-100 transition border border-gray-200">
                                <Calendar className="w-4 h-4" /> 請假審核
                            </button>
                        </div>

                        <div className="space-y-4">
                            <h3 className="text-sm font-bold text-gray-500 uppercase tracking-wider">各社區概況</h3>
                            {communities.map(c => (
                            <div key={c.id} className="flex items-center justify-between p-4 bg-gray-50 rounded-xl border border-gray-100">
                                <span className="text-sm font-bold text-gray-700">{c.name}</span>
                                <div className="flex gap-2 text-[10px] font-bold">
                                <span className="bg-white border border-gray-200 text-gray-600 px-2 py-1 rounded-md">正常 98%</span>
                                <span className="bg-red-50 text-red-600 px-2 py-1 rounded-md">異常 2%</span>
                                </div>
                            </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main App Component ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [dbUser, setDbUser] = useState(null);
            const [view, setView] = useState('login');
            const [loading, setLoading] = useState(true);
            const [communities, setCommunities] = useState([]);
            const [usersList, setUsersList] = useState([]);
            const [attendanceList, setAttendanceList] = useState([]);
            const [myAttendance, setMyAttendance] = useState([]);
            const [fetchError, setFetchError] = useState('');
            const [isOnline, setIsOnline] = useState(navigator.onLine);
            const [activeTab, setActiveTab] = useState('home');
            const [settingsSubtab, setSettingsSubtab] = useState('account');
            const [roles, setRoles] = useState([]);
            const [companies, setCompanies] = useState([]);
            const [areas, setAreas] = useState([]);
            const [dateTime, setDateTime] = useState(() => {
                const d = new Date();
                const pad = (n) => String(n).padStart(2, '0');
                return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}    ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
            });
            const availablePages = [
                { key: 'home', label: '首頁' },
                { key: 'overview', label: '總覽' },
                { key: 'clock', label: '打卡' },
                { key: 'community', label: '社區' },
                { key: 'hr', label: '人事' },
                { key: 'settings', label: '設定' }
            ];
            
            const switchTab = (tab) => {
                setActiveTab(tab);
                if (tab === 'settings') {
                    setSettingsSubtab('general');
                }
            };

            useEffect(() => {
                let mounted = true;
                const timer = setTimeout(() => {
                    if (mounted) setLoading(false);
                }, 3000);
                const t = setInterval(() => {
                    const d = new Date();
                    const pad = (n) => String(n).padStart(2, '0');
                    setDateTime(`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}    ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`);
                }, 1000);
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        }
                    } catch (e) {
                        console.error("Auth init error", e);
                    }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    setLoading(false);
                    clearTimeout(timer);
                    if (u) {
                        let restored = null;
                        try {
                            const until = parseInt(localStorage.getItem('remember_until') || '0', 10);
                            const stored = localStorage.getItem('remember_user');
                            if (until && until > Date.now() && stored) {
                                restored = JSON.parse(stored);
                            }
                        } catch {}
                        if (restored) {
                            setDbUser(restored);
                            setView('dashboard');
                        } else {
                            (async () => {
                                try {
                                    const q = query(
                                        collection(db, 'artifacts', appId, 'public', 'data', 'users'),
                                        where('email', '==', u.email || '')
                                    );
                                    const snap = await getDocs(q);
                                    if (!snap.empty) {
                                        const data = { id: snap.docs[0].id, ...snap.docs[0].data() };
                                        const comm = communities.find(c => c.id === data.communityId);
                                        data.communityName = comm ? comm.name : (data.communityId === 'SYSTEM' ? '總部系統' : '未分配');
                                        setDbUser(data);
                                        setView('dashboard');
                                    } else {
                                        setView('dashboard');
                                    }
                                } catch {}
                            })();
                        }
                    } else {
                        setDbUser(null);
                        setView('login');
                    }
                });
                const onlineHandler = () => setIsOnline(true);
                const offlineHandler = () => setIsOnline(false);
                window.addEventListener('online', onlineHandler);
                window.addEventListener('offline', offlineHandler);
                return () => {
                    mounted = false;
                    unsubscribe();
                    clearTimeout(timer);
                    clearInterval(t);
                    window.removeEventListener('online', onlineHandler);
                    window.removeEventListener('offline', offlineHandler);
                };
            }, []);

            useEffect(() => {
                if (!user) return;
                const ref = collection(db, 'artifacts', appId, 'public', 'data', 'communities');
                let stopped = false;
                const fetch = async () => {
                    try {
                        const snap = await getDocs(ref);
                        if (stopped) return;
                        setCommunities(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                    } catch (err) {
                        setFetchError('資料讀取權限不足，請更新 Firestore 規則');
                        console.error(err);
                    }
                };
                fetch();
                const i = setInterval(fetch, 5000);
                return () => { stopped = true; clearInterval(i); };
            }, [user]);

            useEffect(() => {
                if (!user || !dbUser) return;
                let stopUsers = false;
                let stopAttendance = false;
                let stopMyAttendance = false;

                if (dbUser && activeTab === 'settings' && settingsSubtab === 'account') {
                    const ref = collection(db, 'artifacts', appId, 'public', 'data', 'users');
                    const fetch = async () => {
                        try {
                            const snap = await getDocs(ref);
                            if (stopUsers) return;
                            setUsersList(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                        } catch (err) {
                            setFetchError('資料讀取權限不足，請更新 Firestore 規則');
                            console.error(err);
                        }
                    };
                    fetch();
                    var usersInterval = setInterval(fetch, 5000);
                }

                if (dbUser && activeTab === 'settings' && settingsSubtab === 'general') {
                    const refRoles = collection(db, 'artifacts', appId, 'public', 'data', 'roles');
                    const refCompanies = collection(db, 'artifacts', appId, 'public', 'data', 'companies');
                    const refAreas = collection(db, 'artifacts', appId, 'public', 'data', 'areas');
                    const refUsers = collection(db, 'artifacts', appId, 'public', 'data', 'users');
                    const fetchRoles = async () => {
                        try {
                            const snap = await getDocs(refRoles);
                            if (stopUsers) return;
                            setRoles(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                        } catch (err) { console.error(err); }
                    };
                    const fetchCompanies = async () => {
                        try {
                            const snap = await getDocs(refCompanies);
                            if (stopAttendance) return;
                            setCompanies(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                        } catch (err) { console.error(err); }
                    };
                    const fetchAreas = async () => {
                        try {
                            const snap = await getDocs(refAreas);
                            if (stopMyAttendance) return;
                            setAreas(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                        } catch (err) { console.error(err); }
                    };
                    const fetchUsersForCounts = async () => {
                        try {
                            const snap = await getDocs(refUsers);
                            if (stopUsers) return;
                            setUsersList(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                        } catch (err) { console.error(err); }
                    };
                    fetchRoles(); fetchCompanies(); fetchAreas(); fetchUsersForCounts();
                    var rolesInterval = setInterval(fetchRoles, 5000);
                    var companiesInterval = setInterval(fetchCompanies, 5000);
                    var areasInterval = setInterval(fetchAreas, 5000);
                    var usersForCountsInterval = setInterval(fetchUsersForCounts, 5000);
                }

                if (['admin', 'manager', 'hr'].includes(dbUser.role)) {
                    const qAll = query(collection(db, 'artifacts', appId, 'public', 'data', 'attendance'), orderBy('timestamp', 'desc'));
                    const fetchAll = async () => {
                        try {
                            const snap = await getDocs(qAll);
                            if (stopAttendance) return;
                            setAttendanceList(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                        } catch (err) {
                            setFetchError('資料讀取權限不足，請更新 Firestore 規則');
                            console.error(err);
                        }
                    };
                    fetchAll();
                    var attendanceInterval = setInterval(fetchAll, 5000);
                }

                if ((dbUser.role === 'staff' || dbUser.role === 'manager') && activeTab === 'home') {
                    const qMine = query(
                        collection(db, 'artifacts', appId, 'public', 'data', 'attendance'), 
                        where('userId', '==', dbUser.id),
                        orderBy('timestamp', 'desc')
                    );
                    const fetchMine = async () => {
                        try {
                            const snap = await getDocs(qMine);
                            if (stopMyAttendance) return;
                            setMyAttendance(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                        } catch (err) {
                            setFetchError('資料讀取權限不足，請更新 Firestore 規則');
                            console.error(err);
                        }
                    };
                    fetchMine();
                    var myInterval = setInterval(fetchMine, 5000);
                }

                return () => {
                    stopUsers = true; stopAttendance = true; stopMyAttendance = true;
                    if (usersInterval) clearInterval(usersInterval);
                    if (attendanceInterval) clearInterval(attendanceInterval);
                    if (myInterval) clearInterval(myInterval);
                    if (rolesInterval) clearInterval(rolesInterval);
                    if (companiesInterval) clearInterval(companiesInterval);
                    if (areasInterval) clearInterval(areasInterval);
                    if (usersForCountsInterval) clearInterval(usersForCountsInterval);
                };
            }, [user, dbUser, activeTab, settingsSubtab]);

            

            const seedData = async () => {
                if (!user) return;
                const baseCommRef = collection(db, 'artifacts', appId, 'public', 'data', 'communities');
                const baseUserRef = collection(db, 'artifacts', appId, 'public', 'data', 'users');
                const comm1 = await addDoc(baseCommRef, { name: '帝寶社區', address: '台北市仁愛路' });
                const comm2 = await addDoc(baseCommRef, { name: '信義之星', address: '台北市信義區' });
                await addDoc(baseUserRef, { name: '系統管理員', email: 'admin@sys.com', password: '123', role: 'admin', communityId: 'SYSTEM' });
                await addDoc(baseUserRef, { name: '李經理', email: 'manager@comm.com', password: '123', role: 'manager', communityId: comm1.id });
                await addDoc(baseUserRef, { name: '陳人事', email: 'hr@comm.com', password: '123', role: 'hr', communityId: 'HQ' });
                await addDoc(baseUserRef, { name: '王保全', email: 'staff@comm.com', password: '123', role: 'staff', communityId: comm1.id });
            };

            const signInWithRetry = async (email, password) => {
                let i = 0;
                const delays = [500, 1000, 2000];
                while (true) {
                    try {
                        return await signInWithEmailAndPassword(auth, email, password);
                    } catch (e) {
                        if (e && e.code === 'auth/network-request-failed' && i < delays.length) {
                            await new Promise(r => setTimeout(r, delays[i++]));
                            continue;
                        }
                        throw e;
                    }
                }
            };

            const registerWithRetry = async (email, password) => {
                let i = 0;
                const delays = [500, 1000, 2000];
                while (true) {
                    try {
                        return await createUserWithEmailAndPassword(auth, email, password);
                    } catch (e) {
                        if (e && e.code === 'auth/network-request-failed' && i < delays.length) {
                            await new Promise(r => setTimeout(r, delays[i++]));
                            continue;
                        }
                        throw e;
                    }
                }
            };

            const handleLogin = async (email, password, rememberMe = false) => {
                setLoading(true);
                try {
                    await signInWithRetry(email, password);
                    const q = query(
                        collection(db, 'artifacts', appId, 'public', 'data', 'users'), 
                        where('email', '==', email)
                    );
                    const snap = await getDocs(q);
                    let userData;
                    if (!snap.empty) {
                        userData = { id: snap.docs[0].id, ...snap.docs[0].data() };
                    } else {
                        const baseUserRef = collection(db, 'artifacts', appId, 'public', 'data', 'users');
                        const name = email.split('@')[0];
                        const defaultRole = email === 'admin@sys.com' ? 'admin' : 'staff';
                        const defaultCommunity = defaultRole === 'admin' ? 'SYSTEM' : 'HQ';
                        const docRef = await addDoc(baseUserRef, { name, email, role: defaultRole, communityId: defaultCommunity });
                        userData = { id: docRef.id, name, email, role: defaultRole, communityId: defaultCommunity };
                    }
                    const comm = communities.find(c => c.id === userData.communityId);
                    userData.communityName = comm ? comm.name : (userData.communityId === 'SYSTEM' ? '總部系統' : '未分配');
                    setDbUser(userData);
                    setView('dashboard');
                    if (rememberMe) {
                        try {
                            localStorage.setItem('remember_until', String(Date.now() + 48 * 60 * 60 * 1000));
                            localStorage.setItem('remember_user', JSON.stringify(userData));
                        } catch {}
                    }
                } catch (e) {
                    console.error(e);
                    throw e;
                } finally {
                    setLoading(false);
                }
            };

            const handleRegister = async (email, password, rememberMe = false) => {
                setLoading(true);
                try {
                    await registerWithRetry(email, password);
                    const baseUserRef = collection(db, 'artifacts', appId, 'public', 'data', 'users');
                    const name = email.split('@')[0];
                    const defaultRole = email === 'admin@sys.com' ? 'admin' : 'staff';
                    const defaultCommunity = defaultRole === 'admin' ? 'SYSTEM' : 'HQ';
                    const docRef = await addDoc(baseUserRef, { name, email, role: defaultRole, communityId: defaultCommunity });
                    const userData = { id: docRef.id, name, email, role: defaultRole, communityId: defaultCommunity };
                    const comm = communities.find(c => c.id === userData.communityId);
                    userData.communityName = comm ? comm.name : (userData.communityId === 'SYSTEM' ? '總部系統' : '未分配');
                    setDbUser(userData);
                    setView('dashboard');
                    if (rememberMe) {
                        try {
                            localStorage.setItem('remember_until', String(Date.now() + 48 * 60 * 60 * 1000));
                            localStorage.setItem('remember_user', JSON.stringify(userData));
                        } catch {}
                    }
                } catch (e) {
                    console.error(e);
                    throw e;
                } finally {
                    setLoading(false);
                }
            };

            

            const handleLogout = async () => {
                await signOut(auth);
                setDbUser(null);
                setView('login');
                try {
                    localStorage.removeItem('remember_until');
                    localStorage.removeItem('remember_user');
                } catch {}
            };

            const handleClockIn = async (type) => {
                if (!user || !dbUser) return;
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'attendance'), {
                        userId: dbUser.id,
                        userName: dbUser.name,
                        userRole: dbUser.role,
                        communityId: dbUser.communityId,
                        type: type,
                        timestamp: serverTimestamp(),
                        device: 'Web Browser',
                        location: '25.0330, 121.5654'
                    });
                } catch (e) {
                    console.error("Clock error", e);
                    alert("打卡失敗，請重試");
                }
            };

            const handleAddUser = async (userData) => {
                if (!user) return;
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'users'), { ...userData, password: '123', updatedByName: (dbUser && dbUser.name) || (user && user.email) || '', updatedAt: serverTimestamp() });
            };

            const handleAddCommunity = async (name) => {
                if (!user) return;
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'communities'), { name: name, updatedByName: (dbUser && dbUser.name) || (user && user.email) || '', updatedAt: serverTimestamp() });
            };

            if (loading) return <Loading />;

            if (view === 'login') {
                return <Login onLogin={handleLogin} onRegister={handleRegister} isOnline={isOnline} />;
            }

            return (
                <div className="min-h-screen bg-gray-100 flex flex-col font-sans">
                    {/* Mobile Navbar */}
                    <header className="bg-white fixed top-0 left-0 right-0 z-50 border-b border-gray-100 h-[8vh]">
                        <div className="max-w-md mx-auto px-4 h-full flex justify-between items-center">
                            <div className="flex items-center gap-2">
                                <div className="bg-red-600 p-1.5 rounded-lg">
                                    <Clock className="w-4 h-4 text-white" />
                                </div>
                                <span className="font-bold text-gray-800 tracking-tight">西北打卡系統</span>
                            </div>
                            
                            <div className="flex items-center gap-3">
                                <div className="text-right hidden sm:block">
                                    <div className="text-xs font-bold text-gray-800">{dbUser?.name}</div>
                                </div>
                                <button 
                                    onClick={handleLogout}
                                    className="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-full transition"
                                >
                                    <LogOut className="w-5 h-5" />
                                </button>
                            </div>
                        </div>
                        {fetchError && (
                            <div className="bg-yellow-50 border-t border-yellow-200 text-yellow-800 text-xs px-4 py-2">
                                {fetchError}
                            </div>
                        )}
                    </header>

                    <div className="fixed top-[8vh] left-0 right-0 z-40 h-[8vh] bg-white border-b border-gray-100">
                        <div className="max-w-md mx-auto px-4 h-full flex items-center gap-2 overflow-x-auto no-scrollbar">
                            {activeTab === 'home' && (
                                <div className="w-full flex justify-center">
                                    <div className="text-xl font-bold text-black">{dateTime}</div>
                                </div>
                            )}
                            {activeTab === 'overview' && (
                                <div className="w-full flex justify-center">
                                    <div className="text-xl font-bold text-black">{dateTime}</div>
                                </div>
                            )}
                            {activeTab === 'clock' && (
                                <div className="flex gap-2">
                                    <button className="px-3 py-2 text-xs font-bold rounded-lg bg-red-50 text-red-600">紀錄</button>
                                    <button className="px-3 py-2 text-xs font-bold rounded-lg bg-red-50 text-red-600">請假</button>
                                    <button className="px-3 py-2 text-xs font-bold rounded-lg bg-red-50 text-red-600">扣點</button>
                                </div>
                            )}
                            {activeTab === 'community' && (
                                <button className="px-3 py-2 text-xs font-bold rounded-lg bg-red-50 text-red-600">全部</button>
                            )}
                            {activeTab === 'hr' && (
                                <button className="px-3 py-2 text-xs font-bold rounded-lg bg-red-50 text-red-600">報表</button>
                            )}
                            {activeTab === 'settings' && (
                                <div className="flex gap-2">
                                    <button onClick={() => setSettingsSubtab('general')} className={`px-3 py-2 text-xs font-bold rounded-lg ${settingsSubtab === 'general' ? 'bg-red-50 text-red-600' : 'bg-gray-50 text-gray-700'}`}>一般</button>
                                    <button onClick={() => setSettingsSubtab('account')} className={`px-3 py-2 text-xs font-bold rounded-lg ${settingsSubtab === 'account' ? 'bg-red-50 text-red-600' : 'bg-gray-50 text-gray-700'}`}>帳號</button>
                                    <button onClick={() => setSettingsSubtab('community')} className={`px-3 py-2 text-xs font-bold rounded-lg ${settingsSubtab === 'community' ? 'bg-red-50 text-red-600' : 'bg-gray-50 text-gray-700'}`}>社區</button>
                                    <button onClick={() => setSettingsSubtab('system')} className={`px-3 py-2 text-xs font-bold rounded-lg ${settingsSubtab === 'system' ? 'bg-red-50 text-red-600' : 'bg-gray-50 text-gray-700'}`}>系統</button>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Main Content Area - Mobile Container */}
                    <main className="absolute top-[16vh] left-0 right-0 h-[76vh] overflow-y-auto">
                        <div className="w-full max-w-md mx-auto px-4 py-4">
                        
                        {/* Role Based Views */}
                        {dbUser?.role === 'staff' && activeTab === 'home' && (
                            <StaffDashboard 
                                currentUser={dbUser} 
                                onClockIn={handleClockIn} 
                                attendanceHistory={myAttendance}
                            />
                        )}

                        {dbUser?.role === 'manager' && (
                            <div className="space-y-6">
                                <div className="flex items-center justify-between">
                                    <h2 className="text-lg font-bold text-gray-800 flex items-center gap-2">
                                        <Briefcase className="w-5 h-5 text-red-600" />
                                        管理概覽
                                    </h2>
                                    <span className="text-xs text-gray-400 bg-white px-2 py-1 rounded border">經理權限</span>
                                </div>
                                
                                {activeTab === 'home' && (
                                    <div className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                                        <h3 className="text-xs font-bold text-gray-400 uppercase mb-3">個人勤務</h3>
                                        <StaffDashboard 
                                            currentUser={dbUser} 
                                            onClockIn={handleClockIn} 
                                            attendanceHistory={myAttendance}
                                        />
                                    </div>
                                )}

                                <div className="pt-4 border-t border-gray-200">
                                    <h3 className="text-xs font-bold text-gray-400 uppercase mb-3">團隊動態</h3>
                                    <ManagerDashboard 
                                        currentUser={dbUser} 
                                        communities={communities} 
                                        allAttendance={attendanceList}
                                    />
                                </div>
                            </div>
                        )}

                        {dbUser?.role === 'hr' && (
                            <div className="space-y-6">
                                <div className="flex items-center gap-2 text-lg font-bold text-gray-800">
                                    <LayoutDashboard className="w-5 h-5 text-red-600" /> 人事管理中心
                                </div>
                                <HRDashboard 
                                    currentUser={dbUser} 
                                    communities={communities} 
                                    allAttendance={attendanceList}
                                />
                            </div>
                        )}

                        {dbUser && activeTab === 'settings' && (
                            <div className="space-y-6">
                                <div className="flex items-center gap-2 text-lg font-bold text-gray-800">
                                    <Shield className="w-5 h-5 text-red-600" /> 系統設定
                                </div>
                                <AdminDashboard 
                                    currentUser={dbUser} 
                                    users={usersList} 
                                    communities={communities}
                                    roles={roles}
                                    companies={companies}
                                    areas={areas}
                                    pages={availablePages}
                                    onAddUser={handleAddUser}
                                    onAddCommunity={handleAddCommunity}
                                    subtab={settingsSubtab}
                                />
                            </div>
                        )}
                        </div>
                    </main>

                    <div className="fixed bottom-0 left-0 right-0 z-50 h-[8vh] bg-white border-t border-gray-100">
                        <div className="max-w-md mx-auto h-full px-4 flex items-center justify-between">
                            <button onClick={() => switchTab('home')} className={`flex flex-col items-center font-bold text-xs ${activeTab === 'home' ? 'text-red-600' : 'text-gray-600'}`}>
                                <Home className="w-5 h-5 mb-1" /> 首頁
                            </button>
                            <button onClick={() => switchTab('overview')} className={`flex flex-col items-center font-bold text-xs ${activeTab === 'overview' ? 'text-red-600' : 'text-gray-600'}`}>
                                <BarChart3 className="w-5 h-5 mb-1" /> 總覽
                            </button>
                            <button onClick={() => switchTab('clock')} className={`flex flex-col items-center font-bold text-xs ${activeTab === 'clock' ? 'text-red-600' : 'text-gray-600'}`}>
                                <ClipboardList className="w-5 h-5 mb-1" /> 打卡
                            </button>
                            <button onClick={() => switchTab('community')} className={`flex flex-col items-center font-bold text-xs ${activeTab === 'community' ? 'text-red-600' : 'text-gray-600'}`}>
                                <Building2 className="w-5 h-5 mb-1" /> 社區
                            </button>
                            <button onClick={() => switchTab('hr')} className={`flex flex-col items-center font-bold text-xs ${activeTab === 'hr' ? 'text-red-600' : 'text-gray-600'}`}>
                                <FileText className="w-5 h-5 mb-1" /> 人事
                            </button>
                            <button onClick={() => switchTab('settings')} className={`flex flex-col items-center font-bold text-xs ${activeTab === 'settings' ? 'text-red-600' : 'text-gray-600'}`}>
                                <Settings className="w-5 h-5 mb-1" /> 設定
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
