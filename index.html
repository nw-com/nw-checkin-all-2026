<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>西北打卡系統</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 24 24'%3E%3Crect width='24' height='24' rx='6' fill='%23dc2626'/%3E%3Cg transform='translate(12,12) scale(0.6) translate(-12,-12)'%3E%3Ccircle cx='12' cy='12' r='10' stroke='white' stroke-width='2.5' fill='none'/%3E%3Cpolyline points='12 6 12 12 16 14' stroke='white' stroke-width='2.5' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/g%3E%3C/svg%3E" />
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- SheetJS for Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <!-- Import Map for Modules -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js",
        "firebase/storage": "https://www.gstatic.com/firebasejs/10.14.1/firebase-storage.js",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0"
      }
    }
    </script>

    <style>
        /* Font Unification: Traditional Chinese */
        body {
            font-family: "Microsoft JhengHei", "PingFang TC", "Heiti TC", "Apple LiGothic Medium", "PMingLiU", sans-serif !important;
        }

        /* Mobile optimization */
        body {
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
    <script src="./firebase-config.js"></script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAzhLdWtycJgfz8UsXWlji63DkXpA4kmyY&loading=async"></script>
</head>
<body class="bg-gray-100 text-gray-900 font-sans antialiased">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useMemo } from 'react';
        import ReactDOM from 'react-dom/client';
        import { initializeApp, setLogLevel, deleteApp } from 'firebase/app';
        import { 
            getAuth,
            onAuthStateChanged,
            signInWithCustomToken,
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            signOut,
            sendPasswordResetEmail,
            updatePassword
        } from 'firebase/auth';
        import { 
            getFirestore, 
            initializeFirestore,
            collection, 
            addDoc, 
            query, 
            where, 
            orderBy, 
            serverTimestamp,
            getDocs,
            updateDoc,
            setDoc,
            deleteDoc,
            doc,
            onSnapshot
        } from 'firebase/firestore';
        import {
            getStorage,
            ref as storageRef,
            uploadBytes,
            getDownloadURL
        } from 'firebase/storage';
        import { 
            Clock, 
            LogOut, 
            Shield, 
            Users, 
            FileText, 
            Briefcase, 
            AlertCircle, 
            CheckCircle, 
            MapPin, 
            Calendar, 
            LayoutDashboard,
            Building,
            Building2,
            Eye,
            EyeOff,
            Home,
            BarChart3,
            ClipboardList,
            Settings,
            X,
            Edit,
            Camera,
            RefreshCw,
            ChevronLeft,
            ChevronRight,
            ChevronUp,
            ChevronDown,
            Check
        } from 'lucide-react';

        // --- Firebase Configuration ---
        // 如果您在本地打開此檔案，請在此處填入您的 Firebase Config
        const manualConfig = null; 
        
        // 嘗試從環境變數或手動設定中獲取配置
        const getFirebaseConfig = () => {
            if (manualConfig) return manualConfig;
            if (typeof window !== 'undefined' && window.FIREBASE_CONFIG) {
                return window.FIREBASE_CONFIG;
            }
            if (typeof __firebase_config !== 'undefined') {
                try {
                    return JSON.parse(__firebase_config);
                } catch (e) {
                    return {};
                }
            }
            return {};
        };

        const firebaseConfig = getFirebaseConfig();
        setLogLevel('silent');
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = initializeFirestore(app, {
            ignoreUndefinedProperties: true
        });
        const storage = getStorage(app);
        
        // App ID logic for compatibility
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-attendance-app';

        // --- Components ---

        // 1. Loading Spinner (Red Theme)
        const Loading = () => (
            <div className="min-h-screen flex items-center justify-center bg-gray-50">
                <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-red-600"></div>
            </div>
        );

        // 1.2 Company Map Preview Component
        const CompanyMapPreview = ({ lat, lng, radius, avatarUrl, users, externalSelectedUserId, onUserSelect }) => {
            const mapRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const circleRef = useRef(null);
            const markerRef = useRef(null);
            const markersRef = useRef([]);
            const [showResetBtn, setShowResetBtn] = useState(false);
            const [selectedUser, setSelectedUser] = useState(null);

            // Handle external selection changes
            useEffect(() => {
                if (externalSelectedUserId && users) {
                    const target = users.find(u => u.id === externalSelectedUserId);
                    if (target) {
                        if (mapInstanceRef.current && target.lat && target.lng) {
                             const uLoc = { lat: parseFloat(target.lat), lng: parseFloat(target.lng) };
                             mapInstanceRef.current.panTo(uLoc);
                             mapInstanceRef.current.setZoom(19);
                             setShowResetBtn(true);
                             setSelectedUser(target);
                        }
                    }
                }
            }, [externalSelectedUserId, users]);

            // Reset state when location changes (e.g. switching companies)
            useEffect(() => {
                setShowResetBtn(false);
                setSelectedUser(null);
                if (onUserSelect) onUserSelect(null);
            }, [lat, lng]);

            const handleResetCenter = () => {
                if (mapInstanceRef.current && lat && lng) {
                    const center = { lat: parseFloat(lat), lng: parseFloat(lng) };
                    mapInstanceRef.current.panTo(center);
                    mapInstanceRef.current.setZoom(17);
                    setShowResetBtn(false);
                    setSelectedUser(null);
                    if (onUserSelect) onUserSelect(null);
                }
            };

            const createCircularIcon = async (url) => {
                return new Promise((resolve) => {
                    const size = 40;
                    const canvas = document.createElement('canvas');
                    canvas.width = size;
                    canvas.height = size;
                    const ctx = canvas.getContext('2d');
                    
                    const img = new Image();
                    img.crossOrigin = "Anonymous";
                    img.src = url;
                    
                    img.onload = () => {
                        // Draw white circle background (border)
                        ctx.beginPath();
                        ctx.arc(size/2, size/2, size/2, 0, Math.PI * 2);
                        ctx.fillStyle = 'white';
                        ctx.fill();

                        // Clip for image
                        ctx.beginPath();
                        ctx.arc(size/2, size/2, (size/2) - 2, 0, Math.PI * 2); // 2px border
                        ctx.save(); 
                        ctx.clip();
                        
                        // Draw image
                        ctx.drawImage(img, 0, 0, size, size);
                        ctx.restore(); 

                        resolve({
                            url: canvas.toDataURL(),
                            scaledSize: new google.maps.Size(size, size),
                            anchor: new google.maps.Point(size/2, size/2),
                        });
                    };

                    img.onerror = () => {
                        resolve(null);
                    };
                });
            };

            useEffect(() => {
                if (!lat || !lng || !window.google || !window.google.maps || !mapRef.current) return;

                const location = { lat: parseFloat(lat), lng: parseFloat(lng) };
                const r = parseFloat(radius) || 100;

                const initMap = async () => {
                    // Clear previous multiple markers
                    markersRef.current.forEach(m => m.setMap(null));
                    markersRef.current = [];

                    if (!mapInstanceRef.current) {
                        // Init Map
                        mapInstanceRef.current = new google.maps.Map(mapRef.current, {
                            center: location,
                            zoom: 17,
                            disableDefaultUI: true,
                            zoomControl: true,
                            gestureHandling: 'greedy' // Allow single finger pan
                        });
                        
                        mapInstanceRef.current.addListener('dragend', () => {
                            setShowResetBtn(true);
                        });

                        mapInstanceRef.current.addListener('zoomend', () => {
                            setShowResetBtn(true);
                        });
                        
                        // Close info window on map click
                        mapInstanceRef.current.addListener('click', () => {
                            setSelectedUser(null);
                        });

                        // Init Circle
                        circleRef.current = new google.maps.Circle({
                            strokeColor: "#EF4444",
                            strokeOpacity: 0.8,
                            strokeWeight: 2,
                            fillColor: "#EF4444",
                            fillOpacity: 0.15,
                            map: mapInstanceRef.current,
                            center: location,
                            radius: r
                        });
                        
                        // Add center marker
                         if (markerRef.current) markerRef.current.setMap(null);
                         markerRef.current = new google.maps.Marker({
                             position: location,
                             map: mapInstanceRef.current,
                             icon: {
                                  path: google.maps.SymbolPath.CIRCLE,
                                  scale: 6,
                                  fillColor: "#EF4444",
                                  fillOpacity: 1,
                                  strokeColor: "white",
                                  strokeWeight: 2,
                             },
                             title: "公司中心"
                         });
                    } else {
                        // Update Circle
                        if (circleRef.current) {
                            circleRef.current.setCenter(location);
                            circleRef.current.setRadius(r);
                        }
                        // Update Center Marker
                        if (markerRef.current) {
                            markerRef.current.setPosition(location);
                            if (!users || users.length === 0) {
                                markerRef.current.setMap(mapInstanceRef.current);
                            } else {
                                // In multi-user mode, we still show company center marker but with simple style
                                 markerRef.current.setMap(mapInstanceRef.current);
                            }
                        }
                    }

                    // Handle Users
                    if (users && users.length > 0) {
                        const newMarkers = [];
                        for (const u of users) {
                             if (u.lat && u.lng) {
                                 const uLoc = { lat: parseFloat(u.lat), lng: parseFloat(u.lng) };
                                 let icon = null;
                                 if (u.avatarUrl) icon = await createCircularIcon(u.avatarUrl);
                                 
                                 const m = new google.maps.Marker({
                                     position: uLoc,
                                     map: mapInstanceRef.current,
                                     icon: icon,
                                     title: u.name,
                                     zIndex: 100 // Ensure users are on top
                                 });
                                 
                                 // Add click listener for marker
                                m.addListener('click', () => {
                                    mapInstanceRef.current.panTo(uLoc);
                                    mapInstanceRef.current.setZoom(19); 
                                    setShowResetBtn(true);
                                    setSelectedUser(u);
                                    if (onUserSelect) onUserSelect(u);
                                });
                                 
                                 newMarkers.push(m);
                             }
                        }
                        markersRef.current = newMarkers;
                    }
                    
                    // Force center on company location ONLY if NOT manually moved/zoomed (reset button hidden)
                    // AND no user is currently selected externally
                    if (!showResetBtn && !selectedUser && !externalSelectedUserId) {
                        mapInstanceRef.current.setCenter(location);
                        mapInstanceRef.current.setZoom(17);
                    }
                };
                
                initMap();
            }, [lat, lng, radius, avatarUrl, users, showResetBtn, selectedUser, externalSelectedUserId]);

            return (
                <div className="w-full h-full relative">
                    <div ref={mapRef} className="w-full h-full"></div>
                    {showResetBtn && (
                        <button 
                            onClick={handleResetCenter}
                            className="absolute top-2 right-2 bg-white text-red-600 px-3 py-1.5 rounded-xl shadow-md text-xs font-bold flex items-center gap-1 hover:bg-gray-50 transition-all z-10"
                        >
                            <MapPin className="w-3 h-3" /> 回到公司
                        </button>
                    )}
                    

                    {selectedUser && (
                        <div className="absolute bottom-4 left-4 right-4 bg-white/95 backdrop-blur-sm p-3 rounded-2xl shadow-lg border border-gray-100 z-10 animate-fade-in-up">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 rounded-full bg-gray-200 overflow-hidden flex-shrink-0 border border-gray-100">
                                    {selectedUser.avatarUrl ? (
                                        <img src={selectedUser.avatarUrl} alt={selectedUser.name} className="w-full h-full object-cover" />
                                    ) : (
                                        <div className="w-full h-full flex items-center justify-center font-bold text-gray-500 text-xs">
                                            {selectedUser.name?.[0]}
                                        </div>
                                    )}
                                </div>
                                <div className="flex-1 min-w-0">
                                    <div className="font-bold text-gray-800 text-sm truncate">{selectedUser.name}</div>
                                    <div className="text-xs text-gray-500 truncate flex items-center gap-1">
                                        <MapPin className="w-3 h-3" />
                                        {selectedUser.locationName || '座標定位'}
                                    </div>
                                    <div className="text-[10px] text-gray-400 mt-0.5">
                                        {selectedUser.time ? new Date(selectedUser.time).toLocaleString('zh-TW') : '剛剛'}
                                    </div>
                                </div>
                                <button 
                            onClick={() => {
                                setSelectedUser(null);
                                if (onUserSelect) onUserSelect(null);
                            }}
                            className="p-2 text-gray-400 hover:text-gray-600 rounded-full hover:bg-gray-100"
                        >
                                    <X className="w-4 h-4" />
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // Error Boundary Component
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true, error };
            }

            componentDidCatch(error, errorInfo) {
                console.error("ErrorBoundary caught an error", error, errorInfo);
            }

            render() {
                if (this.state.hasError) {
                    return (
                        <div className="p-6 bg-red-50 border border-red-200 rounded-2xl text-red-700 text-center m-4">
                            <h2 className="font-bold text-lg mb-2">頁面發生錯誤</h2>
                            <p className="text-sm mb-4">很抱歉，系統遇到預期外的錯誤。</p>
                            <pre className="text-xs bg-white p-3 rounded-xl overflow-auto text-left mx-auto max-w-lg shadow-inner">
                                {this.state.error && this.state.error.toString()}
                            </pre>
                            <button 
                                onClick={() => window.location.reload()}
                                className="mt-4 px-4 py-2 bg-red-600 text-white rounded-xl text-sm font-bold shadow-lg shadow-red-200 hover:bg-red-700 transition"
                            >
                                重新整理頁面
                            </button>
                        </div>
                    );
                }
                return this.props.children; 
            }
        }

        // 1. Camera Modal
        const CameraModal = ({ isOpen, onClose, onConfirm, type, userName, userAvatar, workSite, checkInLocationName, availableLocations = [], checkInLocation, setCheckInLocation }) => {
            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            const mapRef = useRef(null);
            const workSiteCircleRef = useRef(null);
            const [stream, setStream] = useState(null);
            const [image, setImage] = useState(null);
            const [location, setLocation] = useState(null);
            const [address, setAddress] = useState('定位中...');
            const [error, setError] = useState('');
            const [step, setStep] = useState('location'); // location, camera, preview
            const [isProcessing, setIsProcessing] = useState(false);
            const [showLocationList, setShowLocationList] = useState(false);

            useEffect(() => {
                if (isOpen) {
                    setStep('location');
                    startLocation();
                } else {
                    stopCamera();
                    setImage(null);
                    setStep('location');
                    setLocation(null);
                    setAddress('定位中...');
                    setError('');
                    if (workSiteCircleRef.current) {
                        workSiteCircleRef.current.setMap(null);
                        workSiteCircleRef.current = null;
                    }
                }
            }, [isOpen]);

            // Initialize Map when location is found and step is 'location'
            useEffect(() => {
                try {
                    if (step === 'location' && location && mapRef.current && window.google && window.google.maps) {
                        // Calculate Target Location (prioritize checkInLocation over workSite)
                        let targetLocation = null;
                        let targetName = "服務單位";
                        const target = checkInLocation || workSite;

                        if (target) {
                            if (target.lat && target.lng) {
                                targetLocation = { lat: parseFloat(target.lat), lng: parseFloat(target.lng) };
                            } else if (target.location) {
                                const locStr = String(target.location);
                                const parts = locStr.split(',');
                                if (parts.length === 2) {
                                    const lat = parseFloat(parts[0].trim());
                                    const lng = parseFloat(parts[1].trim());
                                    if (!isNaN(lat) && !isNaN(lng)) {
                                        targetLocation = { lat, lng };
                                    }
                                }
                            }
                            targetName = target.name || "服務單位";
                        }

                        // Center on Target Location if available, otherwise User Location
                        const mapCenter = targetLocation || location;

                        const map = new google.maps.Map(mapRef.current, {
                            center: mapCenter,
                            zoom: 17,
                            disableDefaultUI: true,
                            zoomControl: true,
                        });

                        // User Marker
                        const createDefaultMarker = () => {
                            new google.maps.Marker({
                                position: location,
                                map: map,
                                title: "目前位置",
                                icon: {
                                    path: google.maps.SymbolPath.CIRCLE,
                                    scale: 7,
                                    fillColor: "#4285F4",
                                    fillOpacity: 1,
                                    strokeColor: "white",
                                    strokeWeight: 2,
                                },
                                zIndex: 1000
                            });
                        };

                        if (userAvatar) {
                            const img = new Image();
                            img.crossOrigin = "Anonymous";
                            img.src = userAvatar;
                            img.onload = () => {
                                try {
                                    const canvas = document.createElement('canvas');
                                    canvas.width = 80;
                                    canvas.height = 80;
                                    const ctx = canvas.getContext('2d');

                                    // White background/border
                                    ctx.beginPath();
                                    ctx.arc(40, 40, 40, 0, Math.PI * 2, true);
                                    ctx.fillStyle = '#ffffff';
                                    ctx.fill();

                                    // Clip for image
                                    ctx.save();
                                    ctx.beginPath();
                                    ctx.arc(40, 40, 36, 0, Math.PI * 2, true);
                                    ctx.closePath();
                                    ctx.clip();
                                    
                                    // Draw Image (cover)
                                    // Calculate aspect ratio to cover
                                    const scale = Math.max(80 / img.width, 80 / img.height);
                                    const x = (80 - img.width * scale) / 2;
                                    const y = (80 - img.height * scale) / 2;
                                    ctx.drawImage(img, x, y, img.width * scale, img.height * scale);
                                    ctx.restore();

                                    // Blue Border Ring
                                    ctx.beginPath();
                                    ctx.lineWidth = 4;
                                    ctx.strokeStyle = '#4285F4';
                                    ctx.arc(40, 40, 38, 0, Math.PI * 2, true);
                                    ctx.stroke();

                                    new google.maps.Marker({
                                        position: location,
                                        map: map,
                                        title: "目前位置",
                                        icon: {
                                            url: canvas.toDataURL(),
                                            scaledSize: new google.maps.Size(48, 48),
                                            anchor: new google.maps.Point(24, 24)
                                        },
                                        zIndex: 1000
                                    });
                                } catch (e) {
                                    console.error("Avatar marker error:", e);
                                    createDefaultMarker();
                                }
                            };
                            img.onerror = () => {
                                console.warn("Avatar load failed, using default marker");
                                createDefaultMarker();
                            };
                        } else {
                            createDefaultMarker();
                        }

                        // Target Location Marker and Circle
                        if (targetLocation) {
                            if (workSiteCircleRef.current) {
                                workSiteCircleRef.current.setMap(null);
                            }
                            
                            workSiteCircleRef.current = new google.maps.Circle({
                                strokeColor: "#FF0000",
                                strokeOpacity: 0.8,
                                strokeWeight: 2,
                                fillColor: "#FF0000",
                                fillOpacity: 0.15,
                                map: map,
                                center: targetLocation,
                                radius: 100 // Default 100m
                            });

                            new google.maps.Marker({
                                position: targetLocation,
                                map: map,
                                title: targetName,
                                label: {
                                    text: "打卡點",
                                    color: "white",
                                    fontSize: "12px",
                                    fontWeight: "bold"
                                }
                            });
                        }
                    }
                } catch (err) {
                    console.error("Map initialization error:", err);
                    // Don't crash the UI, just log the error
                }
            }, [step, location, workSite, checkInLocation, userAvatar]);

            const startCamera = async () => {
                try {
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        throw new Error('您的瀏覽器不支援相機功能，請使用 Safari (iOS) 或 Chrome (Android)');
                    }
                    const s = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: 'user',
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        } 
                    });
                    setStream(s);
                    if (videoRef.current) {
                        videoRef.current.srcObject = s;
                    }
                } catch (e) {
                    setError('無法存取相機：' + (e.message || '請確認權限'));
                    console.error(e);
                }
            };

            const stopCamera = () => {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    setStream(null);
                }
            };

            const startLocation = () => {
                setAddress('定位中...');
                setError('');
                if (!navigator.geolocation) {
                    setAddress('瀏覽器不支援定位');
                    return;
                }

                const successCallback = async (pos) => {
                    const { latitude, longitude } = pos.coords;
                    setLocation({ lat: latitude, lng: longitude });
                    setError('');
                    // Reverse Geocoding
                    try {
                        if (window.google && window.google.maps) {
                            const gc = new google.maps.Geocoder();
                            const latlng = { lat: latitude, lng: longitude };
                            gc.geocode({ location: latlng }, (results, status) => {
                                if (status === 'OK' && results[0]) {
                                    setAddress(results[0].formatted_address);
                                } else {
                                    setAddress(`${latitude.toFixed(4)}, ${longitude.toFixed(4)}`);
                                }
                            });
                        } else {
                            setAddress(`${latitude.toFixed(4)}, ${longitude.toFixed(4)}`);
                        }
                    } catch (e) {
                        setAddress(`${latitude.toFixed(4)}, ${longitude.toFixed(4)}`);
                    }
                };

                const errorCallback = (err) => {
                    console.error(err);
                    let msg = '定位失敗';
                    switch(err.code) {
                        case err.PERMISSION_DENIED:
                            msg = '定位權限被拒絕，請允許存取位置';
                            break;
                        case err.POSITION_UNAVAILABLE:
                            msg = '無法偵測位置資訊';
                            break;
                        case err.TIMEOUT:
                            msg = '定位逾時，請重試或確認訊號';
                            break;
                    }
                    setAddress(msg);
                    setError(msg);
                };

                // 策略：優先嘗試高精準度 (GPS)，但設定較短超時 (3秒) 與允許快取 (10秒) 以加快速度
                // 如果失敗，則自動降級為一般定位 (WiFi/基地台)
                navigator.geolocation.getCurrentPosition(
                    successCallback,
                    (err) => {
                        // High accuracy failed/timeout, falling back to low accuracy...
                        // 降級嘗試：不強制高精準度，增加超時時間，允許較舊快取
                        navigator.geolocation.getCurrentPosition(
                            successCallback,
                            errorCallback,
                            { enableHighAccuracy: false, timeout: 10000, maximumAge: 60000 }
                        );
                    },
                    { enableHighAccuracy: true, timeout: 3000, maximumAge: 10000 }
                );
            };

            const handleRelocate = () => {
                setLocation(null);
                if (workSiteCircleRef.current) {
                    workSiteCircleRef.current.setMap(null);
                    workSiteCircleRef.current = null;
                }
                startLocation();
            };

            const handleShowWorkSite = () => {
                const target = checkInLocation || workSite;
                if (!target) {
                    alert('未找到您的服務單位資料');
                    return;
                }
                
                let wsLocation = null;
                if (target.lat && target.lng) {
                    wsLocation = { lat: parseFloat(target.lat), lng: parseFloat(target.lng) };
                } else if (target.location) {
                    const locStr = String(target.location);
                    const parts = locStr.split(',');
                    if (parts.length === 2) {
                        const lat = parseFloat(parts[0].trim());
                        const lng = parseFloat(parts[1].trim());
                        if (!isNaN(lat) && !isNaN(lng)) {
                            wsLocation = { lat, lng };
                        }
                    }
                }

                if (!wsLocation) {
                    alert('服務單位未設定有效的 GPS 座標');
                    return;
                }

                if (mapRef.current && window.google && window.google.maps) {
                    const mapInstance = new google.maps.Map(mapRef.current, {
                        center: wsLocation,
                        zoom: 17,
                        disableDefaultUI: true,
                        zoomControl: true,
                    });

                    // Current Position Marker
                    if (location) {
                        new google.maps.Marker({
                            position: location,
                            map: mapInstance,
                            title: "目前位置",
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                scale: 7,
                                fillColor: "#4285F4",
                                fillOpacity: 1,
                                strokeColor: "white",
                                strokeWeight: 2,
                            },
                        });
                    }

                    // Work Site Circle
                    if (workSiteCircleRef.current) {
                        workSiteCircleRef.current.setMap(null);
                    }
                    
                    workSiteCircleRef.current = new google.maps.Circle({
                        strokeColor: "#FF0000",
                        strokeOpacity: 0.8,
                        strokeWeight: 2,
                        fillColor: "#FF0000",
                        fillOpacity: 0.15,
                        map: mapInstance,
                        center: wsLocation,
                        radius: 100 // Default 100m if not specified
                    });

                    // Work Site Marker
                    new google.maps.Marker({
                        position: wsLocation,
                        map: mapInstance,
                        title: target.name || "服務單位",
                        label: {
                            text: "打卡點",
                            color: "white",
                            fontSize: "12px",
                            fontWeight: "bold"
                        }
                    });
                }
            };

            const nextToCamera = () => {
                setStep('camera');
                startCamera();
            };

            const capture = () => {
                if (!videoRef.current || !canvasRef.current) return;
                const video = videoRef.current;
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                
                // Resize logic
                let w = video.videoWidth;
                let h = video.videoHeight;
                const maxDim = 800; // Reduced to 800px
                if (w > maxDim || h > maxDim) {
                    if (w > h) {
                        h = Math.round((h / w) * maxDim);
                        w = maxDim;
                    } else {
                        w = Math.round((w / h) * maxDim);
                        h = maxDim;
                    }
                }

                canvas.width = w;
                canvas.height = h;
                
                // Draw Video
                ctx.drawImage(video, 0, 0, w, h);
                
                // Draw Watermark
                const dateStr = new Date().toLocaleString('zh-TW');
                
                // Gradient Background for text
                const grad = ctx.createLinearGradient(0, canvas.height - 100, 0, canvas.height);
                grad.addColorStop(0, 'transparent');
                grad.addColorStop(1, 'rgba(0,0,0,0.8)');
                ctx.fillStyle = grad;
                ctx.fillRect(0, canvas.height - 100, canvas.width, 100);

                ctx.fillStyle = 'white';
                ctx.font = 'bold 24px sans-serif';
                ctx.fillText(dateStr, 20, canvas.height - 60);
                ctx.font = '16px sans-serif';
                ctx.fillText(address, 20, canvas.height - 35);
                if (location) {
                    ctx.fillText(`GPS: ${location.lat}, ${location.lng}`, 20, canvas.height - 15);
                }
                
                // CheckIn Location Name (Top Left)
                if (checkInLocationName) {
                    ctx.textAlign = 'left';
                    ctx.font = 'bold 20px sans-serif';
                    ctx.fillStyle = 'white';
                    ctx.shadowColor = 'black';
                    ctx.shadowBlur = 4;
                    ctx.fillText(checkInLocationName, 20, 40);
                }

                // User Name (Top Right)
                ctx.textAlign = 'right';
                ctx.font = 'bold 20px sans-serif';
                ctx.shadowColor = 'black';
                ctx.shadowBlur = 4;
                ctx.fillText(userName || '', canvas.width - 20, 40);

                canvas.toBlob((blob) => {
                    if (blob) {
                        console.log(`Image size: ${(blob.size / 1024).toFixed(2)} KB`);
                        // Optional: alert(`照片大小: ${(blob.size / 1024).toFixed(2)} KB`);
                    }
                    setImage(blob);
                    setStep('preview');
                    stopCamera();
                }, 'image/jpeg', 0.5);
            };

            const retake = () => {
                setImage(null);
                setStep('camera');
                startCamera();
            };

            const confirm = async () => {
                if (!image || !location) return;
                setIsProcessing(true);
                try {
                    await onConfirm(image, location, address);
                } catch (e) {
                    console.error(e);
                } finally {
                    setIsProcessing(false);
                }
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-[100] bg-black bg-opacity-90 flex flex-col items-center justify-center p-4">
                    <div className="bg-white rounded-2xl w-full max-w-md overflow-hidden flex flex-col max-h-[90vh] h-[600px]">
                        <div className="p-4 border-b flex justify-between items-center bg-gray-50 flex-shrink-0">
                            <h3 className="font-bold text-lg">
                                {{
                                    'in': '上班打卡',
                                    'out': '下班簽退',
                                    'outing_start': '外出打卡',
                                    'outing_arrive': '抵達打卡',
                                    'outing_end': '離開打卡'
                                }[type] || '打卡'} - 流程
                            </h3>
                            <button onClick={onClose} className="p-2 bg-gray-200 rounded-full"><X className="w-5 h-5" /></button>
                        </div>
                        
                        <div className="flex-1 bg-gray-100 relative flex items-center justify-center overflow-hidden w-full">
                            {step === 'location' && (
                                <div className="w-full h-full flex flex-col">
                                    <div className="flex-1 relative w-full h-full">
                                        {location ? (
                                            <div className="relative w-full h-full">
                                                <div ref={mapRef} className="w-full h-full"></div>

                                                {/* Check-In Location Selector */}
                                                <div className="absolute top-4 left-4 z-10 flex flex-col gap-1">
                                                    <div className="bg-white/90 px-3 py-1 rounded-t-lg shadow-sm text-xs font-bold text-gray-500 w-fit">
                                                        打卡位置
                                                    </div>
                                                    <div className="bg-white rounded-lg shadow-lg overflow-hidden min-w-[160px] transition-all duration-200">
                                                        {(availableLocations || []).length > 1 ? (
                                                            <div className="flex flex-col">
                                                                <button
                                                                    onClick={() => setShowLocationList(!showLocationList)}
                                                                    className="px-4 py-3 text-left font-bold text-sm text-gray-800 hover:bg-gray-50 transition-colors flex items-center justify-between w-full"
                                                                >
                                                                    <div className="flex items-center gap-2">
                                                                        <span className={checkInLocation ? 'text-red-600' : ''}>
                                                                            {checkInLocation?.name || '請選擇位置'}
                                                                        </span>
                                                                    </div>
                                                                    {showLocationList ? <ChevronUp className="w-4 h-4 text-gray-400" /> : <ChevronDown className="w-4 h-4 text-gray-400" />}
                                                                </button>
                                                                
                                                                {showLocationList && (
                                                                    <div className="border-t max-h-[200px] overflow-y-auto">
                                                                        {(availableLocations || []).map(loc => (
                                                                            <button
                                                                                key={loc.id}
                                                                                onClick={() => {
                                                                                    setCheckInLocation && setCheckInLocation(loc);
                                                                                    setShowLocationList(false);
                                                                                }}
                                                                                className={`px-4 py-3 text-left font-bold text-sm border-b last:border-0 hover:bg-gray-50 transition-colors flex items-center justify-between w-full ${checkInLocation?.id === loc.id ? 'bg-red-50 text-red-600' : 'text-gray-800'}`}
                                                                            >
                                                                                {loc.name}
                                                                                {checkInLocation?.id === loc.id && <Check className="w-4 h-4" />}
                                                                            </button>
                                                                        ))}
                                                                    </div>
                                                                )}
                                                            </div>
                                                        ) : (
                                                            <div className="px-4 py-3 font-bold text-sm text-gray-800 flex items-center gap-2">
                                                                <Building2 className="w-4 h-4 text-red-600" />
                                                                {checkInLocationName || '未指定位置'}
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                                
                                                {/* Relocate Button */}
                                                <button 
                                                    onClick={handleRelocate}
                                                    className="absolute bottom-4 right-4 bg-white p-3 rounded-full shadow-lg hover:bg-gray-100 z-10"
                                                    title="重新定位"
                                                >
                                                    <RefreshCw className="w-6 h-6 text-gray-700" />
                                                </button>

                                                {/* Show Work Site Button */}
                                                <button 
                                                    onClick={handleShowWorkSite}
                                                    className="absolute top-4 right-4 bg-red-600 text-white px-4 py-2 rounded-2xl shadow-lg hover:bg-red-700 z-10 font-bold text-sm flex items-center gap-2"
                                                    title="顯示打卡點範圍"
                                                >
                                                    <MapPin className="w-4 h-4" /> 打卡點
                                                </button>
                                            </div>
                                        ) : (
                                            <div className="w-full h-full flex items-center justify-center text-gray-500 flex-col gap-2">
                                                <div className="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-red-600"></div>
                                                <div>定位中...</div>
                                            </div>
                                        )}
                                    </div>
                                    <div className="p-4 bg-white border-t">
                                        <div className="flex items-start gap-3">
                                            <MapPin className={`w-5 h-5 mt-1 flex-shrink-0 ${error ? 'text-gray-400' : 'text-red-600'}`} />
                                            <div className="flex-1">
                                                <div className="text-xs text-gray-400">目前位置</div>
                                                <div className={`font-bold text-sm ${error ? 'text-red-500' : 'text-gray-800'}`}>{address}</div>
                                            </div>
                                            {error && (
                                                <button onClick={startLocation} className="p-2 bg-gray-100 rounded-full hover:bg-gray-200" title="重新定位">
                                                    <RefreshCw className="w-4 h-4 text-gray-600" />
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {step === 'camera' && (
                                <>
                                    <video ref={videoRef} autoPlay playsInline muted className="w-full h-full object-cover"></video>
                                    <div className="absolute bottom-4 left-4 right-4 text-white text-xs bg-black/50 p-2 rounded-2xl">
                                        <MapPin className="w-3 h-3 inline mr-1" />
                                        {address}
                                    </div>
                                </>
                            )}

                            {step === 'preview' && (
                                <img src={URL.createObjectURL(image)} className="w-full h-full object-contain" />
                            )}
                            <canvas ref={canvasRef} className="hidden"></canvas>
                        </div>

                        <div className="p-6 bg-white flex-shrink-0">
                            {error && <div className="text-red-500 text-center mb-4 text-sm">{error}</div>}
                            
                            {step === 'location' && (
                                <button 
                                    onClick={nextToCamera} 
                                    disabled={!location}
                                    className="w-full py-4 bg-red-600 text-white rounded-2xl font-bold text-lg flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    下一步：拍照認證
                                </button>
                            )}

                            {step === 'camera' && (
                                <button onClick={capture} className="w-full py-4 bg-red-600 text-white rounded-2xl font-bold text-lg flex items-center justify-center gap-2">
                                    <Camera className="w-6 h-6" /> 拍照
                                </button>
                            )}

                            {step === 'preview' && (
                                <div className="flex gap-3">
                                    <button onClick={retake} className="flex-1 py-3 bg-gray-100 text-gray-700 rounded-2xl font-bold flex items-center justify-center gap-2">
                                        <RefreshCw className="w-5 h-5" /> 重拍
                                    </button>
                                    <button onClick={confirm} disabled={isProcessing} className="flex-1 py-3 bg-red-600 text-white rounded-2xl font-bold flex items-center justify-center gap-2">
                                        {isProcessing ? '處理中...' : '確認打卡'}
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>


                </div>
            );
        };

        // 2. Login Component (Mobile Optimized, Red Theme)
        const Login = ({ onLogin, onRegister, onLoginSuccess, isOnline }) => {
            const [identifier, setIdentifier] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [isSeeding, setIsSeeding] = useState(false);
            const [rememberMe, setRememberMe] = useState(true);
            const [showPassword, setShowPassword] = useState(false);
            const [isLoading, setIsLoading] = useState(false);

            const handleLogin = async (e) => {
                e.preventDefault();
                if (!identifier || !password) {
                    setError('請輸入帳號密碼');
                    return;
                }
                setError('');
                setIsLoading(true);
                try {
                    await onLogin(identifier, password, rememberMe);
                    setError('登入成功！正在跳轉...');
                    setTimeout(() => {
                        onLoginSuccess();
                    }, 1000);
                } catch (e) {
                    setIsLoading(false);
                    if (e && e.code === 'auth/network-request-failed') {
                        setError('網路連線失敗，請確認網路與允許網域設定後重試');
                    } else if (e && e.code === 'auth/invalid-email') {
                        setError('Email 格式不正確');
                    } else if (e && e.code === 'auth/invalid-credential') {
                        setError('帳號或密碼錯誤');
                    } else {
                        setError(`登入錯誤: ${e.message || '請重試'}`);
                    }
                }
            };


            return (
                <div className="min-h-screen flex flex-col justify-center bg-gray-50 px-6 py-12">
                    <div className="w-full max-w-sm mx-auto bg-white p-8 rounded-2xl shadow-xl border border-gray-100">
                        <div className="text-center mb-8">
                            <div className="bg-red-600 w-20 h-20 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg shadow-red-200 transform rotate-3">
                                <Clock className="text-white w-10 h-10" />
                            </div>
                            <h1 className="text-2xl font-bold text-gray-800 tracking-tight">西北社區打卡系統</h1>
                            <p className="text-gray-400 text-sm mt-2">安居管家 · 智慧服務</p>
                        </div>

                        <form onSubmit={handleLogin} className="space-y-5">
                            <div>
                                <div className="flex items-center justify-between mb-2">
                                    <label className="block text-xs font-bold text-gray-500 uppercase tracking-wider">帳號 (Email 或 手機號碼)</label>
                                    <label className="flex items-center gap-1 text-[11px] text-gray-500">
                                        <input type="checkbox" checked={rememberMe} onChange={(e) => setRememberMe(e.target.checked)} /> 記住我
                                    </label>
                                </div>
                                <input
                                    type="text"
                                    value={identifier}
                                    onChange={(e) => setIdentifier(e.target.value)}
                                    className="w-full px-5 py-3 bg-gray-50 border border-gray-200 rounded-2xl focus:ring-2 focus:ring-red-500 focus:border-red-500 outline-none transition text-gray-700 font-medium"
                                    placeholder="Email 或 手機號碼"
                                    disabled={isLoading}
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">密碼</label>
                                <div className="relative">
                                    <input
                                        type={showPassword ? 'text' : 'password'}
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        className="w-full pr-12 px-5 py-3 bg-gray-50 border border-gray-200 rounded-2xl focus:ring-2 focus:ring-red-500 focus:border-red-500 outline-none transition text-gray-700 font-medium"
                                        placeholder="••••••"
                                        disabled={isLoading}
                                    />
                                    <button type="button" onClick={() => setShowPassword(!showPassword)} className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-700">
                                        {showPassword ? <EyeOff className="w-5 h-5" /> : <Eye className="w-5 h-5" />}
                                    </button>
                                </div>
                            </div>

                            {error && (
                                <div className={`text-sm text-center p-3 rounded-2xl font-medium ${error.includes('成功') ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-600'}`}>
                                    {error}
                                </div>
                            )}

                            <button
                                type="submit"
                                disabled={!isOnline || isLoading}
                                className="w-full bg-red-600 hover:bg-red-700 active:bg-red-800 text-white font-bold py-4 rounded-2xl transition duration-200 shadow-lg shadow-red-200 text-lg disabled:opacity-50 flex items-center justify-center gap-2"
                            >
                                {isLoading ? (
                                    <>
                                        <div className="animate-spin rounded-full h-5 w-5 border-t-2 border-b-2 border-white"></div>
                                        處理中...
                                    </>
                                ) : (
                                    '登入系統'
                                )}
                            </button>
                            <button
                                type="button"
                                disabled={!isOnline || isLoading}
                                onClick={async () => {
                                    if (!identifier || !password) {
                                        setError('請輸入帳號密碼');
                                        return;
                                    }
                                    if (identifier.indexOf('@') === -1) {
                                        setError('註冊請使用 Email');
                                        return;
                                    }
                                    setError('');
                                    setIsLoading(true);
                                    try {
                                        await onRegister(identifier, password, rememberMe);
                                        setError('註冊成功！正在跳轉...');
                                        setTimeout(() => {
                                            onLoginSuccess();
                                        }, 1000);
                                    } catch (e) {
                                        setIsLoading(false);
                                        if (e && e.code === 'auth/network-request-failed') {
                                            setError('網路連線失敗，請確認網路與允許網域設定後重試');
                                        } else if (e && e.code === 'auth/email-already-in-use') {
                                            setError('Email 已被使用，請改用其他帳號');
                                        } else if (e && e.code === 'auth/weak-password') {
                                            setError('密碼強度不足');
                                        } else {
                                            setError('註冊錯誤，請重試');
                                        }
                                    }
                                }}
                                className="w-full mt-3 bg-white hover:bg-gray-50 text-red-600 font-bold py-3 rounded-2xl transition border border-red-200 disabled:opacity-50"
                            >
                                註冊帳號
                            </button>
                            
                            {!isOnline && (
                                <div className="mt-3 text-center text-xs text-yellow-700 bg-yellow-50 border border-yellow-200 rounded-2xl py-2">
                                    目前離線，請確認網路後再試
                                </div>
                            )}
                        </form>

                        
                    </div>
                </div>
            );
        };

        // 3. Admin Dashboard (System Config)
        const AdminDashboard = ({ user, currentUser, users, communities, roles, companies, areas, pages, onAddUser, onAddCommunity, subtab }) => {
            const [newCommName, setNewCommName] = useState('');
            const [newUser, setNewUser] = useState({ name: '', email: '', role: 'staff', communityId: '' });
            const [showAddModal, setShowAddModal] = useState(false);
            const [modalUser, setModalUser] = useState({ role: 'admin', title: '', name: '', email: '', phone: '', communityId: '', avatarUrl: '' });
            const [showRoleModal, setShowRoleModal] = useState(false);
            const [roleForm, setRoleForm] = useState({ name: '', permissions: [] });
            const [roleSaving, setRoleSaving] = useState(false);
            const [roleError, setRoleError] = useState('');
            const [showCompanyModal, setShowCompanyModal] = useState(false);
            const [companyForm, setCompanyForm] = useState({ id: '', name: '', address: '', lat: '', lng: '', radius: 100 });
            const [companySaving, setCompanySaving] = useState(false);
            const [companyError, setCompanyError] = useState('');
            const [showAreaModal, setShowAreaModal] = useState(false);
            const [areaForm, setAreaForm] = useState({ id: '', name: '' });

            const handleExportCommunities = () => {
                if (!communities || communities.length === 0) {
                    setToast('無資料可匯出');
                    return;
                }
                const data = communities.map(c => ({
                    '社區編號': c.id,
                    '社區名稱': c.name,
                    '所屬公司ID': c.companyId || '',
                    '所屬區域ID': c.areaId || '',
                    '總幹事數': c.gmCount || 0,
                    '秘書數': c.secretaryCount || 0,
                    '清潔數': c.cleanCount || 0,
                    '機電數': c.mechCount || 0,
                    '保全數': c.guardCount || 0,
                    '白天哨數': c.dayGuardCount || 0,
                    '晚上哨數': c.nightGuardCount || 0,
                    '社區地址': c.address || '',
                    '緯度': c.coordLat || '',
                    '經度': c.coordLng || '',
                    '打卡範圍(公尺)': c.radiusMeters || 100
                }));
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Communities");
                XLSX.writeFile(wb, "communities_export.xlsx");
            };

            const handleImportCommunities = async (e) => {
                const file = e.target.files?.[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = async (evt) => {
                    try {
                        const bstr = evt.target.result;
                        const wb = XLSX.read(bstr, { type: 'binary' });
                        const wsname = wb.SheetNames[0];
                        const ws = wb.Sheets[wsname];
                        const data = XLSX.utils.sheet_to_json(ws);
                        
                        if (!data || data.length === 0) {
                            setToast('檔案無資料');
                            return;
                        }

                        let count = 0;
                        for (const row of data) {
                            const id = (row['社區編號'] || '').toString().trim();
                            if (!id) continue;
                            
                            const communityData = {
                                name: row['社區名稱'] || '',
                                companyId: (row['所屬公司ID'] || '').toString(),
                                areaId: (row['所屬區域ID'] || '').toString(),
                                gmCount: parseInt(row['總幹事數'] || 0),
                                secretaryCount: parseInt(row['秘書數'] || 0),
                                cleanCount: parseInt(row['清潔數'] || 0),
                                mechCount: parseInt(row['機電數'] || 0),
                                guardCount: parseInt(row['保全數'] || 0),
                                dayGuardCount: parseInt(row['白天哨數'] || 0),
                                nightGuardCount: parseInt(row['晚上哨數'] || 0),
                                address: row['社區地址'] || '',
                                coordLat: row['緯度'] || '',
                                coordLng: row['經度'] || '',
                                radiusMeters: parseInt(row['打卡範圍(公尺)'] || 100),
                                updatedByName: (currentUser && currentUser.name) || '匯入',
                                updatedAt: serverTimestamp()
                            };

                            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'communities', id), communityData, { merge: true });
                            count++;
                        }
                        setToast(`成功匯入 ${count} 筆社區資料`);
                    } catch (err) {
                        console.error(err);
                        setToast('匯入失敗：' + err.message);
                    }
                };
                reader.readAsBinaryString(file);
                e.target.value = ''; // Reset input
            };
            const [areaSaving, setAreaSaving] = useState(false);
            const [areaError, setAreaError] = useState('');
            const [userSaving, setUserSaving] = useState(false);
            const [userError, setUserError] = useState('');
            const [confirmDelete, setConfirmDelete] = useState(null);
            const [toast, setToast] = useState('');
            const [editingUserId, setEditingUserId] = useState(null);
            const [showCommunityModal, setShowCommunityModal] = useState(false);
            const [communityForm, setCommunityForm] = useState({ id:'', name:'', companyId:'', areaId:'', gmCount:0, secretaryCount:0, cleanCount:0, mechCount:0, guardCount:0, dayGuardCount:0, nightGuardCount:0, address:'', coordLat:'', coordLng:'', radiusMeters:100 });
            const [communitySaving, setCommunitySaving] = useState(false);
            const [communityError, setCommunityError] = useState('');
            const [mapTarget, setMapTarget] = useState(null);
            const [mapPreviewTarget, setMapPreviewTarget] = useState(null);
            const mapTargetElRef = useRef(null);
            const mapTargetMapRef = useRef(null);
            const mapTargetCircleRef = useRef(null);

            const communityMapElRef = useRef(null);
            const communityGMapRef = useRef(null);
            const communityGCircleRef = useRef(null);
            const communityGMarkerRef = useRef(null);
            const communityGClickListenerRef = useRef(null);

            useEffect(()=>{
                if (!showCommunityModal) return;
                if (!window.google || !window.google.maps) return;
                const lat = parseFloat(communityForm.coordLat);
                const lng = parseFloat(communityForm.coordLng);
                const hasCoords = !isNaN(lat) && !isNaN(lng);
                const defaultCenter = { lat: 25.0330, lng: 121.5654 };
                const center = hasCoords ? { lat, lng } : defaultCenter;
                if (!communityGMapRef.current && communityMapElRef.current) {
                    communityGMapRef.current = new google.maps.Map(communityMapElRef.current, { center, zoom: 16 });
                } else if (communityGMapRef.current) {
                    communityGMapRef.current.setCenter(center);
                    communityGMapRef.current.setZoom(16);
                }
                if (hasCoords) {
                    if (!communityGMarkerRef.current) {
                        communityGMarkerRef.current = new google.maps.Marker({ position: center, map: communityGMapRef.current });
                    } else {
                        communityGMarkerRef.current.setPosition(center);
                    }
                }
                if (communityGCircleRef.current) {
                    communityGCircleRef.current.setMap(null);
                    communityGCircleRef.current = null;
                }
                if (hasCoords) {
                    communityGCircleRef.current = new google.maps.Circle({ center, radius: communityForm.radiusMeters || 0, strokeColor: '#dc2626', fillColor: '#dc2626', fillOpacity: 0.15, map: communityGMapRef.current });
                }
                if (communityGClickListenerRef.current) {
                    google.maps.event.removeListener(communityGClickListenerRef.current);
                    communityGClickListenerRef.current = null;
                }
                communityGClickListenerRef.current = google.maps.event.addListener(communityGMapRef.current, 'click', (e) => {
                    const latLng = e.latLng;
                    const newLat = latLng.lat();
                    const newLng = latLng.lng();
                    setCommunityForm(prev => ({ ...prev, coordLat: newLat, coordLng: newLng }));
                    if (!communityGMarkerRef.current) {
                        communityGMarkerRef.current = new google.maps.Marker({ position: latLng, map: communityGMapRef.current });
                    } else {
                        communityGMarkerRef.current.setPosition(latLng);
                    }
                });
            }, [showCommunityModal, communityForm.coordLat, communityForm.coordLng, communityForm.radiusMeters]);

            useEffect(()=>{
                if (!showCommunityModal && communityGMapRef.current) {
                    if (communityGClickListenerRef.current) {
                        google.maps.event.removeListener(communityGClickListenerRef.current);
                        communityGClickListenerRef.current = null;
                    }
                    communityGMarkerRef.current = null;
                    communityGCircleRef.current = null;
                    communityGMapRef.current = null;
                }
            }, [showCommunityModal]);

            useEffect(() => {
                if (!mapTarget) return;
                const init = () => {
                    if (!mapTargetElRef.current) return;
                    const center = { lat: mapTarget.lat, lng: mapTarget.lng };
                    if (!mapTargetMapRef.current) {
                        mapTargetMapRef.current = new google.maps.Map(mapTargetElRef.current, { center, zoom: 16 });
                    } else {
                        mapTargetMapRef.current.setCenter(center);
                        mapTargetMapRef.current.setZoom(16);
                    }
                    new google.maps.Marker({ position: center, map: mapTargetMapRef.current });
                    if (mapTargetCircleRef.current) {
                        mapTargetCircleRef.current.setMap(null);
                        mapTargetCircleRef.current = null;
                    }
                    mapTargetCircleRef.current = new google.maps.Circle({ center, radius: mapTarget.radius || 0, strokeColor: '#dc2626', fillColor: '#dc2626', fillOpacity: 0.15, map: mapTargetMapRef.current });
                };
                if (window.google && window.google.maps) {
                    init();
                } else {
                    const script = document.querySelector('script[src*="maps.googleapis.com/maps/api/js"]');
                    if (script) {
                        const handler = () => init();
                        script.addEventListener('load', handler, { once: true });
                        return () => { script.removeEventListener('load', handler); };
                    }
                }
                return () => {
                    mapTargetCircleRef.current = null;
                    mapTargetMapRef.current = null;
                };
            }, [mapTarget]);

            useEffect(()=>{ if (!toast) return; const t = setTimeout(()=>setToast(''), 2000); return ()=>clearTimeout(t); }, [toast]);

            const handleAvatarUpload = (file) => {
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const size = 512;
                        canvas.width = size; canvas.height = size;
                        const ctx = canvas.getContext('2d');
                        
                        // Center crop
                        const scale = Math.max(size / img.width, size / img.height);
                        const x = (size - img.width * scale) / 2;
                        const y = (size - img.height * scale) / 2;
                        
                        ctx.drawImage(img, x, y, img.width * scale, img.height * scale);
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.85);
                        setModalUser(prev => ({ ...prev, avatarUrl: dataUrl }));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            };

            const formatDateTime = (v) => {
                if (!v) return '-';
                const d = v && typeof v.toDate === 'function' ? v.toDate() : new Date(v);
                if (!d || isNaN(d.getTime())) return '-';
                return new Intl.DateTimeFormat('zh-TW', {
                    timeZone: 'Asia/Taipei',
                    year: 'numeric', month: '2-digit', day: '2-digit',
                    hour: '2-digit', minute: '2-digit', second: '2-digit',
                    hour12: false
                }).format(d).replace(/\//g, '/');
            };

            return (
                <div className="space-y-4 pb-20">
                    <div className="grid grid-cols-1 gap-4">
                        {subtab === 'general' && (
                        <div className="space-y-6">
                            <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                                <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                    <Shield className="w-5 h-5 mr-2 text-red-600" /> 角色列表
                                </h3>
                                <div className="mb-4">
                                    <button onClick={() => { setRoleForm({ name: '', permissions: [] }); setShowRoleModal(true); }} className="bg-red-600 text-white px-4 py-2 rounded-2xl text-sm font-bold hover:bg-red-700">新增</button>
                                </div>
                                <div className="max-h-[500px] overflow-y-auto overflow-x-auto no-scrollbar">
                                    <div className="grid grid-cols-4 gap-2 px-3 py-2 text-[11px] font-bold text-gray-500 whitespace-nowrap min-w-[1020px] text-left">
                                        <div>角色名稱</div>
                                        <div>權限</div>
                                        <div>操作</div>
                                        <div>紀錄</div>
                                    </div>
                                    <div className="space-y-2">
                                        {roles.length === 0 ? (
                                            <div className="flex flex-row gap-4 items-center p-3 bg-gray-50 rounded-2xl text-xs whitespace-nowrap min-w-[1020px]">
                                                <div className="font-bold text-gray-300 min-w-[160px]">—</div>
                                                <div className="text-gray-300 min-w-[420px]">—</div>
                                                <div className="flex gap-2 justify-start min-w-[180px]">
                                                    <button disabled className="px-2 py-1 rounded-2xl bg-gray-200 text-gray-400">編輯</button>
                                                    <button disabled className="px-2 py-1 rounded-2xl bg-gray-200 text-gray-400">刪除</button>
                                                </div>
                                                <div className="min-w-[240px] text-gray-300">—</div>
                                            </div>
                                        ) : roles.map(r => (
                                            <div key={r.id} className="flex flex-row gap-4 items-center p-3 bg-gray-50 rounded-2xl text-xs whitespace-nowrap min-w-[1020px]">
                                                <div className="font-bold text-gray-700 min-w-[160px]">{r.name}</div>
                                                <div className="text-gray-700 min-w-[420px]">{(r.permissions || []).map(p => pages.find(x=>x.key===p)?.label || p).join('、') || '-'}</div>
                                                <div className="flex gap-2 justify-start min-w-[180px]">
                                                <button onClick={()=>{ setRoleForm({ name: r.name, permissions: r.permissions || [] }); setShowRoleModal(true); setRoleForm(prev=>({ ...prev, id: r.id })); }} className="px-2 py-1 rounded-2xl bg-gray-800 text-white">編輯</button>
                                                <button onClick={()=>{ setConfirmDelete({ type:'role', id:r.id, label:r.name }); }} className="px-2 py-1 rounded-2xl bg-red-600 text-white">刪除</button>
                                                </div>
                                                <div className="min-w-[240px] text-gray-700">{r.updatedByName ? `${r.updatedByName} ${formatDateTime(r.updatedAt)}` : '-'}</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                {showRoleModal && (
                                    <div className="fixed inset-0 z-[60] bg-black/40 flex items-center justify-center">
                                        <div className="bg-white rounded-2xl shadow-xl w-[90%] max-w-md p-6 max-h-[90vh] overflow-y-auto">
                                            <h4 className="text-lg font-bold text-gray-800 mb-4">新增/編輯角色</h4>
                                            <div className="space-y-3">
                                                <label className="block text-xs font-bold text-gray-500 uppercase">角色名稱</label>
                                                <input className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm focus:ring-2 focus:ring-red-100" value={roleForm.name} onChange={e=>setRoleForm(prev=>({...prev, name: e.target.value}))} placeholder="例如：系統管理員" />
                                                <div className="text-[11px] text-gray-500">常用：系統管理員、管理層、人事、幹部、總幹事、秘書、清潔、機電、保全</div>
                                                <label className="block text-xs font-bold text-gray-500 uppercase">權限</label>
                                                <div className="grid grid-cols-2 gap-2">
                                                    {pages.map(p => (
                                                        <label key={p.key} className="flex items-center gap-2 text-sm bg-gray-50 px-3 py-2 rounded-2xl">
                                                            <input type="checkbox" checked={roleForm.permissions.includes(p.key)} onChange={(e)=>{
                                                                const checked = e.target.checked;
                                                                setRoleForm(prev=>({ ...prev, permissions: checked ? [...prev.permissions, p.key] : prev.permissions.filter(x=>x!==p.key) }));
                                                            }} />
                                                            <span>{p.label}</span>
                                                        </label>
                                                    ))}
                                                </div>
                                                {roleError && <div className="text-xs text-red-600">{roleError}</div>}
                                            </div>
                                            <div className="flex justify-end gap-2 mt-4">
                                                <button onClick={()=>setShowRoleModal(false)} className="px-3 py-2 rounded-2xl bg-gray-100 text-gray-700">取消</button>
                                                <button disabled={roleSaving} onClick={async()=>{ try { setRoleError(''); setRoleSaving(true); if (!user) { setRoleError('沒有登入權限，請先登入'); return; } if (!roleForm.name.trim()) { setRoleError('請輸入角色名稱'); return; } if (roleForm.id) { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'roles', roleForm.id), { name: roleForm.name.trim(), permissions: roleForm.permissions, updatedByName: (currentUser && currentUser.name) || (user && user.email) || '', updatedAt: serverTimestamp() }); setToast('儲存成功'); } else { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'roles'), { name: roleForm.name.trim(), permissions: roleForm.permissions, updatedByName: '新增', updatedAt: serverTimestamp() }); setToast('新增成功'); } setShowRoleModal(false); } catch (e) { console.error(e); setRoleError(`儲存失敗：${e.code || e.message}`); } finally { setRoleSaving(false);} }} className="px-3 py-2 rounded-2xl bg-red-600 text-white">儲存</button>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>

                            <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                                <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                    <Building2 className="w-5 h-5 mr-2 text-red-600" /> 公司列表
                                </h3>
                                <div className="mb-4">
                                    <button onClick={() => { setCompanyForm({ id: '', name: '' }); setShowCompanyModal(true); }} className="bg-red-600 text-white px-4 py-2 rounded-2xl text-sm font-bold hover:bg-red-700">新增</button>
                                </div>
                                <div className="max-h-[500px] overflow-y-auto overflow-x-auto no-scrollbar">
                                    <div className="grid grid-cols-11 gap-2 px-3 py-2 text-[11px] font-bold text-gray-500 whitespace-nowrap min-w-[1300px] text-left">
                                        <div>公司編號</div>
                                        <div>公司名稱</div>
                                        <div className="col-span-2">公司地址</div>
                                        <div>公司座標</div>
                                        <div>公司地圖</div>
                                        <div>設定打卡範圍(公尺)</div>
                                        <div>幹部數</div>
                                        <div>員工數</div>
                                        <div>操作</div>
                                        <div>紀錄</div>
                                    </div>
                                    <div className="space-y-2">
                                        {companies.length === 0 ? (
                                            <div className="grid grid-cols-11 gap-2 items-center p-3 bg-gray-50 rounded-2xl text-xs whitespace-nowrap min-w-[1300px]">
                                                <div className="font-bold text-gray-300">—</div>
                                                <div className="text-gray-300">—</div>
                                                <div className="col-span-2 text-gray-300">—</div>
                                                <div className="text-gray-300">—</div>
                                                <div className="text-gray-300">—</div>
                                                <div className="text-gray-300">—</div>
                                                <div className="text-gray-300">0</div>
                                                <div className="text-gray-300">0</div>
                                                <div className="flex gap-2 justify-start">
                                                    <button disabled className="px-2 py-1 rounded-2xl bg-gray-200 text-gray-400">編輯</button>
                                                    <button disabled className="px-2 py-1 rounded-2xl bg-gray-200 text-gray-400">刪除</button>
                                                </div>
                                                <div className="text-gray-300">—</div>
                                            </div>
                                        ) : companies.map(c => {
                                            const execRoles = ['admin', 'hr', 'cadre'];
                                            // DEBUG Logic
                                            const allExecCandidates = users.filter(u => execRoles.includes(u.role));
                                            const debugTooltip = allExecCandidates.map(u => 
                                                `${u.name || u.email}: ${u.role}, Main=${u.companyId}, Subs=${JSON.stringify(u.companyIds || [])}, Match=${((u.companyIds && u.companyIds.some(cid => String(cid) === String(c.id))) || String(u.companyId) === String(c.id))}`
                                            ).join('\n');

                                            const execUsers = users.filter(u => ((u.companyIds && u.companyIds.some(cid => String(cid) === String(c.id))) || String(u.companyId) === String(c.id)) && execRoles.includes(u.role));
                                            const execCount = execUsers.length;
                                            const execNames = execUsers.map(u => u.name || u.email).join('\n');

                                            const staffRoles = ['manager', 'secretary', 'cleaner', 'mechanic', 'guard'];
                                            const staffUsers = users.filter(u => ((u.companyIds && u.companyIds.some(cid => String(cid) === String(c.id))) || String(u.companyId) === String(c.id)) && staffRoles.includes(u.role));
                                            const staffCount = staffUsers.length;
                                            const staffNames = staffUsers.map(u => u.name || u.email).join('\n');
                                            return (
                                            <div key={c.id} className="grid grid-cols-11 gap-2 items-center p-3 bg-gray-50 rounded-2xl text-xs whitespace-nowrap min-w-[1300px]">
                                                <div className="font-bold text-gray-700">{c.id}</div>
                                                <div className="text-gray-700">{c.name}</div>
                                                <div className="col-span-2 text-gray-700 truncate" title={c.address || '-'}>{c.address || '-'}</div>
                                                <div className="text-gray-700">{c.lat && c.lng ? `${parseFloat(c.lat).toFixed(4)}, ${parseFloat(c.lng).toFixed(4)}` : '-'}</div>
                                                <div>
                                                    {c.lat && c.lng ? (
                                                        <button onClick={()=>setMapPreviewTarget(c)} className="text-red-600 hover:text-red-800 flex items-center bg-red-50 hover:bg-red-100 px-2 py-1 rounded-lg transition-colors">
                                                            <MapPin className="w-3 h-3 mr-1" /> 地圖
                                                        </button>
                                                    ) : (
                                                        <span className="text-gray-300">-</span>
                                                    )}
                                                </div>
                                                <div className="text-gray-700">{c.radius ? `${c.radius}m` : '100m'}</div>
                                                <div className="text-gray-700 cursor-help underline decoration-dotted" title={debugTooltip}>{execCount}</div>
                                                <div className="text-gray-700 cursor-help underline decoration-dotted" title={staffNames}>{staffCount}</div>
                                                <div className="flex gap-2 justify-start">
                                                <button onClick={()=>{ setCompanyForm({ id: c.id, name: c.name, address: c.address || '', lat: c.lat || '', lng: c.lng || '', radius: c.radius || 100 }); setShowCompanyModal(true); }} className="px-2 py-1 rounded-2xl bg-gray-800 text-white">編輯</button>
                                                <button onClick={()=>{ setConfirmDelete({ type:'company', id:c.id, label:c.name }); }} className="px-2 py-1 rounded-2xl bg-red-600 text-white">刪除</button>
                                                </div>
                                                <div className="text-gray-700">{c.updatedByName ? `${c.updatedByName} ${formatDateTime(c.updatedAt)}` : '-'}</div>
                                            </div>
                                            );
                                        })}
                                    </div>
                                </div>
                                {showCompanyModal && (
                                    <div className="fixed inset-0 z-[60] bg-black/40 flex items-center justify-center">
                                        <div className="bg-white rounded-2xl shadow-xl w-[90%] max-w-md p-6 max-h-[90vh] overflow-y-auto">
                                            <h4 className="text-lg font-bold text-gray-800 mb-4">新增/編輯公司</h4>
                                            <div className="space-y-3">
                                                <label className="block text-xs font-bold text-gray-500 uppercase">公司編號</label>
                                                <input className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm focus:ring-2 focus:ring-red-100" value={companyForm.id} onChange={e=>setCompanyForm(prev=>({...prev, id: e.target.value}))} />
                                                
                                                <label className="block text-xs font-bold text-gray-500 uppercase">公司名稱</label>
                                                <input className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm focus:ring-2 focus:ring-red-100" value={companyForm.name} onChange={e=>setCompanyForm(prev=>({...prev, name: e.target.value}))} />
                                                
                                                <label className="block text-xs font-bold text-gray-500 uppercase">公司地址</label>
                                                <div className="flex gap-2">
                                                    <input 
                                                        className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm focus:ring-2 focus:ring-red-100" 
                                                        value={companyForm.address || ''} 
                                                        onChange={e=>setCompanyForm(prev=>({...prev, address: e.target.value}))}
                                                        onBlur={async(e)=>{ 
                                                            const addr = e.target.value.trim(); 
                                                            if (!addr) return; 
                                                            
                                                            const doNominatim = async () => {
                                                                try {
                                                                    const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(addr)}`); 
                                                                    const d = await r.json(); 
                                                                    if (d && d[0]) { 
                                                                        setCompanyForm(prev=>({...prev, lat: d[0].lat, lng: d[0].lon})); 
                                                                    }
                                                                } catch (err) {
                                                                    console.error("Nominatim error:", err);
                                                                }
                                                            };

                                                            try { 
                                                                if (window.google && window.google.maps) { 
                                                                    const gc = new google.maps.Geocoder(); 
                                                                    gc.geocode({ address: addr }, (res, status)=>{ 
                                                                        if (status === 'OK' && res && res[0]) { 
                                                                            const loc = res[0].geometry.location; 
                                                                            setCompanyForm(prev=>({...prev, lat: loc.lat(), lng: loc.lng()})); 
                                                                        } else {
                                                                            console.warn("Google Geocode failed:", status);
                                                                            doNominatim();
                                                                        }
                                                                    }); 
                                                                } else { 
                                                                    doNominatim(); 
                                                                } 
                                                            } catch (e) { 
                                                                console.error(e);
                                                                doNominatim();
                                                            } 
                                                        }}
                                                        placeholder="輸入地址"
                                                    />
                                                </div>

                                                <label className="block text-xs font-bold text-gray-500 uppercase">公司座標 (Lat, Lng)</label>
                                                <input 
                                                    className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm focus:ring-2 focus:ring-red-100" 
                                                    value={companyForm.lat && companyForm.lng ? `${companyForm.lat}, ${companyForm.lng}` : ''} 
                                                    onChange={e=>{
                                                        const parts = e.target.value.split(',');
                                                        if (parts.length === 2) {
                                                            setCompanyForm(prev=>({...prev, lat: parts[0].trim(), lng: parts[1].trim()}));
                                                        }
                                                    }}
                                                    placeholder="例如: 25.0330, 121.5654"
                                                />

                                                <label className="block text-xs font-bold text-gray-500 uppercase">設定打卡範圍 (公尺)</label>
                                                <input type="number" className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm focus:ring-2 focus:ring-red-100" value={companyForm.radius || 100} onChange={e=>setCompanyForm(prev=>({...prev, radius: parseInt(e.target.value) || 100}))} />

                                                <div className="w-full h-48 bg-gray-100 rounded-2xl overflow-hidden mt-2 relative">
                                                    {companyForm.lat && companyForm.lng ? (
                                                        <>
                                                            <CompanyMapPreview 
                                                                lat={companyForm.lat} 
                                                                lng={companyForm.lng} 
                                                                radius={companyForm.radius} 
                                                            />
                                                            <div className="absolute bottom-0 left-0 bg-white/80 px-2 py-1 text-[10px] font-bold text-gray-600 z-10 pointer-events-none">
                                                                範圍: {companyForm.radius}m
                                                            </div>
                                                        </>
                                                    ) : (
                                                        <div className="w-full h-full flex items-center justify-center text-gray-400 text-xs">
                                                            請輸入地址或座標以顯示地圖
                                                        </div>
                                                    )}
                                                </div>

                                                {companyError && <div className="text-xs text-red-600">{companyError}</div>}
                                            </div>
                                            <div className="flex justify-end gap-2 mt-4">
                                                <button onClick={()=>setShowCompanyModal(false)} className="px-3 py-2 rounded-2xl bg-gray-100 text-gray-700">取消</button>
                                                <button disabled={companySaving} onClick={async()=>{ try { setCompanyError(''); setCompanySaving(true); if (!user) { setCompanyError('沒有登入權限，請先登入'); return; } if (!companyForm.id.trim() || !companyForm.name.trim()) { setCompanyError('請輸入公司編號與公司名稱'); return; } if (companies.find(x=>x.id===companyForm.id.trim())) { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'companies', companyForm.id.trim()), { name: companyForm.name.trim(), address: companyForm.address || '', lat: companyForm.lat || '', lng: companyForm.lng || '', radius: companyForm.radius || 100, updatedByName: (currentUser && currentUser.name) || (user && user.email) || '', updatedAt: serverTimestamp() }); setToast('儲存成功'); } else { await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'companies', companyForm.id.trim()), { name: companyForm.name.trim(), address: companyForm.address || '', lat: companyForm.lat || '', lng: companyForm.lng || '', radius: companyForm.radius || 100, updatedByName: '新增', updatedAt: serverTimestamp() }); setToast('新增成功'); } setShowCompanyModal(false); } catch (e) { console.error(e); setCompanyError(`儲存失敗：${e.code || e.message}`); } finally { setCompanySaving(false);} }} className="px-3 py-2 rounded-2xl bg-red-600 text-white">儲存</button>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>

                            <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                                <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                    <LayoutDashboard className="w-5 h-5 mr-2 text-red-600" /> 區域列表
                                </h3>
                                <div className="mb-4">
                                    <button onClick={() => { setAreaForm({ id: '', name: '' }); setShowAreaModal(true); }} className="bg-red-600 text-white px-4 py-2 rounded-2xl text-sm font-bold hover:bg-red-700">新增</button>
                                </div>
                                <div className="max-h-[500px] overflow-y-auto overflow-x-auto no-scrollbar">
                                    <div className="grid grid-cols-4 gap-2 px-3 py-2 text-[11px] font-bold text-gray-500 whitespace-nowrap min-w-[800px] text-left">
                                        <div>區域編號</div>
                                        <div>區域名稱</div>
                                        <div>操作</div>
                                        <div>紀錄</div>
                                    </div>
                                    <div className="space-y-2">
                                        {areas.length === 0 ? (
                                            <div className="grid grid-cols-4 gap-2 items-center p-3 bg-gray-50 rounded-2xl text-xs whitespace-nowrap min-w-[800px]">
                                                <div className="font-bold text-gray-300">—</div>
                                                <div className="text-gray-300">—</div>
                                                <div className="flex gap-2 justify-start">
                                                    <button disabled className="px-2 py-1 rounded-2xl bg-gray-200 text-gray-400">編輯</button>
                                                    <button disabled className="px-2 py-1 rounded-2xl bg-gray-200 text-gray-400">刪除</button>
                                                </div>
                                                <div className="text-gray-300">—</div>
                                            </div>
                                        ) : areas.map(a => (
                                            <div key={a.id} className="grid grid-cols-4 gap-2 items-center p-3 bg-gray-50 rounded-2xl text-xs whitespace-nowrap min-w-[800px]">
                                                <div className="font-bold text-gray-700">{a.id}</div>
                                                <div className="text-gray-700">{a.name}</div>
                                                <div className="flex gap-2 justify-start">
                                                <button onClick={()=>{ setAreaForm({ id: a.id, name: a.name }); setShowAreaModal(true); }} className="px-2 py-1 rounded-2xl bg-gray-800 text-white">編輯</button>
                                                <button onClick={()=>{ setConfirmDelete({ type:'area', id:a.id, label:a.name }); }} className="px-2 py-1 rounded-2xl bg-red-600 text-white">刪除</button>
                                                </div>
                                                <div className="text-gray-700">{a.updatedByName ? `${a.updatedByName} ${formatDateTime(a.updatedAt)}` : '-'}</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                {showAreaModal && (
                                    <div className="fixed inset-0 z-[60] bg-black/40 flex items-center justify-center">
                                        <div className="bg-white rounded-2xl shadow-xl w-[90%] max-w-md p-6 max-h-[90vh] overflow-y-auto">
                                            <h4 className="text-lg font-bold text-gray-800 mb-4">新增/編輯區域</h4>
                                            <div className="space-y-3">
                                                <label className="block text-xs font-bold text-gray-500 uppercase">區域編號</label>
                                                <input className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm focus:ring-2 focus:ring-red-100" value={areaForm.id} onChange={e=>setAreaForm(prev=>({...prev, id: e.target.value}))} />
                                                <label className="block text-xs font-bold text-gray-500 uppercase">區域名稱</label>
                                                <input className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm focus:ring-2 focus:ring-red-100" value={areaForm.name} onChange={e=>setAreaForm(prev=>({...prev, name: e.target.value}))} />
                                                {areaError && <div className="text-xs text-red-600">{areaError}</div>}
                                            </div>
                                            <div className="flex justify-end gap-2 mt-4">
                                                <button onClick={()=>setShowAreaModal(false)} className="px-3 py-2 rounded-2xl bg-gray-100 text-gray-700">取消</button>
                                                <button disabled={areaSaving} onClick={async()=>{ try { setAreaError(''); setAreaSaving(true); if (!user) { setAreaError('沒有登入權限，請先登入'); return; } if (!areaForm.id.trim() || !areaForm.name.trim()) { setAreaError('請輸入區域編號與區域名稱'); return; } if (areas.find(x=>x.id===areaForm.id.trim())) { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'areas', areaForm.id.trim()), { name: areaForm.name.trim(), updatedByName: (currentUser && currentUser.name) || (user && user.email) || '', updatedAt: serverTimestamp() }); setToast('儲存成功'); } else { await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'areas', areaForm.id.trim()), { name: areaForm.name.trim(), updatedByName: '新增', updatedAt: serverTimestamp() }); setToast('新增成功'); } setShowAreaModal(false); } catch (e) { console.error(e); setAreaError(`儲存失敗：${e.code || e.message}`); } finally { setAreaSaving(false);} }} className="px-3 py-2 rounded-2xl bg-red-600 text-white">儲存</button>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                        )}
                        {subtab === 'account' && (
                        <>
                        <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                            <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                <Users className="w-5 h-5 mr-2 text-red-600" />
                                帳號列表
                            </h3>
                            <div className="mb-4">
                                <button onClick={()=>{ setEditingUserId(null); setModalUser({ role:'admin', title:'', name:'', email:'', phone:'', communityIds:[], companyIds:[], avatarUrl:'' }); setShowAddModal(true); }} className="bg-red-600 text-white px-4 py-2 rounded-2xl text-sm font-bold hover:bg-red-700">新增</button>
                            </div>
                            <div className="h-[calc(100vh-280px)] overflow-y-auto overflow-x-auto no-scrollbar">
                                <div className="grid grid-cols-[100px_60px_100px_100px_220px_100px_120px_150px_250px_80px_140px_1fr] gap-2 px-3 py-2 text-[11px] font-bold text-gray-500 whitespace-nowrap min-w-[1750px] text-left">
                                    <div>角色</div>
                                    <div>大頭照</div>
                                    <div>職稱</div>
                                    <div>姓名</div>
                                    <div>電子郵件</div>
                                    <div>密碼</div>
                                    <div>手機號碼</div>
                                    <div>所屬公司</div>
                                    <div>服務社區</div>
                                    <div>狀況</div>
                                    <div>操作</div>
                                    <div>紀錄</div>
                                </div>
                                <div className="space-y-2">
                                    {users.map(u => (
                                        <div key={u.id} className="grid grid-cols-[100px_60px_100px_100px_220px_100px_120px_150px_250px_80px_140px_1fr] gap-2 items-center p-3 bg-gray-50 rounded-2xl text-xs whitespace-nowrap min-w-[1750px]">
                                            <div className="font-bold text-gray-700">
                                                {u.role === 'admin' ? '系統管理員' : (roles.find(r => r.id === u.role)?.name || u.role)}
                                            </div>
                                            <div className="flex items-center">
                                                {u.avatarUrl ? (
                                                    <img src={u.avatarUrl} alt="avatar" className="max-w-8 max-h-8 rounded-full" />
                                                ) : (
                                                    <div className="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-xs font-bold text-gray-700">{(u.name || '?').charAt(0)}</div>
                                                )}
                                            </div>
                                            <div className="text-gray-700">{u.title || '-'}</div>
                                            <div className="font-bold text-gray-700">{u.name || '-'}</div>
                                            <div className="text-gray-700">{u.email || '-'}</div>
                                            <div className="text-gray-500 font-mono">{u.password || '-'}</div>
                                            <div className="text-gray-700">{u.phone || '-'}</div>
                                            <div className="text-gray-700">
                                                {(function(){ 
                                                    const ids = u.companyIds || (u.companyId ? [u.companyId] : []);
                                                    if (ids.length === 0) return '-';
                                                    return ids.map(id => {
                                                        const c = companies.find(c => c.id === id);
                                                        return c ? c.name : id;
                                                    }).join('、');
                                                })()}
                                            </div>
                                            <div className="text-gray-700">
                                                {(function(){ 
                                                    const ids = u.communityIds || (u.communityId ? [u.communityId] : []);
                                                    if (ids.length === 0) return '-';
                                                    const text = ids.map(id => {
                                                        const c = communities.find(c => c.id === id);
                                                        return c ? c.name : id;
                                                    }).join('、');
                                                    return text.length > 10 ? text.substring(0, 10) + '...' : text;
                                                })()}
                                            </div>
                                            <div className="text-gray-700">{u.status || '在職'}</div>
                                            <div className="flex gap-2 justify-start">
                                                <button onClick={()=>{ setEditingUserId(u.id); setModalUser({ role: u.role || 'staff', title: u.title || '', name: u.name || '', email: u.email || '', phone: u.phone || '', communityIds: u.communityIds || (u.communityId ? [u.communityId] : []), companyIds: u.companyIds || (u.companyId ? [u.companyId] : []), avatarUrl: u.avatarUrl || '' }); setShowAddModal(true); }} className="px-2 py-1 rounded-2xl bg-gray-800 text-white">編輯</button>
                                                <button onClick={()=>{ setConfirmDelete({ type:'user', id:u.id, label:u.name || u.email || u.id }); }} className="px-2 py-1 rounded-2xl bg-red-600 text-white">刪除</button>
                                            </div>
                                            <div className="text-gray-700">{u.updatedByName ? `${u.updatedByName} ${formatDateTime(u.updatedAt)}` : '-'}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                            {showAddModal && (
                                <div className="fixed inset-0 z-[60] bg-black/40 flex items-center justify-center">
                                    <div className="bg-white rounded-2xl shadow-xl w-[90%] max-w-md p-6 max-h-[90vh] overflow-y-auto">
                                        <h4 className="text-lg font-bold text-gray-800 mb-4">新增/編輯人員</h4>
                                        <div className="space-y-3">
                                            <label className="block text-xs font-bold text-gray-500 uppercase">角色</label>
                                            <select className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm focus:ring-2 focus:ring-red-100" value={modalUser.role} onChange={e=>setModalUser(prev=>({...prev, role: e.target.value}))}>
                                                <option value="admin">系統管理員</option>
                                                {roles.filter(r => r.name !== '系統管理員').map(r => (
                                                    <option key={r.id} value={r.id}>{r.name}</option>
                                                ))}
                                            </select>
                                            <label className="block text-xs font-bold text-gray-500 uppercase">大頭照</label>
                                            <input type="file" accept="image/*" onChange={(e)=>handleAvatarUpload(e.target.files?.[0])} />
                                            {modalUser.avatarUrl && <img src={modalUser.avatarUrl} alt="preview" className="w-8 h-8 rounded-full" />}
                                            <label className="block text-xs font-bold text-gray-500 uppercase">職稱</label>
                                            <input className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm focus:ring-2 focus:ring-red-100" value={modalUser.title} onChange={e=>setModalUser(prev=>({...prev, title: e.target.value}))} />
                                            <label className="block text-xs font-bold text-gray-500 uppercase">姓名</label>
                                            <input className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm focus:ring-2 focus:ring-red-100" value={modalUser.name} onChange={e=>setModalUser(prev=>({...prev, name: e.target.value}))} />
                                            <label className="block text-xs font-bold text-gray-500 uppercase">電子郵件（預設帳號）</label>
                                            <input className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm focus:ring-2 focus:ring-red-100" value={modalUser.email} onChange={e=>setModalUser(prev=>({...prev, email: e.target.value}))} />
                                            <label className="block text-xs font-bold text-gray-500 uppercase">手機號碼</label>
                                            <input className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm focus:ring-2 focus:ring-red-100" value={modalUser.phone} onChange={e=>setModalUser(prev=>({...prev, phone: e.target.value}))} />
                                            <label className="block text-xs font-bold text-gray-500 uppercase">密碼</label>
                                            <input className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm focus:ring-2 focus:ring-red-100" value={modalUser.password || ''} onChange={e=>setModalUser(prev=>({...prev, password: e.target.value}))} placeholder={editingUserId ? "若不修改請留空" : "預設: 123456"} />
                                            <label className="block text-xs font-bold text-gray-500 uppercase">所屬公司</label>
                                            <div className="space-y-2 border border-gray-200 rounded-2xl p-3 max-h-40 overflow-y-auto bg-gray-50">
                                                {['admin', 'manager'].includes(modalUser.role) && (
                                                <div className="flex items-center gap-2 pb-2 border-b border-gray-200">
                                                    <label className="flex items-center gap-2 text-xs font-bold text-red-600 cursor-pointer select-none">
                                                        <input type="checkbox" 
                                                            className="w-4 h-4 text-red-600 rounded-2xl focus:ring-red-500"
                                                            checked={companies.length > 0 && modalUser.companyIds?.length === companies.length}
                                                            onChange={(e) => {
                                                                if (e.target.checked) {
                                                                    setModalUser(prev => ({ ...prev, companyIds: companies.map(c => c.id) }));
                                                                } else {
                                                                    setModalUser(prev => ({ ...prev, companyIds: [] }));
                                                                }
                                                            }}
                                                        />
                                                        全選
                                                    </label>
                                                </div>
                                                )}
                                                {companies.map(c => (
                                                    <label key={c.id} className="flex items-center gap-2 text-sm cursor-pointer select-none hover:bg-gray-100 p-1 rounded-2xl">
                                                        <input type="checkbox" 
                                                            className="w-4 h-4 text-red-600 rounded-2xl focus:ring-red-500"
                                                            checked={modalUser.companyIds?.includes(c.id)}
                                                            onChange={(e) => {
                                                                const checked = e.target.checked;
                                                                const canMulti = ['admin', 'manager'].includes(modalUser.role);
                                                                setModalUser(prev => {
                                                                    const currentIds = prev.companyIds || [];
                                                                    let newIds;
                                                                    if (checked) {
                                                                        if (canMulti) {
                                                                            newIds = [...currentIds, c.id];
                                                                        } else {
                                                                            newIds = [c.id];
                                                                        }
                                                                    } else {
                                                                        newIds = currentIds.filter(id => id !== c.id);
                                                                    }
                                                                    return { ...prev, companyIds: newIds };
                                                                });
                                                            }}
                                                        />
                                                        <span className="text-gray-700">[{c.id}] {c.name}</span>
                                                    </label>
                                                ))}
                                            </div>
                                            <label className="block text-xs font-bold text-gray-500 uppercase">服務社區</label>
                                            <div className="space-y-2 border border-gray-200 rounded-2xl p-3 max-h-40 overflow-y-auto bg-gray-50">
                                                <div className="flex items-center gap-2 pb-2 border-b border-gray-200">
                                                    <label className="flex items-center gap-2 text-xs font-bold text-red-600 cursor-pointer select-none">
                                                        <input type="checkbox" 
                                                            className="w-4 h-4 text-red-600 rounded-2xl focus:ring-red-500"
                                                            checked={communities.length > 0 && modalUser.communityIds?.length === communities.length}
                                                            onChange={(e) => {
                                                                if (e.target.checked) {
                                                                    setModalUser(prev => ({ ...prev, communityIds: communities.map(c => c.id) }));
                                                                } else {
                                                                    setModalUser(prev => ({ ...prev, communityIds: [] }));
                                                                }
                                                            }}
                                                        />
                                                        全選
                                                    </label>
                                                    <label className="flex items-center gap-2 text-xs font-bold text-gray-600 cursor-pointer select-none">
                                                        <input 
                                                            type="checkbox" 
                                                            className="w-4 h-4 text-gray-600 rounded-2xl focus:ring-gray-500" 
                                                            checked={communities.some(c => c.id.startsWith('A')) && communities.filter(c => c.id.startsWith('A')).every(c => modalUser.communityIds?.includes(c.id))}
                                                            onChange={(e) => {
                                                                const checked = e.target.checked;
                                                                const targetIds = communities.filter(c => c.id.startsWith('A')).map(c => c.id);
                                                                setModalUser(prev => {
                                                                    const currentIds = prev.communityIds || [];
                                                                    let newIds;
                                                                    if (checked) {
                                                                        newIds = [...new Set([...currentIds, ...targetIds])];
                                                                    } else {
                                                                        newIds = currentIds.filter(id => !targetIds.includes(id));
                                                                    }
                                                                    return { ...prev, communityIds: newIds };
                                                                });
                                                            }}
                                                        /> A
                                                    </label>
                                                    <label className="flex items-center gap-2 text-xs font-bold text-gray-600 cursor-pointer select-none">
                                                        <input 
                                                            type="checkbox" 
                                                            className="w-4 h-4 text-gray-600 rounded-2xl focus:ring-gray-500" 
                                                            checked={communities.some(c => c.id.startsWith('B')) && communities.filter(c => c.id.startsWith('B')).every(c => modalUser.communityIds?.includes(c.id))}
                                                            onChange={(e) => {
                                                                const checked = e.target.checked;
                                                                const targetIds = communities.filter(c => c.id.startsWith('B')).map(c => c.id);
                                                                setModalUser(prev => {
                                                                    const currentIds = prev.communityIds || [];
                                                                    let newIds;
                                                                    if (checked) {
                                                                        newIds = [...new Set([...currentIds, ...targetIds])];
                                                                    } else {
                                                                        newIds = currentIds.filter(id => !targetIds.includes(id));
                                                                    }
                                                                    return { ...prev, communityIds: newIds };
                                                                });
                                                            }}
                                                        /> B
                                                    </label>
                                                    <label className="flex items-center gap-2 text-xs font-bold text-gray-600 cursor-pointer select-none">
                                                        <input 
                                                            type="checkbox" 
                                                            className="w-4 h-4 text-gray-600 rounded-2xl focus:ring-gray-500" 
                                                            checked={communities.some(c => c.id.startsWith('C')) && communities.filter(c => c.id.startsWith('C')).every(c => modalUser.communityIds?.includes(c.id))}
                                                            onChange={(e) => {
                                                                const checked = e.target.checked;
                                                                const targetIds = communities.filter(c => c.id.startsWith('C')).map(c => c.id);
                                                                setModalUser(prev => {
                                                                    const currentIds = prev.communityIds || [];
                                                                    let newIds;
                                                                    if (checked) {
                                                                        newIds = [...new Set([...currentIds, ...targetIds])];
                                                                    } else {
                                                                        newIds = currentIds.filter(id => !targetIds.includes(id));
                                                                    }
                                                                    return { ...prev, communityIds: newIds };
                                                                });
                                                            }}
                                                        /> C
                                                    </label>
                                                </div>
                                                {communities.map(c => (
                                                    <label key={c.id} className="flex items-center gap-2 text-sm cursor-pointer select-none hover:bg-gray-100 p-1 rounded-2xl">
                                                        <input type="checkbox" 
                                                            className="w-4 h-4 text-red-600 rounded-2xl focus:ring-red-500"
                                                            checked={modalUser.communityIds?.includes(c.id)}
                                                            onChange={(e) => {
                                                                const checked = e.target.checked;
                                                                setModalUser(prev => {
                                                                    const currentIds = prev.communityIds || [];
                                                                    let newIds;
                                                                    if (checked) {
                                                                        newIds = [...currentIds, c.id];
                                                                    } else {
                                                                        newIds = currentIds.filter(id => id !== c.id);
                                                                    }
                                                                    return { ...prev, communityIds: newIds };
                                                                });
                                                            }}
                                                        />
                                                        <span className="text-gray-700">[{c.id}] {c.name}</span>
                                                    </label>
                                                ))}
                                            </div>
                                        </div>
                                            {userError && <div className="text-xs text-red-600">{userError}</div>}
                                            <div className="flex justify-end gap-2 mt-4">
                                                <button onClick={()=>{ setShowAddModal(false); setEditingUserId(null); }} className="px-3 py-2 rounded-2xl bg-gray-100 text-gray-700">取消</button>
                                                <button disabled={userSaving} onClick={async()=>{ try { setUserError(''); setUserSaving(true); if (!user) { setUserError('沒有登入權限，請先登入'); return; } const userDataToSave = { ...modalUser, communityId: (modalUser.communityIds && modalUser.communityIds.length > 0) ? modalUser.communityIds[0] : '', companyId: (modalUser.companyIds && modalUser.companyIds.length > 0) ? modalUser.companyIds[0] : '', status: modalUser.status || '在職' }; if (editingUserId && !userDataToSave.password) { delete userDataToSave.password; } if (editingUserId) { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', editingUserId), { ...userDataToSave, updatedByName: (currentUser && currentUser.name) || (user && user.email) || '', updatedAt: serverTimestamp() }); setToast('儲存成功'); } else { await onAddUser(userDataToSave); setToast('新增成功'); } setShowAddModal(false); setEditingUserId(null); setModalUser({ role:'admin', title:'', name:'', email:'', phone:'', communityIds:[], companyIds:[], avatarUrl:'' }); } catch(e) { handleFetchError(e, 'save_user'); setUserError(`儲存失敗：${e.code || e.message}`); } finally { setUserSaving(false);} }} className="px-3 py-2 rounded-2xl bg-red-600 text-white">儲存</button>
                                            </div>
                                    </div>
                                </div>
                            )}
                        </div>
                        {confirmDelete && (
                            <div className="fixed inset-0 z-[70] bg-black/40 flex items-center justify-center">
                                <div className="bg-white rounded-2xl shadow-xl w-[90%] max-w-sm p-6 max-h-[90vh] overflow-y-auto">
                                    <div className="text-sm text-gray-700 mb-4">確認刪除{confirmDelete.type==='role'?'角色':confirmDelete.type==='company'?'公司':confirmDelete.type==='area'?'區域':confirmDelete.type==='community'?'社區':'人員'}「{confirmDelete.label}」？</div>
                                    <div className="flex justify-end gap-2">
                                        <button onClick={()=>setConfirmDelete(null)} className="px-3 py-2 rounded-2xl bg-gray-100 text-gray-700">取消</button>
                                        <button onClick={async()=>{ try { if (confirmDelete.type==='role') { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'roles', confirmDelete.id)); } else if (confirmDelete.type==='company') { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'companies', confirmDelete.id)); } else if (confirmDelete.type==='area') { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'areas', confirmDelete.id)); } else if (confirmDelete.type==='community') { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'communities', confirmDelete.id)); } else if (confirmDelete.type==='user') { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', confirmDelete.id)); } setConfirmDelete(null); setToast('刪除成功'); } catch(e) { console.error(e); setConfirmDelete(null);} }} className="px-3 py-2 rounded-2xl bg-red-600 text-white">刪除</button>
                                    </div>
                                </div>
                            </div>
                        )}
                        {toast && (
                            <div className="fixed top-[10vh] left-1/2 -translate-x-1/2 z-[75] bg-black/70 text-white text-xs px-3 py-2 rounded-2xl">{toast}</div>
                        )}
                        </>
                        )}

                        {subtab === 'community' && (
                        <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                            <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                <Building2 className="w-5 h-5 mr-2 text-red-600" />
                                社區列表
                            </h3>
                            <div className="mb-4 flex gap-2">
                                    <button onClick={()=>{ setCommunityForm({ id:'', name:'', companyId:'', areaId:'', gmCount:0, secretaryCount:0, cleanCount:0, mechCount:0, guardCount:0, dayGuardCount:0, nightGuardCount:0, address:'', coordLat:'', coordLng:'', radiusMeters:100 }); setShowCommunityModal(true); }} className="bg-red-600 text-white px-4 py-2 rounded-2xl text-sm font-bold hover:bg-red-700">新增</button>
                                    <button onClick={handleExportCommunities} className="bg-green-600 text-white px-4 py-2 rounded-2xl text-sm font-bold hover:bg-green-700">匯出</button>
                                    <label className="bg-blue-600 text-white px-4 py-2 rounded-2xl text-sm font-bold hover:bg-blue-700 cursor-pointer flex items-center">
                                        匯入
                                        <input type="file" accept=".xlsx, .xls" className="hidden" onChange={handleImportCommunities} />
                                    </label>
                                </div>
                                <div className="h-[calc(100vh-280px)] overflow-y-auto overflow-x-auto no-scrollbar">
                                <div className="flex flex-row gap-2 px-3 py-2 text-[11px] font-bold text-gray-500 whitespace-nowrap min-w-[1820px] text-left">
                                    <div className="w-[120px]">社區編號</div>
                                    <div className="w-[160px]">社區名稱</div>
                                    <div className="w-[140px]">所屬公司</div>
                                    <div className="w-[120px]">所屬區域</div>
                                    <div className="w-[80px]">總幹事數</div>
                                    <div className="w-[80px]">秘書數</div>
                                    <div className="w-[80px]">清潔數</div>
                                    <div className="w-[80px]">機電數</div>
                                    <div className="w-[80px]">保全數</div>
                                    <div className="w-[80px]">白天哨數</div>
                                    <div className="w-[80px]">晚上哨數</div>
                                    <div className="w-[200px]">社區地址</div>
                                    <div className="w-[160px]">社區座標</div>
                                    <div className="w-[120px]">社區地圖</div>
                                    <div className="w-[140px]">設定打卡範圍(公尺)</div>
                                    <div className="w-[160px]">操作</div>
                                    <div className="w-[220px]">紀錄</div>
                                </div>
                                <div className="space-y-2">
                                    {communities.map(c => {
                                        const companyName = (function(){ const cm = companies.find(x=>x.id === c.companyId); return cm ? cm.name : '-'; })();
                                        const areaName = (function(){ const ar = areas.find(x=>x.id === c.areaId); return ar ? ar.name : '-'; })();
                                        const coord = (c.coordLat && c.coordLng) ? `${c.coordLat}, ${c.coordLng}` : '-';
                                        return (
                                            <div key={c.id} className="flex flex-row gap-2 items-center p-3 bg-gray-50 rounded-2xl text-xs whitespace-nowrap min-w-[1820px]">
                                                <div className="w-[120px] font-bold text-gray-700">{c.id}</div>
                                                <div className="w-[160px] text-gray-700">{c.name || '-'}</div>
                                                <div className="w-[140px] text-gray-700">{companyName}</div>
                                                <div className="w-[120px] text-gray-700">{areaName}</div>
                                                <div className="w-[80px] text-gray-700">{c.gmCount || 0}</div>
                                                <div className="w-[80px] text-gray-700">{c.secretaryCount || 0}</div>
                                                <div className="w-[80px] text-gray-700">{c.cleanCount || 0}</div>
                                                <div className="w-[80px] text-gray-700">{c.mechCount || 0}</div>
                                                <div className="w-[80px] text-gray-700">{c.guardCount || 0}</div>
                                                <div className="w-[80px] text-gray-700">{c.dayGuardCount || 0}</div>
                                                <div className="w-[80px] text-gray-700">{c.nightGuardCount || 0}</div>
                                                <div className="w-[200px] text-gray-700">{c.address || '-'}</div>
                                                <div className="w-[160px] text-gray-700">{coord}</div>
                                                <div className="w-[120px]">
                                                    <button onClick={()=>{ if (c.coordLat && c.coordLng) { setMapTarget({ name: c.name, lat: parseFloat(c.coordLat), lng: parseFloat(c.coordLng), radius: c.radiusMeters || 0 }); } }} className="px-2 py-1 rounded-2xl bg-gray-800 text-white">社區地圖</button>
                                                </div>
                                                <div className="w-[140px] text-gray-700">{c.radiusMeters || 0}</div>
                                                <div className="w-[160px] flex gap-2 justify-start">
                                                    <button onClick={()=>{ setCommunityForm({ id:c.id, name:c.name || '', companyId:c.companyId || '', areaId:c.areaId || '', gmCount:c.gmCount || 0, secretaryCount:c.secretaryCount || 0, cleanCount:c.cleanCount || 0, mechCount:c.mechCount || 0, guardCount:c.guardCount || 0, dayGuardCount:c.dayGuardCount || 0, nightGuardCount:c.nightGuardCount || 0, address:c.address || '', coordLat:c.coordLat || '', coordLng:c.coordLng || '', radiusMeters:c.radiusMeters || 100 }); setShowCommunityModal(true); }} className="px-2 py-1 rounded-2xl bg-gray-800 text-white">編輯</button>
                                                    <button onClick={()=>{ setConfirmDelete({ type:'community', id:c.id, label:c.name || c.id }); }} className="px-2 py-1 rounded-2xl bg-red-600 text-white">刪除</button>
                                                </div>
                                                <div className="w-[220px] text-gray-700">{c.updatedByName ? `${c.updatedByName} ${formatDateTime(c.updatedAt)}` : '-'}</div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                            {showCommunityModal && (
                                <div className="fixed inset-0 z-[60] bg-black/40 flex items-center justify-center">
                                    <div className="bg-white rounded-2xl shadow-xl w-[90%] max-w-md p-6 max-h-[90vh] overflow-y-auto">
                                        <h4 className="text-lg font-bold text-gray-800 mb-4">新增/編輯社區</h4>
                                        <div className="space-y-3">
                                            <label className="block text-xs font-bold text-gray-500 uppercase">社區編號</label>
                                            <input className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm focus:ring-2 focus:ring-red-100" value={communityForm.id} onChange={e=>setCommunityForm(prev=>({...prev, id: e.target.value}))} />
                                            <label className="block text-xs font-bold text-gray-500 uppercase">社區名稱</label>
                                            <input className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm focus:ring-2 focus:ring-red-100" value={communityForm.name} onChange={e=>setCommunityForm(prev=>({...prev, name: e.target.value}))} />
                                            <label className="block text-xs font-bold text-gray-500 uppercase">所屬公司</label>
                                            <select className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm focus:ring-2 focus:ring-red-100" value={communityForm.companyId} onChange={e=>setCommunityForm(prev=>({...prev, companyId: e.target.value}))}>
                                                <option value="">選擇公司</option>
                                                {companies.map(cm => <option key={cm.id} value={cm.id}>{cm.name}</option>)}
                                            </select>
                                            <label className="block text-xs font-bold text-gray-500 uppercase">所屬區域</label>
                                            <select className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm focus:ring-2 focus:ring-red-100" value={communityForm.areaId} onChange={e=>setCommunityForm(prev=>({...prev, areaId: e.target.value}))}>
                                                <option value="">選擇區域</option>
                                                {areas.map(ar => <option key={ar.id} value={ar.id}>{ar.name}</option>)}
                                            </select>
                                            <div className="grid grid-cols-2 gap-2">
                                                <div>
                                                    <label className="block text-xs font-bold text-gray-500 uppercase">總幹事數</label>
                                                    <input type="number" className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm" value={communityForm.gmCount} onChange={e=>setCommunityForm(prev=>({...prev, gmCount: parseInt(e.target.value||'0',10)}))} />
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-bold text-gray-500 uppercase">秘書數</label>
                                                    <input type="number" className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm" value={communityForm.secretaryCount} onChange={e=>setCommunityForm(prev=>({...prev, secretaryCount: parseInt(e.target.value||'0',10)}))} />
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-bold text-gray-500 uppercase">清潔數</label>
                                                    <input type="number" className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm" value={communityForm.cleanCount} onChange={e=>setCommunityForm(prev=>({...prev, cleanCount: parseInt(e.target.value||'0',10)}))} />
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-bold text-gray-500 uppercase">機電數</label>
                                                    <input type="number" className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm" value={communityForm.mechCount} onChange={e=>setCommunityForm(prev=>({...prev, mechCount: parseInt(e.target.value||'0',10)}))} />
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-bold text-gray-500 uppercase">保全數</label>
                                                    <input type="number" className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm" value={communityForm.guardCount} onChange={e=>setCommunityForm(prev=>({...prev, guardCount: parseInt(e.target.value||'0',10)}))} />
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-bold text-gray-500 uppercase">白天哨數</label>
                                                    <input type="number" className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm" value={communityForm.dayGuardCount} onChange={e=>setCommunityForm(prev=>({...prev, dayGuardCount: parseInt(e.target.value||'0',10)}))} />
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-bold text-gray-500 uppercase">晚上哨數</label>
                                                    <input type="number" className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm" value={communityForm.nightGuardCount} onChange={e=>setCommunityForm(prev=>({...prev, nightGuardCount: parseInt(e.target.value||'0',10)}))} />
                                                </div>
                                            </div>
                                            <label className="block text-xs font-bold text-gray-500 uppercase">社區地址</label>
                                            <input className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm" value={communityForm.address} onChange={e=>setCommunityForm(prev=>({...prev, address: e.target.value}))} onBlur={async(e)=>{ const addr = e.target.value.trim(); if (!addr) return; try { if (window.google && window.google.maps) { const gc = new google.maps.Geocoder(); gc.geocode({ address: addr }, (res, status)=>{ if (status === 'OK' && res && res[0]) { const loc = res[0].geometry.location; setCommunityForm(prev=>({...prev, coordLat: loc.lat(), coordLng: loc.lng()})); } }); } else { const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(addr)}`); const d = await r.json(); if (d && d[0]) { setCommunityForm(prev=>({...prev, coordLat: d[0].lat, coordLng: d[0].lon})); } } } catch {} }} />
                                            <div className="grid grid-cols-2 gap-2">
                                                <div className="col-span-2">
                                                    <label className="block text-xs font-bold text-gray-500 uppercase">社區座標（緯度, 經度）</label>
                                                    <input className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm" placeholder="例如：25.0330, 121.5654" value={(communityForm.coordLat!=='' && communityForm.coordLng!=='') ? `${communityForm.coordLat}, ${communityForm.coordLng}` : ''} onChange={e=>{ const v = e.target.value; const parts = v.split(','); if (parts.length >= 2) { const lat = parts[0].trim(); const lng = parts[1].trim(); setCommunityForm(prev=>({...prev, coordLat: lat, coordLng: lng})); } else { setCommunityForm(prev=>({...prev, coordLat: v.trim(), coordLng: prev.coordLng})); } }} />
                                                </div>
                                                <div className="col-span-2">
                                                    <label className="block text-xs font-bold text-gray-500 uppercase">設定打卡範圍(公尺)</label>
                                                    <input type="number" className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm" value={communityForm.radiusMeters} onChange={e=>setCommunityForm(prev=>({...prev, radiusMeters: parseInt(e.target.value||'0',10)}))} />
                                                </div>
                                            </div>
                                            <div className="mt-3">
                                                <div ref={communityMapElRef} className="w-full h-48 rounded-2xl border"></div>
                                            </div>
                                            {communityError && <div className="text-xs text-red-600">{communityError}</div>}
                                        </div>
                                        <div className="flex justify-end gap-2 mt-4">
                                            <button onClick={()=>setShowCommunityModal(false)} className="px-3 py-2 rounded-2xl bg-gray-100 text-gray-700">取消</button>
                                            <button disabled={communitySaving} onClick={async()=>{ try { setCommunityError(''); setCommunitySaving(true); if (!user) { setCommunityError('沒有登入權限，請先登入'); return; } const id = (communityForm.id || '').trim(); const name = (communityForm.name || '').trim(); if (!name) { setCommunityError('請輸入社區名稱'); return; } const latNum = communityForm.coordLat !== '' && communityForm.coordLat != null ? parseFloat(communityForm.coordLat) : undefined; const lngNum = communityForm.coordLng !== '' && communityForm.coordLng != null ? parseFloat(communityForm.coordLng) : undefined; const payload = { name, companyId: communityForm.companyId || '', areaId: communityForm.areaId || '', gmCount: communityForm.gmCount||0, secretaryCount: communityForm.secretaryCount||0, cleanCount: communityForm.cleanCount||0, mechCount: communityForm.mechCount||0, guardCount: communityForm.guardCount||0, dayGuardCount: communityForm.dayGuardCount||0, nightGuardCount: communityForm.nightGuardCount||0, address: communityForm.address||'', coordLat: latNum, coordLng: lngNum, radiusMeters: communityForm.radiusMeters||0, updatedByName: (currentUser && currentUser.name) || (user && user.email) || '', updatedAt: serverTimestamp() }; if (id) { await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'communities', id), payload, { merge: true }); setToast(communities.find(x=>x.id===id)?'儲存成功':'新增成功'); } else { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'communities'), { ...payload, updatedByName: '新增' }); setToast('新增成功'); } setShowCommunityModal(false); } catch(e) { console.error(e); setCommunityError(`儲存失敗：${e.code || e.message}`); } finally { setCommunitySaving(false);} }} className="px-3 py-2 rounded-2xl bg-red-600 text-white">儲存</button>
                                        </div>
                                    </div>
                                </div>
                            )}
                            {mapTarget && (
                                <div className="fixed inset-0 z-[60] bg-black/40 flex items-center justify-center">
                                    <div className="bg-white rounded-2xl shadow-xl w-[90%] max-w-md p-6 max-h-[90vh] overflow-y-auto">
                                        <h4 className="text-lg font-bold text-gray-800 mb-4">{mapTarget.name || '社區地圖'}</h4>
                                        <div ref={mapTargetElRef} className="w-full h-80 rounded-2xl border"></div>
                                        <div className="flex justify-end gap-2 mt-4">
                                            <button onClick={()=>setMapTarget(null)} className="px-3 py-2 rounded-2xl bg-gray-100 text-gray-700">關閉</button>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                        )}
                    </div>
                </div>
            );
        };

        // 4. Staff Dashboard
        const StaffDashboard = ({ currentUser, onClockIn, attendanceHistory, timeOffset, companies, communities, checkInLocation, setCheckInLocation, setMapPreviewTarget, setPreviewImageUrl, roles = [], hideHeaderInfo = false, mode = 'work' }) => {
            const [currentTime, setCurrentTime] = useState(new Date(Date.now() + (timeOffset || 0)));
            const [showLocationSelector, setShowLocationSelector] = useState(false);
            const [viewDate, setViewDate] = useState(new Date());
            const [currentLocation, setCurrentLocation] = useState(null);
            const [hasLocationSorted, setHasLocationSorted] = useState(false);

            // Robust isCompanyGroup check
            const isCompanyGroup = useMemo(() => {
                if (!currentUser) return false;
                // 1. Check hardcoded IDs
                if (['admin', 'hr', 'cadre'].includes(currentUser.role)) return true;
                // 2. Check Title
                if (currentUser.title && currentUser.title.includes('幹部')) return true;
                // 3. Check Role Name (using passed roles prop)
                const roleObj = roles.find(r => r.id === currentUser.role);
                if (roleObj && (roleObj.name.includes('幹部') || roleObj.name.includes('人事') || roleObj.name.includes('系統管理員'))) return true;
                
                return false;
            }, [currentUser, roles]);

            useEffect(() => {
                const timer = setInterval(() => setCurrentTime(new Date(Date.now() + (timeOffset || 0))), 1000);
                return () => clearInterval(timer);
            }, [timeOffset]);

            // Get Current Location for sorting
            useEffect(() => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (pos) => {
                            setCurrentLocation({
                                lat: pos.coords.latitude,
                                lng: pos.coords.longitude
                            });
                        },
                        (err) => { /* Suppress location sorting error */ },
                        { enableHighAccuracy: false, timeout: 5000, maximumAge: 60000 }
                    );
                }
            }, []);

            // Helper to compare dates
            const isSameDay = (d1, d2) => {
                return d1.getFullYear() === d2.getFullYear() &&
                       d1.getMonth() === d2.getMonth() &&
                       d1.getDate() === d2.getDate();
            };

            // Helper to calculate distance
            const calculateDistance = (lat1, lon1, lat2, lon2) => {
                const R = 6371e3; // metres
                const φ1 = lat1 * Math.PI / 180;
                const φ2 = lat2 * Math.PI / 180;
                const Δφ = (lat2 - lat1) * Math.PI / 180;
                const Δλ = (lon2 - lon1) * Math.PI / 180;
                const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                        Math.cos(φ1) * Math.cos(φ1) *
                        Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return R * c;
            };

            const handlePrevDay = () => {
                const newDate = new Date(viewDate);
                newDate.setDate(viewDate.getDate() - 1);
                setViewDate(newDate);
            };

            const handleNextDay = () => {
                const newDate = new Date(viewDate);
                newDate.setDate(viewDate.getDate() + 1);
                if (newDate <= new Date()) {
                    setViewDate(newDate);
                }
            };

            const isToday = isSameDay(viewDate, new Date());
            
            const filteredHistory = attendanceHistory.filter(record => {
                const seconds = record.timestamp?.seconds || Date.now() / 1000;
                const recordDate = new Date(seconds * 1000);
                return isSameDay(recordDate, viewDate);
            });

            const getAvailableLocations = () => {
                 if (!currentUser) return [];
                 
                 if (isCompanyGroup) {
                     const allCompanies = (companies || []).map(c => ({ ...c, type: 'company' }));
                     const userCompany = allCompanies.find(c => c.id === currentUser.companyId);
                     
                     if (userCompany) {
                         const isTaipei = userCompany.name.includes('台北');
                         const isTaoyuan = userCompany.name.includes('桃園');
                         
                         if (isTaipei) {
                            return allCompanies
                                .filter(c => c.name.includes('台北') || c.name.includes('桃園'))
                                .sort((a, b) => {
                                    if (a.name.includes('台北')) return -1;
                                    if (b.name.includes('台北')) return 1;
                                    return 0;
                                });
                        } else if (isTaoyuan) {
                            return allCompanies
                                .filter(c => c.name.includes('台北') || c.name.includes('桃園'))
                                .sort((a, b) => {
                                    if (a.name.includes('桃園')) return -1;
                                    if (b.name.includes('桃園')) return 1;
                                    return 0;
                                });
                        } else {
                             return allCompanies.sort((a, b) => {
                                 if (a.id === userCompany.id) return -1;
                                 if (b.id === userCompany.id) return 1;
                                 return 0;
                             });
                         }
                     }
                     return allCompanies;
                 } else {
                     const userCommIds = currentUser.communityIds || (currentUser.communityId ? [currentUser.communityId] : []);
                     const userComms = (communities || []).filter(c => userCommIds.includes(c.id)).map(c => ({ 
                         ...c, 
                         type: 'community',
                         lat: c.coordLat, // Map coordLat to lat for CameraModal
                         lng: c.coordLng  // Map coordLng to lng for CameraModal
                     }));
                     
                     if (currentLocation && userComms.length > 1) {
                         return userComms.sort((a, b) => {
                             const latA = parseFloat(a.coordLat);
                             const lngA = parseFloat(a.coordLng);
                             const latB = parseFloat(b.coordLat);
                             const lngB = parseFloat(b.coordLng);
                             
                             if (isNaN(latA) || isNaN(lngA)) return 1;
                             if (isNaN(latB) || isNaN(lngB)) return -1;
                             
                             const distA = calculateDistance(currentLocation.lat, currentLocation.lng, latA, lngA);
                             const distB = calculateDistance(currentLocation.lat, currentLocation.lng, latB, lngB);
                             return distA - distB;
                         });
                     }
                     
                     // Fallback: Sort by ID
                     return userComms.sort((a, b) => a.id.localeCompare(b.id, undefined, {numeric: true}));
                 }
            };
            
            const availableLocations = getAvailableLocations();

            // Initialize CheckIn Location
            useEffect(() => {
                if (!currentUser) return;
                
                if (availableLocations?.length > 0) {
                    if (!checkInLocation) {
                        setCheckInLocation(availableLocations[0]);
                        if (!isCompanyGroup && currentLocation) setHasLocationSorted(true);
                    } else if (!isCompanyGroup && currentLocation && !hasLocationSorted) {
                        // Group 2: Update default to closest if not yet sorted-selected
                        setCheckInLocation(availableLocations[0]);
                        setHasLocationSorted(true);
                    }
                }
            }, [currentUser, companies, communities, checkInLocation, setCheckInLocation, currentLocation, hasLocationSorted, isCompanyGroup]);

            const lastRecord = attendanceHistory[0];
            const isWorking = lastRecord && lastRecord.type === 'in';

            const getButtonConfig = () => {
                if (mode === 'card') {
                    const lastType = lastRecord?.type;
                    const isCardWorking = lastType === 'late_in';
                    
                    return isCardWorking
                        ? { type: 'late_out', text: '卡班下班', sub: '結束卡班勤務', icon: LogOut, colorClass: 'bg-gray-800 text-white border-2 border-gray-700', iconBg: 'bg-gray-700', iconColor: 'text-white' }
                        : { type: 'late_in', text: '卡班上班', sub: '紀錄卡班開始', icon: MapPin, colorClass: 'bg-white text-green-600 border-2 border-green-100', iconBg: 'bg-green-50', iconColor: 'text-green-600' };
                }

                if (mode === 'outing') {
                    const lastType = lastRecord?.type;
                    if (lastType === 'outing_start') {
                        return { type: 'outing_arrive', text: '抵達打卡', sub: '紀錄抵達時間', icon: MapPin, colorClass: 'bg-white text-blue-600 border-2 border-blue-100', iconBg: 'bg-blue-50', iconColor: 'text-blue-600' };
                    } else if (lastType === 'outing_arrive') {
                        return { type: 'outing_end', text: '離開打卡', sub: '紀錄離開時間', icon: LogOut, colorClass: 'bg-white text-blue-600 border-2 border-blue-100', iconBg: 'bg-blue-50', iconColor: 'text-blue-600' };
                    } else {
                        // null or 'outing_end'
                        return { type: 'outing_start', text: '外出打卡', sub: '紀錄外出時間', icon: MapPin, colorClass: 'bg-white text-blue-600 border-2 border-blue-100', iconBg: 'bg-blue-50', iconColor: 'text-blue-600' };
                    }
                }
                
                // Default work mode
                return isWorking 
                    ? { type: 'out', text: '下班簽退', sub: '結束今日勤務', icon: LogOut, colorClass: 'bg-white text-red-600 border-2 border-red-100', iconBg: 'bg-red-50', iconColor: 'text-red-600' }
                    : { type: 'in', text: '上班打卡', sub: '紀錄開始時間', icon: MapPin, colorClass: 'bg-white text-green-600 border-2 border-green-100', iconBg: 'bg-green-50', iconColor: 'text-green-600' };
            };

            const btnConfig = getButtonConfig();
            const BtnIcon = btnConfig.icon;

            const getTypeLabel = (type) => {
                const map = {
                    'in': { text: '上班', color: 'bg-green-100 text-green-700' },
                    'out': { text: '下班', color: 'bg-red-100 text-red-700' },
                    'outing_start': { text: '外出', color: 'bg-blue-100 text-blue-700' },
                    'outing_arrive': { text: '抵達', color: 'bg-blue-100 text-blue-700' },
                    'outing_end': { text: '離開', color: 'bg-blue-100 text-blue-700' },
                    'leave': { text: '請假', color: 'bg-orange-100 text-orange-700' },
                    'late_in': { text: '卡上', color: 'bg-green-100 text-green-700' },
                    'late_out': { text: '卡下', color: 'bg-red-100 text-red-700' }
                };
                return map[type] || { text: type, color: 'bg-gray-100 text-gray-700' };
            };

            // Calculate Header Background
            let headerBgClass = 'bg-gradient-to-br from-gray-600 to-gray-700 shadow-gray-200';
            if (lastRecord?.type) {
                const t = lastRecord.type;
                if (['in', 'late_in'].includes(t)) {
                    headerBgClass = 'bg-gradient-to-br from-green-600 to-green-700 shadow-green-200';
                } else if (['out', 'late_out'].includes(t)) {
                    headerBgClass = 'bg-gradient-to-br from-red-600 to-red-700 shadow-red-200';
                } else if (['outing_start', 'outing_arrive', 'outing_end'].includes(t)) {
                    headerBgClass = 'bg-gradient-to-br from-blue-600 to-blue-700 shadow-blue-200';
                } else if (t === 'leave') {
                    headerBgClass = 'bg-gradient-to-br from-orange-500 to-orange-600 shadow-orange-200';
                }
            }

            return (
                <div className="max-w-md mx-auto space-y-4 pb-20">
                    {/* Header Info Card */}
                    {!hideHeaderInfo && (
                    <div className={`${headerBgClass} rounded-2xl shadow-xl overflow-hidden relative`}>
                        <div className="absolute top-0 right-0 p-4 opacity-10">
                            <Clock className="w-32 h-32 transform rotate-12 text-white" />
                        </div>
                        <div className="p-6 relative z-10 text-white">
                            <div className="flex justify-between items-start mb-6">
                                <div>
                                    <h2 className="text-2xl font-bold">
                                        {(function() {
                                            if (!currentUser) return '';
                                            // 1. Try to find role name from roles list
                                            const roleObj = roles?.find(r => r?.id === currentUser?.role);
                                            if (roleObj) return roleObj.name;
                                            
                                            // 2. Fallback to hardcoded mapping
                                            const roleMap = {
                                                'admin': '系統管理員',
                                                'manager': '總幹事', // or 管理層
                                                'hr': '人事',
                                                'cadre': '幹部',
                                                'staff': '員工',
                                                'secretary': '秘書',
                                                'cleaner': '清潔',
                                                'mechanic': '機電',
                                                'guard': '保全'
                                            };
                                            return roleMap[currentUser.role] || currentUser.role;
                                        })()} {currentUser?.name}
                                    </h2>
                                    <p className="text-white/80 text-sm flex items-center gap-1 mt-1">
                                        <Building2 className="w-4 h-4" />
                                        {(function() {
                                            // Show Last Record Location + Time
                                            if (lastRecord) {
                                                const timeStr = new Date((lastRecord.timestamp?.seconds || Date.now()/1000) * 1000).toLocaleString('zh-TW', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                                                return `${lastRecord.checkInLocationName || lastRecord.address || '未記錄位置'} ${timeStr}`;
                                            }
                                            return '尚無打卡紀錄';
                                        })()}
                                    </p>
                                </div>
                                {(function(){
                                    const lastType = lastRecord?.type;
                                    // Default (No Record)
                                    let statusText = '未打卡';
                                    let statusClass = 'bg-gray-200 text-gray-500';

                                    if (lastType) {
                                        const config = getTypeLabel(lastType);
                                        statusText = config.text;
                                        // Override colors based on user request
                                        if (['in', 'late_in'].includes(lastType)) {
                                            statusClass = 'bg-green-100 text-green-700';
                                        } else if (['out', 'late_out'].includes(lastType)) {
                                            statusClass = 'bg-red-100 text-red-700';
                                        } else if (['outing_start', 'outing_arrive', 'outing_end'].includes(lastType)) {
                                            statusClass = 'bg-blue-100 text-blue-700';
                                        } else if (lastType === 'leave') {
                                            statusClass = 'bg-orange-100 text-orange-700';
                                        } else {
                                            statusClass = config.color;
                                        }
                                    }

                                    return (
                                        <div className={`backdrop-blur-sm px-3 py-1 rounded-full text-2xl font-mono ${statusClass} bg-opacity-90 border-2 border-white/20 shadow-sm`}>
                                            {statusText}
                                        </div>
                                    );
                                })()}
                            </div>
                            <div className="text-center py-4">
                                <div className="text-5xl font-bold font-mono tracking-wider drop-shadow-sm">
                                    {currentTime.toLocaleTimeString('zh-TW', { timeZone: 'Asia/Taipei', hour12: false, hour: '2-digit', minute:'2-digit', second: '2-digit' })}
                                </div>
                                <p className="text-white text-2xl mt-2 opacity-80">
                                    {currentTime.toLocaleDateString('zh-TW', { timeZone: 'Asia/Taipei', year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' })}
                                </p>
                            </div>
                        </div>
                    </div>
                    )}
                    
                    {/* Big Action Button */}
                    <div className="px-2">
                        <button
                            onClick={() => onClockIn(btnConfig.type, availableLocations)}
                            className={`w-full h-32 rounded-2xl flex flex-row items-center justify-center gap-4 shadow-lg transition-all transform active:scale-95 ${btnConfig.colorClass}`}
                        >
                            <div className={`${btnConfig.iconBg} p-3 rounded-full`}>
                                <BtnIcon className={`w-8 h-8 ${btnConfig.iconColor}`} />
                            </div>
                            <div className="text-left">
                                <span className="block text-2xl font-bold">{btnConfig.text}</span>
                                <span className="text-xs opacity-60">{btnConfig.sub}</span>
                            </div>
                        </button>
                    </div>

                    {/* History List */}
                    <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-5">
                        <h3 className="font-bold text-gray-800 mb-4 text-sm flex items-center justify-between">
                            <div className="flex items-center gap-2">
                                <button onClick={handlePrevDay} className="p-1 rounded-full hover:bg-gray-100 text-gray-500">
                                    <ChevronLeft className="w-5 h-5" />
                                </button>
                                <span>{isToday ? '今日打卡紀錄' : `${viewDate.getFullYear()}/${viewDate.getMonth() + 1}/${viewDate.getDate()} 打卡紀錄`}</span>
                                <button 
                                    onClick={handleNextDay} 
                                    disabled={isToday}
                                    className={`p-1 rounded-full hover:bg-gray-100 text-gray-500 ${isToday ? 'opacity-30 cursor-not-allowed' : ''}`}
                                >
                                    <ChevronRight className="w-5 h-5" />
                                </button>
                            </div>
                            <span className="text-xs text-gray-400 font-normal">共 {filteredHistory.length} 筆</span>
                        </h3>
                        <div className="space-y-4">
                            {filteredHistory.length === 0 ? (
                                <div className="text-center py-8">
                                    <div className="bg-gray-50 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-2">
                                        <Calendar className="w-5 h-5 text-gray-300" />
                                    </div>
                                    <p className="text-gray-400 text-xs">尚無打卡紀錄</p>
                                </div>
                            ) : (
                                filteredHistory.map((r, idx) => {
                                    const timeStr = new Date(r.timestamp.seconds * 1000).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
                                    const typeConfig = getTypeLabel(r.type);
                                    return (
                                        <div key={r.id} className="p-3 bg-white border border-gray-100 rounded-2xl shadow-sm flex items-start gap-3">
                                            <div className="w-10 h-10 rounded-full bg-gray-200 flex-shrink-0 overflow-hidden border border-gray-100">
                                                {currentUser.avatarUrl ? (
                                                    <img src={currentUser.avatarUrl} className="w-full h-full object-cover" />
                                                ) : (
                                                    <div className="w-full h-full flex items-center justify-center font-bold text-gray-500">
                                                        {currentUser.name?.[0]}
                                                    </div>
                                                )}
                                            </div>
                                            <div className="flex-1 min-w-0">
                                                <div className="flex justify-between items-center">
                                                    <div>
                                                        <div className="font-bold text-gray-800 flex items-center gap-2">
                                                            {currentUser.name}
                                                            <span className={`text-[10px] px-1.5 py-0.5 rounded-lg ${typeConfig.color}`}>
                                                                {typeConfig.text}
                                                            </span>
                                                        </div>
                                                        <div className="text-xs text-gray-500 mt-0.5 flex items-center gap-1">
                                                            <Clock className="w-3 h-3" /> {timeStr}
                                                        </div>
                                                        <div className="text-xs text-gray-500 mt-0.5 flex items-center gap-1">
                                                            <MapPin className="w-3 h-3" /> {r.checkInLocationName || r.address || '未記錄'}
                                                        </div>
                                                    </div>
                                                    <div className="flex items-center gap-2">
                                                        {(function(){
                                                            const parts = (r.location || '').split(',');
                                                            let mapImgUrl = null;
                                                            if (parts.length === 2) {
                                                                const lat = parts[0];
                                                                const lng = parts[1];
                                                                mapImgUrl = `https://maps.googleapis.com/maps/api/staticmap?center=${lat},${lng}&zoom=15&size=100x100&maptype=roadmap&markers=color:red%7C${lat},${lng}&key=AIzaSyAzhLdWtycJgfz8UsXWlji63DkXpA4kmyY`;
                                                            }
                                                            return (
                                                                <button 
                                                                    onClick={() => {
                                                                        if (parts.length === 2) {
                                                                            setMapPreviewTarget({
                                                                                lat: parseFloat(parts[0]),
                                                                                lng: parseFloat(parts[1]),
                                                                                name: currentUser.name + ' - ' + (r.address || '打卡位置'),
                                                                                radius: 10
                                                                            });
                                                                        } else {
                                                                            alert('無座標資訊: ' + (r.address || ''));
                                                                        }
                                                                    }}
                                                                    className="w-12 h-12 rounded-lg bg-gray-100 text-gray-500 flex items-center justify-center border border-gray-200 hover:opacity-90 transition-opacity overflow-hidden p-0"
                                                                >
                                                                    {mapImgUrl ? (
                                                                        <img src={mapImgUrl} className="w-full h-full object-cover" alt="地圖" />
                                                                    ) : (
                                                                        <MapPin className="w-5 h-5" />
                                                                    )}
                                                                </button>
                                                            );
                                                        })()}
                                                        {r.photoUrl && (
                                                            <div className="w-12 h-12 rounded-lg bg-gray-100 overflow-hidden cursor-pointer border border-gray-200 hover:opacity-90 transition-opacity" onClick={() => setPreviewImageUrl(r.photoUrl)}>
                                                                <img src={r.photoUrl} className="w-full h-full object-cover" />
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })
                            )}
                        </div>
                    </div>
                    {/* Location Selector Modal */}`
                    {showLocationSelector && (
                        <div className="fixed inset-0 z-[100] bg-black/50 flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-xs rounded-2xl shadow-xl overflow-hidden animate-fade-in-up max-h-[80vh] flex flex-col">
                                <div className="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                                    <h3 className="font-bold text-gray-800">選擇打卡地點</h3>
                                    <button onClick={() => setShowLocationSelector(false)} className="p-1 bg-gray-200 rounded-full text-gray-500 hover:bg-gray-300 transition"><X className="w-4 h-4" /></button>
                                </div>
                                <div className="overflow-y-auto p-2">
                                    {availableLocations.map(loc => (
                                        <button
                                            key={loc.id}
                                            onClick={() => {
                                                setCheckInLocation({ id: loc.id, name: loc.name, type: loc.type });
                                                setShowLocationSelector(false);
                                            }}
                                            className={`w-full text-left px-4 py-3 rounded-xl mb-1 flex items-center justify-between ${checkInLocation?.id === loc.id ? 'bg-red-50 text-red-600 font-bold' : 'hover:bg-gray-50 text-gray-700'}`}
                                        >
                                            <span>{loc.name}</span>
                                            {checkInLocation?.id === loc.id && <CheckCircle className="w-4 h-4" />}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // 5. Manager Dashboard
        const ManagerDashboard = ({ currentUser, communities, allAttendance, timeOffset, users = [] }) => {
            const communityLogs = allAttendance.filter(a => {
                // 1. Strict match on communityId (handle string/number differences)
                if (String(a.communityId) === String(currentUser.communityId)) return true;
                
                // 2. Fallback: Check if the user belongs to this community via users list
                if (users.length > 0 && a.userId) {
                    const u = users.find(user => user.id === a.userId);
                    if (u) {
                        // Check communityIds array
                        if (u.communityIds && u.communityIds.some(cid => String(cid) === String(currentUser.communityId))) {
                            return true;
                        }
                        // Check legacy communityId field
                        if (u.communityId && String(u.communityId) === String(currentUser.communityId)) {
                            return true;
                        }
                    }
                }
                return false;
            });
            const today = new Date(Date.now() + (timeOffset || 0)).toLocaleDateString('zh-TW', { timeZone: 'Asia/Taipei' });

            return (
                <div className="space-y-4 pb-20">
                    <div className="grid grid-cols-2 gap-3">
                        <div className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                            <div className="text-gray-400 text-xs mb-1">今日打卡</div>
                            <div className="text-2xl font-bold text-gray-800">
                                {communityLogs.filter(l => l.timestamp && l.timestamp.seconds && new Date(l.timestamp.seconds * 1000).toLocaleDateString('zh-TW', { timeZone: 'Asia/Taipei' }) === today).length}
                                <span className="text-xs text-gray-400 font-normal ml-1">次</span>
                            </div>
                        </div>
                        <div className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                            <div className="text-gray-400 text-xs mb-1">目前在勤</div>
                            <div className="text-2xl font-bold text-red-600">
                                {communityLogs.filter(l => l.type === 'in' && l.timestamp && l.timestamp.seconds && new Date(l.timestamp.seconds * 1000).toLocaleDateString('zh-TW', { timeZone: 'Asia/Taipei' }) === today).length}
                                <span className="text-xs text-gray-400 font-normal ml-1">人</span>
                            </div>
                        </div>
                    </div>

                    <div className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                        <div className="p-4 border-b border-gray-50 bg-gray-50/50 flex justify-between items-center">
                            <h3 className="font-bold text-gray-700 text-sm">即時動態</h3>
                            <span className="text-[10px] px-2 py-1 bg-red-50 text-red-600 rounded-full font-bold">
                                {currentUser.communityName}
                            </span>
                        </div>
                        <div className="divide-y divide-gray-50">
                            {communityLogs.slice(0, 10).map(log => (
                                <div key={log.id} className="p-4 flex items-center justify-between hover:bg-gray-50 transition">
                                    <div className="flex items-center gap-3">
                                        <div className={`w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold text-white ${log.type === 'in' ? 'bg-red-500' : 'bg-gray-400'}`}>
                                            {log.userName.charAt(0)}
                                        </div>
                                        <div>
                                            <div className="text-sm font-bold text-gray-800">{log.userName}</div>
                                            <div className="text-xs text-gray-400">
                                                {log.userRole} · {(function(){
                                                    const typeMap = {
                                                        'in': '上班',
                                                        'out': '下班',
                                                        'outing_start': '外出',
                                                        'outing_arrive': '抵達',
                                                        'outing_end': '離開',
                                                        'leave': '請假',
                                                        'late_in': '卡上',
                                                        'late_out': '卡下'
                                                    };
                                                    return typeMap[log.type] || '未知';
                                                })()}
                                            </div>
                                        </div>
                                    </div>
                                    <div className="text-right">
                                        <div className="text-xs font-mono text-gray-600">
                                            {log.timestamp && log.timestamp.seconds ? new Date(log.timestamp.seconds * 1000).toLocaleTimeString('zh-TW', { timeZone: 'Asia/Taipei', hour12: false, hour: '2-digit', minute:'2-digit' }) : '--:--'}
                                        </div>
                                        {log.type === 'in' && <div className="flex items-center justify-end text-[10px] text-green-500 gap-0.5 mt-0.5"><CheckCircle className="w-2 h-2"/> 正常</div>}
                                    </div>
                                </div>
                            ))}
                            {communityLogs.length === 0 && (
                                <div className="p-8 text-center text-gray-400 text-sm">尚無今日資料</div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // 6. HR Dashboard
        const HRDashboard = ({ currentUser, communities, allAttendance }) => {
            return (
                <div className="space-y-4 pb-20">
                    <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                        <h2 className="text-lg font-bold text-gray-800 mb-4">人事管理中心</h2>
                        <div className="flex gap-2 mb-6 overflow-x-auto pb-2 no-scrollbar">
                            <button className="flex-shrink-0 flex items-center gap-2 px-4 py-2 bg-gray-50 text-gray-600 rounded-2xl text-sm font-medium hover:bg-gray-100 transition border border-gray-200">
                                <FileText className="w-4 h-4" /> 月報表
                            </button>
                            <button className="flex-shrink-0 flex items-center gap-2 px-4 py-2 bg-gray-50 text-gray-600 rounded-2xl text-sm font-medium hover:bg-gray-100 transition border border-gray-200">
                                <AlertCircle className="w-4 h-4" /> 異常檢視
                            </button>
                            <button className="flex-shrink-0 flex items-center gap-2 px-4 py-2 bg-gray-50 text-gray-600 rounded-2xl text-sm font-medium hover:bg-gray-100 transition border border-gray-200">
                                <Calendar className="w-4 h-4" /> 請假審核
                            </button>
                        </div>

                        <div className="space-y-4">
                            <h3 className="text-sm font-bold text-gray-500 uppercase tracking-wider">各社區概況</h3>
                            {communities.map(c => (
                            <div key={c.id} className="flex items-center justify-between p-4 bg-gray-50 rounded-2xl border border-gray-100">
                                <span className="text-sm font-bold text-gray-700">{c.name}</span>
                                <div className="flex gap-2 text-[10px] font-bold">
                                <span className="bg-white border border-gray-200 text-gray-600 px-2 py-1 rounded-2xl">正常 98%</span>
                                <span className="bg-red-50 text-red-600 px-2 py-1 rounded-2xl">異常 2%</span>
                                </div>
                            </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // Image Preview Modal
        const ImagePreviewModal = ({ url, onClose }) => {
            if (!url) return null;
            return (
                <div className="fixed inset-0 z-[80] bg-black/95 backdrop-blur-sm flex items-center justify-center p-4 animate-fade-in" onClick={onClose}>
                    <button 
                        onClick={onClose}
                        className="absolute top-4 right-4 p-2 bg-white/10 rounded-full text-white hover:bg-white/20 transition-colors z-50"
                    >
                        <X className="w-6 h-6" />
                    </button>
                    <img 
                        src={url} 
                        alt="Preview" 
                        className="max-w-full max-h-[90vh] object-contain rounded-lg shadow-2xl"
                        onClick={e => e.stopPropagation()}
                    />
                </div>
            );
        };

        // --- Main App Component ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [dbUser, setDbUser] = useState(null);
            const [view, setView] = useState('login');
            const [loading, setLoading] = useState(true);
            const [communities, setCommunities] = useState([]);
            const [usersList, setUsersList] = useState([]);
            const [attendanceList, setAttendanceList] = useState([]);
            const [myAttendance, setMyAttendance] = useState([]);
            const [fetchError, setFetchError] = useState('');
            const [isOnline, setIsOnline] = useState(navigator.onLine);
            const [activeTab, setActiveTab] = useState('home');
            const [clockSubtab, setClockSubtab] = useState('work');
            const [settingsSubtab, setSettingsSubtab] = useState('account');
            const [applicationSubtab, setApplicationSubtab] = useState('signature');
            const [functionSubtab, setFunctionSubtab] = useState('patrol');
            const [cadreSubtab, setCadreSubtab] = useState('map');
            const [cadreCompany, setCadreCompany] = useState('台北');
            const [cadreRecordDate, setCadreRecordDate] = useState(() => {
                const d = new Date();
                return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
            });
            const [cadreMapSelectedUserId, setCadreMapSelectedUserId] = useState(null);
            const [checkInLocation, setCheckInLocation] = useState(null);
            const [showCompanyMenu, setShowCompanyMenu] = useState(false);
            const [roles, setRoles] = useState([]);
            const [companies, setCompanies] = useState([]);
            const [areas, setAreas] = useState([]);
            const [showProfileModal, setShowProfileModal] = useState(false);
            const [showResetPasswordModal, setShowResetPasswordModal] = useState(false);
            const [resetPasswordForm, setResetPasswordForm] = useState({ newPassword: '', confirmPassword: '' });
            const [resetPasswordError, setResetPasswordError] = useState('');
            const [resetPasswordSaving, setResetPasswordSaving] = useState(false);
            const [showCameraModal, setShowCameraModal] = useState(false);
            const [clockType, setClockType] = useState('in');
            const [gpsStatus, setGpsStatus] = useState({ type: 'loading', message: 'GPS 偵測中...' });
            const [timeOffset, setTimeOffset] = useState(0);
            const [dateTime, setDateTime] = useState('');
            const [mapPreviewTarget, setMapPreviewTarget] = useState(null);
            const [previewImageUrl, setPreviewImageUrl] = useState(null);
            const [availableClockInLocations, setAvailableClockInLocations] = useState([]);

            // Helper to suppress network noise - Defined at component level for reuse
            const handleFetchError = (err, context) => {
                const msg = (err.message || '').toLowerCase();
                // Ignore common network/offline errors
                if (
                    msg.includes('offline') || 
                    msg.includes('network') || 
                    msg.includes('fetch') ||
                    msg.includes('aborted') ||
                    err.code === 'unavailable' ||
                    err.code === 'resource-exhausted' ||
                    err.name === 'FirebaseError' // Often wraps network issues
                ) {
                    return; 
                }
                // Only log critical application errors
                console.error(`Error fetching ${context}:`, err);
                // Only show UI error for permission issues
                if (msg.includes('permission') || err.code === 'permission-denied') {
                        setFetchError('資料讀取權限不足，請更新 Firestore 規則');
                }
            };

            useEffect(() => {
                const syncTime = async () => {
                    if (!navigator.onLine) return; // Skip if offline to prevent network errors

                    // Try multiple time APIs in sequence - prioritized more stable ones first
                    const apis = [
                        'https://timeapi.io/api/Time/current/zone?timeZone=Asia/Taipei',
                        'https://worldtimeapi.org/api/timezone/Asia/Taipei'
                    ];

                    for (const api of apis) {
                        try {
                            // Add a timeout signal to prevent long hangs that browser might complain about
                            const controller = new AbortController();
                            const timeoutId = setTimeout(() => controller.abort(), 10000); // Increased timeout to 10s
                            
                            const response = await fetch(api, { signal: controller.signal }).catch(() => null); // Catch fetch error immediately
                            clearTimeout(timeoutId);
                            
                            if (response && response.ok) {
                                const data = await response.json().catch(() => null);
                                if (!data) continue;

                                let serverTime;
                                if (data.datetime) { // worldtimeapi
                                    serverTime = new Date(data.datetime).getTime();
                                } else if (data.dateTime) { // timeapi.io
                                    serverTime = new Date(data.dateTime).getTime();
                                }
                                
                                if (serverTime) {
                                    const offset = serverTime - Date.now();
                                    setTimeOffset(offset);
                                    return; // Success, exit loop
                                }
                            }
                        } catch (e) {
                            // Silently ignore
                        }
                    }
                    // Fallback to local time (no action needed as offset defaults to 0)
                };
                syncTime();
                const i = setInterval(syncTime, 300000); // Check every 5 minutes
                return () => clearInterval(i);
            }, []);

            useEffect(() => {
                const update = () => {
                    const now = new Date(Date.now() + timeOffset);
                    const timeStr = now.toLocaleTimeString('zh-TW', { timeZone: 'Asia/Taipei', hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
                    const dateStr = now.toLocaleDateString('zh-TW', { timeZone: 'Asia/Taipei', year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '-');
                    setDateTime(`${dateStr}    ${timeStr}`);
                };
                update();
                const t = setInterval(update, 1000);
                return () => clearInterval(t);
            }, [timeOffset]);
            useEffect(() => {
                const deleteAdmin = async () => {
                    const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'users'), where('email', '==', 'admin@sys.com'));
                    const snap = await getDocs(q);
                    snap.forEach(async (d) => {
                        await deleteDoc(d.ref);
                        // Silently deleted admin
                    });
                };
                deleteAdmin();
            }, []);
            const availablePages = [
                { key: 'home', label: '首頁' },
                { key: 'overview', label: '總覽' },
                { key: 'clock', label: '打卡' },
                { key: 'community', label: '社區' },
                { key: 'function', label: '功能' },
                { key: 'cadre', label: '幹部' },
                { key: 'application', label: '申請' },
                { key: 'hr', label: '人事' },
                { key: 'settings', label: '設定' }
            ];
            
            const switchTab = (tab) => {
                setActiveTab(tab);
                if (tab === 'settings') {
                    setSettingsSubtab('general');
                }
                if (tab === 'clock') {
                    setClockSubtab('work');
                }
                if (tab === 'cadre') {
                    setCadreSubtab('map');
                }
            };

            const hasPermission = (pageKey) => {
                if (!dbUser) return false;
                if (dbUser.role === 'admin') return true;
                const userRole = roles.find(r => r.id === dbUser.role);
                return userRole?.permissions?.includes(pageKey) || false;
            };

            useEffect(() => {
                if (!navigator.geolocation) {
                    setGpsStatus({ type: 'error', message: '不支援 GPS' });
                    return;
                }

                // Safety timeout
                const loadingTimeout = setTimeout(() => {
                    setGpsStatus(prev => {
                        if (prev.type === 'loading') {
                            return { type: 'error', message: 'GPS 回應過慢，請確認訊號' };
                        }
                        return prev;
                    });
                }, 15000);

                const success = (pos) => {
                    const { accuracy } = pos.coords;
                    let source = 'GPS 衛星';
                    let type = 'success';
                    
                    if (accuracy > 100) {
                        source = 'Wi-Fi/基地台粗略';
                        type = 'warning';
                    } else if (accuracy > 30) {
                        source = 'Wi-Fi/行動網路';
                    }

                    setGpsStatus({ 
                        type: type, 
                        message: `${source}定位 (誤差 ${Math.round(accuracy)}m)` 
                    });
                };

                const error = (err) => {
                    let msg = 'GPS 訊號異常';
                    if (err.code === 1) msg = '無 GPS 權限'; // PERMISSION_DENIED
                    else if (err.code === 2) msg = '無法偵測位置'; // POSITION_UNAVAILABLE
                    else if (err.code === 3) msg = 'GPS 連線逾時'; // TIMEOUT
                    
                    setGpsStatus({ type: 'error', message: msg });
                };

                const id = navigator.geolocation.watchPosition(success, error, {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 0
                });

                return () => {
                    navigator.geolocation.clearWatch(id);
                    clearTimeout(loadingTimeout);
                };
            }, []);

            useEffect(() => {
                let mounted = true;
                const timer = setTimeout(() => {
                    if (mounted) setLoading(false);
                }, 3000);
                
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        }
                    } catch (e) {
                        console.error("Auth init error", e);
                    }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    setLoading(false);
                    clearTimeout(timer);
                    if (u) {
                        let restored = null;
                        try {
                            const until = parseInt(localStorage.getItem('remember_until') || '0', 10);
                            const stored = localStorage.getItem('remember_user');
                            if (until && until > Date.now() && stored) {
                                restored = JSON.parse(stored);
                            }
                        } catch {}
                        if (restored) {
                            setDbUser(restored);
                            setView('dashboard');
                        } else {
                            (async () => {
                                try {
                                    const q = query(
                                        collection(db, 'artifacts', appId, 'public', 'data', 'users'),
                                        where('email', '==', u.email || '')
                                    );
                                    const snap = await getDocs(q);
                                    if (!snap.empty) {
                                        const data = { id: snap.docs[0].id, ...snap.docs[0].data() };
                                        const comm = communities.find(c => c.id === data.communityId);
                                        data.communityName = comm ? comm.name : (data.communityId === 'SYSTEM' ? '總部系統' : '未分配');
                                        setDbUser(data);
                                        setView('dashboard');
                                    } else {
                                        setView('dashboard');
                                    }
                                } catch {}
                            })();
                        }
                    } else {
                        setDbUser(null);
                        setView('login');
                    }
                });
                const onlineHandler = () => setIsOnline(true);
                const offlineHandler = () => setIsOnline(false);
                window.addEventListener('online', onlineHandler);
                window.addEventListener('offline', offlineHandler);
                return () => {
                    mounted = false;
                    unsubscribe();
                    clearTimeout(timer);
                    window.removeEventListener('online', onlineHandler);
                    window.removeEventListener('offline', offlineHandler);
                };
            }, []);

            useEffect(() => {
                if (!user) return;
                const unsubscribes = [];

                // Communities
                unsubscribes.push(onSnapshot(
                    collection(db, 'artifacts', appId, 'public', 'data', 'communities'),
                    (snap) => setCommunities(snap.docs.map(d => ({ id: d.id, ...d.data() }))),
                    (err) => handleFetchError(err, 'communities_snap')
                ));

                // Roles
                unsubscribes.push(onSnapshot(
                    collection(db, 'artifacts', appId, 'public', 'data', 'roles'),
                    (snap) => setRoles(snap.docs.map(d => ({ id: d.id, ...d.data() }))),
                    (err) => handleFetchError(err, 'roles_snap')
                ));

                return () => unsubscribes.forEach(u => u());
            }, [user]);

            useEffect(() => {
                if (!user || !dbUser) return;
                
                const unsubscribes = [];
                const isManagerOrAdmin = ['admin', 'manager', 'hr', 'cadre'].includes(dbUser.role);
                
                // Conditions for fetching specific data
                const needsCommonData = isManagerOrAdmin || 
                                      ((activeTab === 'settings' && settingsSubtab === 'general') || activeTab === 'cadre' || activeTab === 'home' || activeTab === 'clock');
                const needsUsersList = needsCommonData || (activeTab === 'settings' && settingsSubtab === 'account');

                // 1. Common Data (Roles, Companies, Areas)
                if (needsCommonData) {
                    const refCompanies = collection(db, 'artifacts', appId, 'public', 'data', 'companies');
                    const refAreas = collection(db, 'artifacts', appId, 'public', 'data', 'areas');

                    unsubscribes.push(onSnapshot(refCompanies, 
                        (snap) => setCompanies(snap.docs.map(d => ({ id: d.id, ...d.data() }))), 
                        (e) => handleFetchError(e, 'companies_snap')
                    ));
                    unsubscribes.push(onSnapshot(refAreas, 
                        (snap) => setAreas(snap.docs.map(d => ({ id: d.id, ...d.data() }))), 
                        (e) => handleFetchError(e, 'areas_snap')
                    ));
                }

                // 2. Users List (for counts and display)
                if (needsUsersList) {
                    const refUsers = collection(db, 'artifacts', appId, 'public', 'data', 'users');
                    unsubscribes.push(onSnapshot(refUsers, 
                        (snap) => setUsersList(snap.docs.map(d => ({ id: d.id, ...d.data() }))), 
                        (e) => handleFetchError(e, 'users_snap')
                    ));
                }

                // 3. All Attendance (Manager Only)
                if (isManagerOrAdmin) {
                    const dateLimit = new Date();
                    dateLimit.setDate(dateLimit.getDate() - 30);
                    
                    const qAll = query(
                        collection(db, 'artifacts', appId, 'public', 'data', 'attendance'), 
                        where('timestamp', '>=', dateLimit),
                        orderBy('timestamp', 'desc')
                    );
                    
                    unsubscribes.push(onSnapshot(qAll, 
                        (snap) => setAttendanceList(snap.docs.map(d => ({ id: d.id, ...d.data() }))), 
                        (e) => handleFetchError(e, 'attendance_all_snap')
                    ));
                }

                // 4. My Attendance (Home Only)
                if (activeTab === 'home') {
                    const qMine = query(
                        collection(db, 'artifacts', appId, 'public', 'data', 'attendance'), 
                        where('userId', '==', dbUser.id),
                        orderBy('timestamp', 'desc')
                    );
                    unsubscribes.push(onSnapshot(qMine, 
                        (snap) => setMyAttendance(snap.docs.map(d => ({ id: d.id, ...d.data() }))), 
                        (e) => handleFetchError(e, 'attendance_mine_snap')
                    ));
                }

                return () => {
                    unsubscribes.forEach(u => u());
                };
            }, [user, dbUser, activeTab, settingsSubtab]);

            // Auto-select first company when in Cadre tab
            useEffect(() => {
                if (activeTab === 'cadre' && companies.length > 0) {
                    const exists = companies.some(c => c.name === cadreCompany);
                    if (!exists) {
                        setCadreCompany(companies[0].name);
                    }
                }
            }, [activeTab, companies, cadreCompany]);

            

            const seedData = async () => {
                if (!user) return;
                const baseCommRef = collection(db, 'artifacts', appId, 'public', 'data', 'communities');
                const baseUserRef = collection(db, 'artifacts', appId, 'public', 'data', 'users');
                const comm1 = await addDoc(baseCommRef, { name: '帝寶社區', address: '台北市仁愛路' });
                const comm2 = await addDoc(baseCommRef, { name: '信義之星', address: '台北市信義區' });
                // admin@sys.com removed
                await addDoc(baseUserRef, { name: '李經理', email: 'manager@comm.com', password: '123', role: 'manager', communityId: comm1.id });
                await addDoc(baseUserRef, { name: '陳人事', email: 'hr@comm.com', password: '123', role: 'hr', communityId: 'HQ' });
                await addDoc(baseUserRef, { name: '王保全', email: 'staff@comm.com', password: '123', role: 'staff', communityId: comm1.id });
            };

            const signInWithRetry = async (email, password) => {
                let i = 0;
                const delays = [500, 1000, 2000];
                while (true) {
                    try {
                        return await signInWithEmailAndPassword(auth, email, password);
                    } catch (e) {
                        if (e && e.code === 'auth/network-request-failed' && i < delays.length) {
                            await new Promise(r => setTimeout(r, delays[i++]));
                            continue;
                        }
                        throw e;
                    }
                }
            };

            const registerWithRetry = async (email, password) => {
                let i = 0;
                const delays = [500, 1000, 2000];
                while (true) {
                    try {
                        return await createUserWithEmailAndPassword(auth, email, password);
                    } catch (e) {
                        if (e && e.code === 'auth/network-request-failed' && i < delays.length) {
                            await new Promise(r => setTimeout(r, delays[i++]));
                            continue;
                        }
                        throw e;
                    }
                }
            };

            const handleLogin = async (identifier, password, rememberMe = false) => {
                // setLoading(true); // Disable global loading to keep Login component mounted
                try {
                    let emailToUse = identifier;
                    
                    // Check if identifier is likely a phone number (no @)
                    if (identifier.indexOf('@') === -1) {
                        const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'users');
                        let qPhone = query(usersRef, where('phone', '==', identifier));
                        
                        try {
                            let snapshot = await getDocs(qPhone);
                            
                            // Retry with stripped format if empty (e.g. user typed 0912-345-678, db has 0912345678)
                            if (snapshot.empty) {
                                const stripped = identifier.replace(/[^0-9]/g, '');
                                if (stripped !== identifier && stripped.length > 0) {
                                    qPhone = query(usersRef, where('phone', '==', stripped));
                                    snapshot = await getDocs(qPhone);
                                }
                            }

                            if (snapshot.empty) {
                                throw new Error('找不到此手機號碼對應的帳號');
                            }
                            
                            const userDoc = snapshot.docs[0].data();
                            if (!userDoc.email) {
                                throw new Error('此帳號資料異常(無Email)，請聯繫管理員');
                            }
                            emailToUse = userDoc.email;
                        } catch (err) {
                            if (err.code === 'permission-denied') {
                                throw new Error('系統權限不足，無法在登入前查詢手機號碼。請直接使用 Email 登入，或聯繫管理員開啟權限。');
                            }
                            throw err;
                        }
                    }

                    await signInWithRetry(emailToUse, password);
                    const q = query(
                        collection(db, 'artifacts', appId, 'public', 'data', 'users'), 
                        where('email', '==', emailToUse)
                    );
                    const snap = await getDocs(q);
                    let userData;
                    if (!snap.empty) {
                        userData = { id: snap.docs[0].id, ...snap.docs[0].data() };
                    } else {
                        const baseUserRef = collection(db, 'artifacts', appId, 'public', 'data', 'users');
                        const name = emailToUse.split('@')[0];
                        const defaultRole = 'staff';
                        const defaultCommunity = 'HQ';
                        const docRef = await addDoc(baseUserRef, { name, email: emailToUse, role: defaultRole, communityId: defaultCommunity });
                        userData = { id: docRef.id, name, email: emailToUse, role: defaultRole, communityId: defaultCommunity };
                    }
                    const comm = communities.find(c => c.id === userData.communityId);
                    userData.communityName = comm ? comm.name : (userData.communityId === 'SYSTEM' ? '總部系統' : '未分配');
                    setDbUser(userData);
                    // setView('dashboard'); // Moved to onLoginSuccess in Login component
                    if (rememberMe) {
                        try {
                            localStorage.setItem('remember_until', String(Date.now() + 48 * 60 * 60 * 1000));
                            localStorage.setItem('remember_user', JSON.stringify(userData));
                        } catch {}
                    }
                } catch (e) {
                    console.error(e);
                    throw e;
                } finally {
                    // setLoading(false);
                }
            };

            const handleRegister = async (email, password, rememberMe = false) => {
                // setLoading(true);
                try {
                    await registerWithRetry(email, password);
                    const baseUserRef = collection(db, 'artifacts', appId, 'public', 'data', 'users');
                    const name = email.split('@')[0];
                    const defaultRole = 'staff';
                    const defaultCommunity = 'HQ';
                    const docRef = await addDoc(baseUserRef, { name, email, role: defaultRole, communityId: defaultCommunity });
                    const userData = { id: docRef.id, name, email, role: defaultRole, communityId: defaultCommunity };
                    const comm = communities.find(c => c.id === userData.communityId);
                    userData.communityName = comm ? comm.name : (userData.communityId === 'SYSTEM' ? '總部系統' : '未分配');
                    setDbUser(userData);
                    // setView('dashboard');
                    if (rememberMe) {
                        try {
                            localStorage.setItem('remember_until', String(Date.now() + 48 * 60 * 60 * 1000));
                            localStorage.setItem('remember_user', JSON.stringify(userData));
                        } catch {}
                    }
                } catch (e) {
                    console.error(e);
                    throw e;
                } finally {
                    // setLoading(false);
                }
            };

            

            const handleLogout = async () => {
                setShowProfileModal(false);
                await signOut(auth);
                setDbUser(null);
                setView('login');
                try {
                    localStorage.removeItem('remember_until');
                    localStorage.removeItem('remember_user');
                } catch {}
            };

            const handleProfileAvatarUpload = async (file) => {
                if (!file || !dbUser) return;
                const reader = new FileReader();
                reader.onloadend = async () => {
                    const base64String = reader.result;
                    try {
                         await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', dbUser.id), {
                            avatarUrl: base64String,
                            updatedAt: serverTimestamp()
                         });
                         const newUser = { ...dbUser, avatarUrl: base64String };
                         setDbUser(newUser);
                         
                         // 如果有使用"記住我"，也要同步更新 localStorage
                         try {
                             if (localStorage.getItem('remember_user')) {
                                 localStorage.setItem('remember_user', JSON.stringify(newUser));
                             }
                         } catch (e) {}
                         
                         alert('大頭照更新成功');
                    } catch (e) {
                        console.error(e);
                        alert('更新大頭照失敗');
                    }
                };
                reader.readAsDataURL(file);
            };

            const handleResetPassword = async () => {
                if (!dbUser) return;
                setResetPasswordForm({ newPassword: '', confirmPassword: '' });
                setResetPasswordError('');
                setShowResetPasswordModal(true);
            };

            const handleSaveNewPassword = async () => {
                if (!resetPasswordForm.newPassword || !resetPasswordForm.confirmPassword) {
                    setResetPasswordError('請輸入新密碼及確認密碼');
                    return;
                }
                if (resetPasswordForm.newPassword !== resetPasswordForm.confirmPassword) {
                    setResetPasswordError('兩次輸入的密碼不一致');
                    return;
                }
                if (resetPasswordForm.newPassword.length < 6) {
                    setResetPasswordError('密碼長度至少需 6 碼');
                    return;
                }
                
                setResetPasswordSaving(true);
                setResetPasswordError('');
                try {
                    const user = auth.currentUser;
                    if (user) {
                        await updatePassword(user, resetPasswordForm.newPassword);
                        
                        if (dbUser && dbUser.id) {
                             const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', dbUser.id);
                             await updateDoc(userRef, {
                                 password: resetPasswordForm.newPassword,
                                 updatedAt: serverTimestamp()
                             });
                        }
                        
                        alert('密碼重設成功');
                        setShowResetPasswordModal(false);
                        setShowProfileModal(false);
                    } else {
                        setResetPasswordError('無法取得使用者資訊，請重新登入');
                    }
                } catch (error) {
                    console.error(error);
                    if (error.code === 'auth/requires-recent-login') {
                        setResetPasswordError('為確保安全，請重新登入後再試');
                    } else {
                        setResetPasswordError('密碼重設失敗: ' + error.message);
                    }
                } finally {
                    setResetPasswordSaving(false);
                }
            };

            const handleClockIn = (type, locations = []) => {
                setClockType(type);
                if (locations.length > 0) {
                    setAvailableClockInLocations(locations);
                }
                setShowCameraModal(true);
            };

            const handleCameraConfirm = async (imageBlob, location, address) => {
                if (!user || !dbUser) {
                    alert('使用者狀態異常，請重新登入');
                    return;
                }
                
                const withTimeout = (promise, ms, msg) => {
                    return Promise.race([
                        promise,
                        new Promise((_, reject) => setTimeout(() => reject(new Error(msg)), ms))
                    ]);
                };

                // Separate Upload and Database logic for better error handling
                let photoUrl = '';

                // 1. Upload Step
                try {
                    const filename = `attendance/${dbUser.id}/${Date.now()}.jpg`;
                    const imgRef = storageRef(storage, filename);
                    
                    // Starting upload...
                    await withTimeout(
                        uploadBytes(imgRef, imageBlob), 
                        60000, 
                        '照片上傳逾時(60秒)，網路連線可能不穩定'
                    );
                    // Upload complete
                    
                    photoUrl = await withTimeout(
                        getDownloadURL(imgRef),
                        10000,
                        '取得照片連結逾時'
                    );
                } catch (e) {
                    console.error("Upload Error", e);
                    let msg = e.message;
                    if (e.code === 'storage/unauthorized') {
                        msg = '權限不足 (Storage Rules)，請聯絡管理員檢查 Firebase Storage 規則';
                    } else if (e.code === 'storage/retry-limit-exceeded') {
                        msg = '連線不穩，已達重試上限';
                    }
                    alert("【步驟1：照片上傳失敗】\n" + msg);
                    setIsProcessing(false);
                    return; // Stop here
                }

                // 2. Database Step
                try {
                    await withTimeout(
                        addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'attendance'), {
                            userId: dbUser.id,
                            userName: dbUser.name,
                            userRole: dbUser.role,
                            communityId: checkInLocation ? checkInLocation.id : dbUser.communityId,
                            checkInLocationName: checkInLocation ? checkInLocation.name : (dbUser.communityName || ''),
                            type: clockType,
                            timestamp: serverTimestamp(),
                            device: 'Web Browser',
                            location: `${location.lat}, ${location.lng}`,
                            address: address,
                            photoUrl: photoUrl
                        }),
                        15000,
                        '資料寫入逾時(15秒)'
                    );
                    
                    setShowCameraModal(false);
                    alert('打卡成功！');
                } catch (e) {
                    console.error("Database Error", e);
                    let msg = e.message;
                    if (e.code === 'permission-denied') {
                        msg = '權限不足 (Firestore Rules)，無法寫入資料庫';
                    }
                    alert("【步驟2：資料儲存失敗】\n" + msg);
                } finally {
                    setIsProcessing(false);
                }
            };

            const handleAddUser = async (userData) => {
                if (!user) return;

                // Create user in Firebase Auth using a secondary app instance to avoid signing out the current admin
                const secondaryAppName = `secondaryApp-${Date.now()}`;
                let secondaryApp;
                const passwordToUse = userData.password || '123456';

                try {
                    secondaryApp = initializeApp(firebaseConfig, secondaryAppName);
                    const secondaryAuth = getAuth(secondaryApp);
                    await createUserWithEmailAndPassword(secondaryAuth, userData.email, passwordToUse);
                    await signOut(secondaryAuth);
                } catch (error) {
                    console.error("Error creating auth user:", error);
                    if (error.code === 'auth/email-already-in-use') {
                         // Check if the user exists in Firestore to allow recovery from failed writes
                         try {
                             const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'users'), where('email', '==', userData.email));
                             const snap = await getDocs(q);
                             if (snap.empty) {
                                 const shouldRepair = confirm('此 Email 已經註冊過帳號，但在資料庫中找不到資料（可能是上次建立時寫入失敗）。是否要補建立資料庫資料？');
                                 if (!shouldRepair) {
                                     if (secondaryApp) await deleteApp(secondaryApp);
                                     return;
                                 }
                                 // Fall through to Firestore write
                             } else {
                                 alert('該 Email 已經註冊過帳號，且資料庫中已存在。');
                                 if (secondaryApp) await deleteApp(secondaryApp);
                                 return;
                             }
                         } catch (checkErr) {
                             console.error("Error checking existing user:", checkErr);
                             alert('檢查帳號狀態時發生錯誤');
                             if (secondaryApp) await deleteApp(secondaryApp);
                             return;
                         }
                    } else {
                        alert(`建立帳號失敗: ${error.message}`);
                        if (secondaryApp) await deleteApp(secondaryApp);
                        return;
                    }
                } finally {
                    if (secondaryApp) {
                        try {
                            await deleteApp(secondaryApp);
                        } catch (e) { console.error(e); }
                    }
                }

                try {
                    const docRef = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'users'), { ...userData, password: passwordToUse, updatedByName: '新增', updatedAt: serverTimestamp() });
                    
                    // Optimistic update for immediate UI feedback
                    setUsersList(prev => [...prev, { 
                        id: docRef.id, 
                        ...userData, 
                        password: passwordToUse, 
                        updatedByName: '新增', 
                        updatedAt: new Date() 
                    }]);
                } catch (firestoreError) {
                    console.error("Firestore write failed:", firestoreError);
                    alert(`儲存使用者資料到資料庫失敗: ${firestoreError.message}`);
                    // Note: Auth user was created but Firestore data failed. You might want to delete the auth user or handle this inconsistency.
                    return;
                }
            };

            const handleAddCommunity = async (name) => {
                if (!user) return;
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'communities'), { name: name, updatedByName: '新增', updatedAt: serverTimestamp() });
            };

            if (loading) return <Loading />;

            if (view === 'login') {
                return <Login onLogin={handleLogin} onRegister={handleRegister} onLoginSuccess={() => setView('dashboard')} isOnline={isOnline} />;
            }

            return (
                <div className="min-h-screen bg-gray-100 flex flex-col font-sans">
                    {/* Mobile Navbar */}
                    <header className="bg-white fixed top-0 left-0 right-0 z-50 border-b border-gray-100 h-[8vh]">
                        <div className="max-w-md mx-auto px-4 h-full flex justify-between items-center">
                            <div className="flex items-center gap-2">
                                <div className="bg-red-600 w-[30px] h-[30px] rounded-lg flex items-center justify-center shadow-md shadow-red-200 transform rotate-3">
                                    <Clock className="text-white w-4 h-4" />
                                </div>
                                <span className="font-bold text-gray-800 tracking-tight">西北打卡系統</span>
                            </div>
                            
                            <div className="flex items-center gap-3">
                                <div className="text-right hidden sm:block">
                                    <div className="text-xs font-bold text-gray-800">{dbUser?.name}</div>
                                </div>
                                <button 
                                    onClick={() => setShowProfileModal(true)}
                                    className="relative w-9 h-9 rounded-full overflow-hidden border-2 border-gray-100 focus:outline-none focus:ring-2 focus:ring-red-500 transition"
                                >
                                    {dbUser?.avatarUrl ? (
                                        <img src={dbUser.avatarUrl} alt="avatar" className="w-full h-full object-cover" />
                                    ) : (
                                        <div className="w-full h-full bg-gray-200 flex items-center justify-center text-xs font-bold text-gray-600">
                                            {dbUser?.name ? dbUser.name.charAt(0) : <Users className="w-5 h-5" />}
                                        </div>
                                    )}
                                </button>
                            </div>
                        </div>
                        {fetchError && (
                            <div className="bg-yellow-50 border-t border-yellow-200 text-yellow-800 text-xs px-4 py-2">
                                {fetchError}
                            </div>
                        )}
                    </header>

                    {showProfileModal && (
                        <div className="fixed inset-0 z-[100] bg-black/50 flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-xs rounded-2xl shadow-2xl overflow-hidden animate-fade-in-up">
                                <div className="relative h-32 bg-gradient-to-r from-red-600 to-red-500">
                                    <div className="absolute top-3 w-full flex justify-center">
                                        <h3 className="text-lg font-bold text-white drop-shadow-md uppercase tracking-wider">
                                            個人資訊 {(function() {
                                                if (!dbUser) return '';
                                                const roleObj = roles.find(r => r.id === dbUser.role);
                                                if (roleObj) return roleObj.name;
                                                const roleMap = {
                                                    'admin': '系統管理員',
                                                    'manager': '總幹事',
                                                    'hr': '人事',
                                                    'cadre': '幹部',
                                                    'staff': '員工',
                                                    'secretary': '秘書',
                                                    'cleaner': '清潔',
                                                    'mechanic': '機電',
                                                    'guard': '保全'
                                                };
                                                return roleMap[dbUser.role] || dbUser.role;
                                            })()}
                                        </h3>
                                    </div>
                                    <button onClick={() => setShowProfileModal(false)} className="absolute top-3 right-3 p-1 bg-black/20 text-white rounded-full hover:bg-black/40 transition">
                                        <X className="w-4 h-4" />
                                    </button>
                                </div>
                                <div className="px-6 pb-6">
                                    <div className="relative -mt-20 mb-4">
                                        <div className="flex justify-center">
                                            <div className="relative group">
                                                <div className="w-40 h-40 rounded-full border-4 border-white shadow-lg overflow-hidden bg-white">
                                                    {dbUser?.avatarUrl ? (
                                                        <img src={dbUser.avatarUrl} alt="avatar" className="w-full h-full object-cover" />
                                                    ) : (
                                                        <div className="w-full h-full bg-gray-100 flex items-center justify-center text-3xl font-bold text-gray-400">
                                                            {dbUser?.name ? dbUser.name.charAt(0) : '?'}
                                                        </div>
                                                    )}
                                                </div>
                                                <label className="absolute bottom-2 right-2 p-2 bg-gray-800 text-white rounded-full cursor-pointer shadow-md hover:bg-gray-700 transition transform hover:scale-105">
                                                    <input type="file" accept="image/*" className="hidden" onChange={(e) => handleProfileAvatarUpload(e.target.files?.[0])} />
                                                    <Edit className="w-4 h-4" />
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="text-center mb-6">
                                        <h2 className="text-xl font-bold text-gray-800">{dbUser?.name}</h2>
                                        <p className="text-xl text-gray-500">{dbUser?.title || '未設定職稱'}</p>
                                    </div>

                                    <div className="space-y-3">
                                        <div className="flex items-center justify-between p-3 bg-gray-50 rounded-2xl">
                                            <span className="text-sm font-bold text-gray-600">本月計點</span>
                                            <span className="text-lg font-bold text-gray-800">0</span>
                                        </div>
                                        
                                        <div className="flex items-center justify-between p-3 bg-gray-50 rounded-2xl">
                                            <span className="text-sm font-bold text-gray-600">通知</span>
                                            <label className="relative inline-flex items-center cursor-pointer">
                                                <input type="checkbox" defaultChecked className="sr-only peer" />
                                                <div className="w-9 h-5 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-red-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-red-600"></div>
                                            </label>
                                        </div>

                                        <button 
                                            onClick={handleResetPassword}
                                            className="w-full flex items-center justify-center gap-2 p-3 bg-gray-50 text-gray-700 font-bold rounded-2xl hover:bg-gray-100 transition text-sm"
                                        >
                                            <Shield className="w-4 h-4" /> 重設密碼
                                        </button>

                                        <button 
                                            onClick={handleLogout}
                                            className="w-full flex items-center justify-center gap-2 p-3 bg-red-600 text-white font-bold rounded-2xl hover:bg-red-700 transition text-sm shadow-md shadow-red-200"
                                        >
                                            <LogOut className="w-4 h-4" /> 登出系統
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {showResetPasswordModal && (
                        <div className="fixed inset-0 z-[110] bg-black/50 flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-xs rounded-2xl shadow-2xl overflow-hidden animate-fade-in-up p-6">
                                <h4 className="text-lg font-bold text-gray-800 mb-4 text-center">重設密碼</h4>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 uppercase mb-1">新密碼</label>
                                        <input 
                                            type="password"
                                            className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm focus:ring-2 focus:ring-red-100"
                                            value={resetPasswordForm.newPassword}
                                            onChange={e => setResetPasswordForm(prev => ({ ...prev, newPassword: e.target.value }))}
                                            placeholder="請輸入新密碼"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 uppercase mb-1">確認新密碼</label>
                                        <input 
                                            type="password"
                                            className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm focus:ring-2 focus:ring-red-100"
                                            value={resetPasswordForm.confirmPassword}
                                            onChange={e => setResetPasswordForm(prev => ({ ...prev, confirmPassword: e.target.value }))}
                                            placeholder="請再次輸入新密碼"
                                        />
                                    </div>
                                    {resetPasswordError && (
                                        <div className="text-xs text-red-600 text-center">{resetPasswordError}</div>
                                    )}
                                    <div className="flex gap-2 pt-2">
                                        <button 
                                            onClick={() => setShowResetPasswordModal(false)}
                                            className="flex-1 py-3 rounded-2xl bg-gray-100 text-gray-700 font-bold text-sm"
                                        >
                                            取消
                                        </button>
                                        <button 
                                            onClick={handleSaveNewPassword}
                                            disabled={resetPasswordSaving}
                                            className="flex-1 py-3 rounded-2xl bg-red-600 text-white font-bold text-sm disabled:opacity-50"
                                        >
                                            {resetPasswordSaving ? '儲存中...' : '確認修改'}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="fixed top-[8vh] left-0 right-0 z-40 h-[8vh] bg-white border-b border-gray-100">
                        <div className="max-w-md mx-auto px-4 h-full flex items-center gap-2 overflow-x-auto no-scrollbar">
                            {activeTab === 'home' && (
                                <div className="w-full flex justify-center">
                                    <div className={`inline-flex items-center gap-2 px-4 py-2 rounded-full text-xs font-medium ${
                                        gpsStatus.type === 'success' ? 'bg-green-100 text-green-700' : 
                                        gpsStatus.type === 'loading' ? 'bg-yellow-100 text-yellow-700' :
                                        gpsStatus.type === 'warning' ? 'bg-blue-100 text-blue-700' :
                                        'bg-red-100 text-red-700'
                                    }`}>
                                        {gpsStatus.type === 'success' ? <CheckCircle className="w-3 h-3 text-green-600" /> :
                                         gpsStatus.type === 'loading' ? <RefreshCw className="w-3 h-3 animate-spin text-yellow-600" /> :
                                         gpsStatus.type === 'warning' ? <AlertCircle className="w-3 h-3 text-blue-600" /> :
                                         <AlertCircle className="w-3 h-3 text-red-600" />}
                                        {gpsStatus.message}
                                    </div>
                                </div>
                            )}
                            {activeTab === 'overview' && (
                                <div className="w-full flex justify-center">
                                    <div className="text-4xl font-bold text-black">{dateTime}</div>
                                </div>
                            )}
                            {activeTab === 'clock' && (
                                <div className="flex gap-2">
                                    <button onClick={() => setClockSubtab('work')} className={`px-3 py-2 text-xs font-bold rounded-2xl ${clockSubtab === 'work' ? 'bg-red-50 text-red-600' : 'bg-gray-50 text-gray-700'}`}>上下班</button>
                                    <button onClick={() => setClockSubtab('out')} className={`px-3 py-2 text-xs font-bold rounded-2xl ${clockSubtab === 'out' ? 'bg-red-50 text-red-600' : 'bg-gray-50 text-gray-700'}`}>外出</button>
                                    <button onClick={() => setClockSubtab('card')} className={`px-3 py-2 text-xs font-bold rounded-2xl ${clockSubtab === 'card' ? 'bg-red-50 text-red-600' : 'bg-gray-50 text-gray-700'}`}>卡班</button>
                                    <button onClick={() => setClockSubtab('leave')} className={`px-3 py-2 text-xs font-bold rounded-2xl ${clockSubtab === 'leave' ? 'bg-red-50 text-red-600' : 'bg-gray-50 text-gray-700'}`}>請假</button>
                                    <button onClick={() => setClockSubtab('record')} className={`px-3 py-2 text-xs font-bold rounded-2xl ${clockSubtab === 'record' ? 'bg-red-50 text-red-600' : 'bg-gray-50 text-gray-700'}`}>紀錄</button>
                                    <button onClick={() => setClockSubtab('points')} className={`px-3 py-2 text-xs font-bold rounded-2xl ${clockSubtab === 'points' ? 'bg-red-50 text-red-600' : 'bg-gray-50 text-gray-700'}`}>計點</button>
                                </div>
                            )}
                            {activeTab === 'community' && (
                                <button className="px-3 py-2 text-xs font-bold rounded-2xl bg-red-50 text-red-600">全部</button>
                            )}
                            {activeTab === 'function' && (
                                <div className="flex gap-2">
                                    <button onClick={() => setFunctionSubtab('patrol')} className={`px-3 py-2 text-xs font-bold rounded-2xl ${functionSubtab === 'patrol' ? 'bg-red-50 text-red-600' : 'bg-gray-50 text-gray-700'}`}>巡邏</button>
                                    <button onClick={() => setFunctionSubtab('training')} className={`px-3 py-2 text-xs font-bold rounded-2xl ${functionSubtab === 'training' ? 'bg-red-50 text-red-600' : 'bg-gray-50 text-gray-700'}`}>訓練</button>
                                    <button onClick={() => setFunctionSubtab('download')} className={`px-3 py-2 text-xs font-bold rounded-2xl ${functionSubtab === 'download' ? 'bg-red-50 text-red-600' : 'bg-gray-50 text-gray-700'}`}>下載</button>
                                </div>
                            )}
                            {activeTab === 'cadre' && (
                                <div className="flex gap-2">
                                    <button onClick={() => setCadreSubtab('map')} className={`px-3 py-2 text-xs font-bold rounded-2xl ${cadreSubtab === 'map' ? 'bg-red-50 text-red-600' : 'bg-gray-50 text-gray-700'}`}>地圖</button>
                                    <button onClick={() => setCadreSubtab('record')} className={`px-3 py-2 text-xs font-bold rounded-2xl ${cadreSubtab === 'record' ? 'bg-red-50 text-red-600' : 'bg-gray-50 text-gray-700'}`}>紀錄</button>
                                    <button onClick={() => setCadreSubtab('schedule')} className={`px-3 py-2 text-xs font-bold rounded-2xl ${cadreSubtab === 'schedule' ? 'bg-red-50 text-red-600' : 'bg-gray-50 text-gray-700'}`}>班表</button>
                                    <button onClick={() => setCadreSubtab('approval')} className={`px-3 py-2 text-xs font-bold rounded-2xl ${cadreSubtab === 'approval' ? 'bg-red-50 text-red-600' : 'bg-gray-50 text-gray-700'}`}>簽呈</button>
                                    <button onClick={() => setCadreSubtab('account')} className={`px-3 py-2 text-xs font-bold rounded-2xl ${cadreSubtab === 'account' ? 'bg-red-50 text-red-600' : 'bg-gray-50 text-gray-700'}`}>帳號</button>
                                    <button onClick={() => setCadreSubtab('notification')} className={`px-3 py-2 text-xs font-bold rounded-2xl ${cadreSubtab === 'notification' ? 'bg-red-50 text-red-600' : 'bg-gray-50 text-gray-700'}`}>通知</button>
                                </div>
                            )}

                            {activeTab === 'cadre' && (
                                <div className="absolute top-full left-0 right-0 h-[8vh] bg-white/80 backdrop-blur-sm flex items-center gap-3 overflow-x-auto px-4 no-scrollbar z-30 shadow-sm">
                                    {(function() {
                                        const targetCompany = companies.find(c => c.name === cadreCompany);
                                        if (!targetCompany) return null;
                                        
                                        // Filter: Company + Roles (admin, hr, cadre, staff)
                                        // Expand target roles to include custom roles with matching names
                                        const targetRoleNames = ['系統管理員', '人事', '幹部', '員工'];
                                        const targetRoleIds = roles.filter(r => targetRoleNames.includes(r.name)).map(r => r.id);
                                        const finalTargetRoles = ['admin', 'hr', 'cadre', 'staff', ...targetRoleIds];

                                        const companyUsers = usersList.filter(u => 
                                            ((u.companyIds && u.companyIds.some(cid => String(cid) === String(targetCompany.id))) || String(u.companyId) === String(targetCompany.id)) && 
                                            finalTargetRoles.includes(u.role)
                                        );
                                        
                                        if (companyUsers.length === 0) return <div className="text-xs text-gray-400">尚無人員</div>;

                                        return companyUsers.map(u => (
                                            <div 
                                                key={u.id}
                                                className="flex-shrink-0 flex flex-col items-center gap-1 cursor-pointer group"
                                                onClick={() => setCadreMapSelectedUserId(u.id)}
                                            >
                                                <div 
                                                    className="w-[30px] h-[30px] rounded-full bg-gray-200 overflow-hidden border-2 border-white shadow-sm relative group-hover:scale-105 transition-transform" 
                                                    title={u.name}
                                                >
                                                    {u.avatarUrl ? (
                                                        <img src={u.avatarUrl} alt={u.name} className="w-full h-full object-cover" />
                                                    ) : (
                                                        <div className="w-full h-full flex items-center justify-center font-bold text-gray-500 text-xs">
                                                            {u.name?.[0]}
                                                        </div>
                                                    )}
                                                </div>
                                                <span className="text-[10px] text-gray-600 font-medium max-w-[48px] truncate">
                                                    {u.name}
                                                </span>
                                            </div>
                                        ));
                                    })()}
                                </div>
                            )}
                            {activeTab === 'application' && (
                                <div className="flex gap-2">
                                    <button onClick={() => setApplicationSubtab('signature')} className={`px-3 py-2 text-xs font-bold rounded-2xl ${applicationSubtab === 'signature' ? 'bg-red-50 text-red-600' : 'bg-gray-50 text-gray-700'}`}>簽呈</button>
                                    <button onClick={() => setApplicationSubtab('equipment')} className={`px-3 py-2 text-xs font-bold rounded-2xl ${applicationSubtab === 'equipment' ? 'bg-red-50 text-red-600' : 'bg-gray-50 text-gray-700'}`}>設備</button>
                                </div>
                            )}
                            {activeTab === 'hr' && (
                                <button className="px-3 py-2 text-xs font-bold rounded-2xl bg-red-50 text-red-600">報表</button>
                            )}
                            {activeTab === 'settings' && (
                                <div className="flex gap-2">
                                    <button onClick={() => setSettingsSubtab('general')} className={`px-3 py-2 text-xs font-bold rounded-2xl ${settingsSubtab === 'general' ? 'bg-red-50 text-red-600' : 'bg-gray-50 text-gray-700'}`}>一般</button>
                                    <button onClick={() => setSettingsSubtab('account')} className={`px-3 py-2 text-xs font-bold rounded-2xl ${settingsSubtab === 'account' ? 'bg-red-50 text-red-600' : 'bg-gray-50 text-gray-700'}`}>帳號</button>
                                    <button onClick={() => setSettingsSubtab('community')} className={`px-3 py-2 text-xs font-bold rounded-2xl ${settingsSubtab === 'community' ? 'bg-red-50 text-red-600' : 'bg-gray-50 text-gray-700'}`}>社區</button>
                                    <button onClick={() => setSettingsSubtab('system')} className={`px-3 py-2 text-xs font-bold rounded-2xl ${settingsSubtab === 'system' ? 'bg-red-50 text-red-600' : 'bg-gray-50 text-gray-700'}`}>系統</button>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Main Content Area - Mobile Container */}
                    <main className={`absolute left-0 right-0 overflow-y-auto ${(activeTab === 'cadre') ? 'top-[24vh] h-[68vh]' : 'top-[16vh] h-[76vh]'}`}>
                        <div className={`w-full max-w-md mx-auto px-4 py-4 ${activeTab === 'cadre' ? 'pb-20' : ''}`}>
                        
                        {/* Role Based Views */}
                        {activeTab === 'home' && hasPermission('home') && (
                            <div className="space-y-6 mb-6">
                                <ErrorBoundary>
                                    <StaffDashboard 
                                        currentUser={dbUser} 
                                        onClockIn={handleClockIn} 
                                        attendanceHistory={myAttendance}
                                        timeOffset={timeOffset}
                                        companies={companies}
                                        communities={communities}
                                        checkInLocation={checkInLocation}
                                        setCheckInLocation={setCheckInLocation}
                                        setMapPreviewTarget={setMapPreviewTarget}
                                        setPreviewImageUrl={setPreviewImageUrl}
                                        roles={roles}
                                    />
                                </ErrorBoundary>
                            </div>
                        )}

                        {activeTab === 'clock' && hasPermission('clock') && (
                            <div className="space-y-6 mb-6">
                                {clockSubtab === 'work' && (
                                    <StaffDashboard 
                                        currentUser={dbUser} 
                                        onClockIn={handleClockIn} 
                                        attendanceHistory={myAttendance.filter(r => ['in', 'out'].includes(r.type))}
                                        timeOffset={timeOffset}
                                        companies={companies}
                                        communities={communities}
                                        checkInLocation={checkInLocation}
                                        setCheckInLocation={setCheckInLocation}
                                        setMapPreviewTarget={setMapPreviewTarget}
                                        setPreviewImageUrl={setPreviewImageUrl}
                                        roles={roles}
                                        hideHeaderInfo={true}
                                        mode="work"
                                    />
                                )}
                                {clockSubtab === 'out' && (
                                    <StaffDashboard 
                                        currentUser={dbUser} 
                                        onClockIn={handleClockIn} 
                                        attendanceHistory={myAttendance.filter(r => ['outing_start', 'outing_arrive', 'outing_end'].includes(r.type))}
                                        timeOffset={timeOffset}
                                        companies={companies}
                                        communities={communities}
                                        checkInLocation={checkInLocation}
                                        setCheckInLocation={setCheckInLocation}
                                        setMapPreviewTarget={setMapPreviewTarget}
                                        setPreviewImageUrl={setPreviewImageUrl}
                                        roles={roles}
                                        hideHeaderInfo={true}
                                        mode="outing"
                                    />
                                )}
                                {clockSubtab === 'card' && (
                                    <StaffDashboard 
                                        currentUser={dbUser} 
                                        onClockIn={handleClockIn} 
                                        attendanceHistory={myAttendance.filter(r => ['late_in', 'late_out'].includes(r.type))}
                                        timeOffset={timeOffset}
                                        companies={companies}
                                        communities={communities}
                                        checkInLocation={checkInLocation}
                                        setCheckInLocation={setCheckInLocation}
                                        setMapPreviewTarget={setMapPreviewTarget}
                                        setPreviewImageUrl={setPreviewImageUrl}
                                        roles={roles}
                                        hideHeaderInfo={true}
                                        mode="card"
                                    />
                                )}

                            </div>
                        )}

                        {dbUser?.role === 'manager' && (
                            <div className="space-y-6">
                                <div className="flex items-center justify-between">
                                    <h2 className="text-lg font-bold text-gray-800 flex items-center gap-2">
                                        <Briefcase className="w-5 h-5 text-red-600" />
                                        管理概覽
                                    </h2>
                                    <span className="text-xs text-gray-400 bg-white px-2 py-1 rounded-2xl border">經理權限</span>
                                </div>

                                <div className="pt-4 border-t border-gray-200">
                                    <h3 className="text-xs font-bold text-gray-400 uppercase mb-3">團隊動態</h3>
                                    <ErrorBoundary>
                                        <ManagerDashboard 
                                            currentUser={dbUser} 
                                            communities={communities} 
                                            allAttendance={attendanceList}
                                            timeOffset={timeOffset}
                                            users={usersList}
                                        />
                                    </ErrorBoundary>
                                </div>
                            </div>
                        )}

                        {activeTab === 'hr' && hasPermission('hr') && (
                            <div className="space-y-6">
                                <div className="flex items-center gap-2 text-lg font-bold text-gray-800">
                                    <LayoutDashboard className="w-5 h-5 text-red-600" /> 人事管理中心
                                </div>
                                <ErrorBoundary>
                                    <HRDashboard 
                                        currentUser={dbUser} 
                                        communities={communities} 
                                        allAttendance={attendanceList}
                                    />
                                </ErrorBoundary>
                            </div>
                        )}

                        {activeTab === 'function' && hasPermission('function') && (
                            <div className="space-y-6">
                                <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                                    {functionSubtab === 'patrol' && (
                                        <div>
                                            <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                                <Briefcase className="w-5 h-5 mr-2 text-red-600" /> 巡邏管理
                                            </h3>
                                            <div className="text-center py-8 text-gray-400">
                                                尚無巡邏資料
                                            </div>
                                        </div>
                                    )}
                                    {functionSubtab === 'training' && (
                                        <div>
                                            <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                                <Briefcase className="w-5 h-5 mr-2 text-red-600" /> 教育訓練
                                            </h3>
                                            <div className="text-center py-8 text-gray-400">
                                                尚無訓練課程
                                            </div>
                                        </div>
                                    )}
                                    {functionSubtab === 'download' && (
                                        <div>
                                            <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                                <Briefcase className="w-5 h-5 mr-2 text-red-600" /> 文件下載
                                            </h3>
                                            <div className="text-center py-8 text-gray-400">
                                                尚無可下載文件
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {activeTab === 'cadre' && hasPermission('cadre') && (
                            <div className="space-y-6">
                                <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                                    <div className="mb-4 p-3 bg-red-50 rounded-xl text-center">
                                        <span className="text-gray-600 font-bold mr-2">目前選擇公司:</span>
                                        <span className="text-red-600 font-bold">{cadreCompany}</span>
                                    </div>

                                    {cadreSubtab === 'map' && (
                                        <div>
                                            <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                                <MapPin className="w-5 h-5 mr-2 text-red-600" /> 地圖
                                            </h3>
                                            {(function() {
                                                const targetCompany = companies.find(c => c.name === cadreCompany);
                                                
                                                let displayLocation = null;
                                                let companyUsers = [];

                                                if (targetCompany) {
                                                    // 1. Set Company Center (Default)
                                                    if (targetCompany.lat && targetCompany.lng) {
                                                        displayLocation = { lat: targetCompany.lat, lng: targetCompany.lng };
                                                    }

                                                    // 2. Prepare users list with location
                                                    if (usersList.length > 0) {
                                                        // Filter: Company + Roles (admin, hr, cadre, staff)
                                                        // Expand target roles to include custom roles with matching names
                                                        const targetRoleNames = ['系統管理員', '人事', '幹部', '員工'];
                                                        const targetRoleIds = roles.filter(r => targetRoleNames.includes(r.name)).map(r => r.id);
                                                        const finalTargetRoles = ['admin', 'hr', 'cadre', 'staff', ...targetRoleIds];
                                                        
                                                        const companyMembers = usersList.filter(u => 
                                                            ((u.companyIds && u.companyIds.some(cid => String(cid) === String(targetCompany.id))) || 
                                                            String(u.companyId) === String(targetCompany.id)) &&
                                                            finalTargetRoles.includes(u.role)
                                                        );
                                                        
                                                        companyUsers = companyMembers.map(u => {
                                                            // Find latest record with location
                                                            // attendanceList is sorted by desc timestamp
                                                            const record = attendanceList.find(r => r.userId === u.id && r.location && r.location.includes(','));
                                                            
                                                            if (record) {
                                                                const parts = record.location.split(',');
                                                                return {
                                                                    id: u.id,
                                                                    lat: parseFloat(parts[0]),
                                                                    lng: parseFloat(parts[1]),
                                                                    avatarUrl: u.avatarUrl,
                                                                    name: u.name,
                                                                    time: (record.timestamp?.seconds || Date.now() / 1000) * 1000,
                                                                    locationName: record.checkInLocationName || targetCompany.name
                                                                };
                                                            }
                                                            return null;
                                                        }).filter(u => u !== null);
                                                    }
                                                }

                                                return (
                                                    <div className="space-y-4">
                                                        <div className="w-full h-64 bg-gray-100 rounded-2xl overflow-hidden relative shadow-inner">
                                                            {displayLocation ? (
                                                                <CompanyMapPreview 
                                                                    lat={displayLocation.lat} 
                                                                    lng={displayLocation.lng} 
                                                                    radius={targetCompany?.radius || 100}
                                                                    users={companyUsers}
                                                                    externalSelectedUserId={cadreMapSelectedUserId}
                                                                    onUserSelect={(u) => setCadreMapSelectedUserId(u ? u.id : null)}
                                                                />
                                                            ) : (
                                                                <div className="w-full h-full flex flex-col items-center justify-center text-gray-400 p-4 text-center">
                                                                    <MapPin className="w-8 h-8 mb-2 text-gray-300" />
                                                                    <div>{targetCompany ? '該公司尚未設定座標' : `找不到 ${cadreCompany} 公司資料`}</div>
                                                                    <div className="text-xs mt-1 text-gray-300">請確認後台設定</div>
                                                                </div>
                                                            )}
                                                        </div>


                                                    </div>
                                                );
                                            })()}
                                        </div>
                                    )}
                                    {cadreSubtab === 'record' && (function() {
                                        const targetCompany = companies.find(c => c.name === cadreCompany);
                                        const companyUserIds = targetCompany ? usersList
                                            .filter(u => (u.companyIds && u.companyIds.some(cid => String(cid) === String(targetCompany.id))) || String(u.companyId) === String(targetCompany.id))
                                            .map(u => u.id) : [];

                                        const records = targetCompany ? attendanceList.filter(r => {
                                            if (!companyUserIds.includes(r.userId)) return false;
                                            if (cadreMapSelectedUserId && r.userId !== cadreMapSelectedUserId) return false;
                                            
                                            const rDate = new Date((r.timestamp?.seconds || Date.now() / 1000) * 1000);
                                            const recordDate = `${rDate.getFullYear()}-${String(rDate.getMonth()+1).padStart(2,'0')}-${String(rDate.getDate()).padStart(2,'0')}`;
                                            return recordDate === cadreRecordDate;
                                        }) : [];
                                        
                                        // Calculate today string for comparison
                                        const now = new Date();
                                        const todayStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
                                        const isToday = cadreRecordDate === todayStr;

                                        return (
                                        <div>
                                            <h3 className="font-bold text-gray-800 mb-4 text-sm flex items-center justify-between">
                                                <div className="flex items-center gap-2">
                                                    <button 
                                                        onClick={() => {
                                                            const d = new Date(cadreRecordDate);
                                                            d.setDate(d.getDate() - 1);
                                                            setCadreRecordDate(`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`);
                                                        }} 
                                                        className="p-1 rounded-full hover:bg-gray-100 text-gray-500"
                                                    >
                                                        <ChevronLeft className="w-5 h-5" />
                                                    </button>
                                                    <span>{isToday ? '今日打卡紀錄' : `${cadreRecordDate.replace(/-/g, '/')} 打卡紀錄`}</span>
                                                    <button 
                                                        onClick={() => {
                                                            const d = new Date(cadreRecordDate);
                                                            d.setDate(d.getDate() + 1);
                                                            setCadreRecordDate(`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`);
                                                        }}
                                                        disabled={isToday}
                                                        className={`p-1 rounded-full hover:bg-gray-100 text-gray-500 ${isToday ? 'opacity-30 cursor-not-allowed' : ''}`}
                                                    >
                                                        <ChevronRight className="w-5 h-5" />
                                                    </button>
                                                </div>
                                                <span className="text-xs text-gray-400 font-normal">共 {records.length} 筆</span>
                                            </h3>
                                            
                                            <div className="space-y-3 pb-24">
                                                {!targetCompany ? (
                                                    <div className="text-center text-gray-400 py-8">請選擇公司</div>
                                                ) : records.length === 0 ? (
                                                    <div className="text-center py-12 text-gray-400 bg-gray-50 rounded-2xl border-2 border-dashed border-gray-200">
                                                        本日尚無打卡紀錄
                                                    </div>
                                                ) : (
                                                    records.map(r => {
                                                        const user = usersList.find(u => u.id === r.userId) || {};
                                                        const timeStr = new Date((r.timestamp?.seconds || Date.now() / 1000) * 1000).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
                                                        
                                                        return (
                                                            <div key={r.id} className="p-3 bg-white border border-gray-100 rounded-2xl shadow-sm flex items-start gap-3">
                                                                <div className="w-10 h-10 rounded-full bg-gray-200 flex-shrink-0 overflow-hidden border border-gray-100">
                                                                    {user.avatarUrl ? (
                                                                        <img src={user.avatarUrl} className="w-full h-full object-cover" />
                                                                    ) : (
                                                                        <div className="w-full h-full flex items-center justify-center font-bold text-gray-500">
                                                                            {user.name?.[0]}
                                                                        </div>
                                                                    )}
                                                                </div>
                                                                <div className="flex-1 min-w-0">
                                                                    <div className="flex justify-between items-center">
                                                                        <div>
                                                                            <div className="font-bold text-gray-800 flex items-center gap-2">
                                                                                {r.userName}
                                                                                {(function(){
                                                    const typeMap = {
                                                        'in': { text: '上班', class: 'bg-green-100 text-green-700' },
                                                        'out': { text: '下班', class: 'bg-red-100 text-red-700' },
                                                        'outing_start': { text: '外出', class: 'bg-blue-100 text-blue-700' },
                                                        'outing_arrive': { text: '抵達', class: 'bg-blue-100 text-blue-700' },
                                                        'outing_end': { text: '離開', class: 'bg-blue-100 text-blue-700' },
                                                        'leave': { text: '請假', class: 'bg-orange-100 text-orange-700' },
                                                        'late_in': { text: '卡上', class: 'bg-green-100 text-green-700' },
                                                        'late_out': { text: '卡下', class: 'bg-red-100 text-red-700' }
                                                    };
                                                    const config = typeMap[r.type] || { text: '未知', class: 'bg-gray-100 text-gray-500' };
                                                    return (
                                                        <span className={`text-[10px] px-1.5 py-0.5 rounded-lg ${config.class}`}>
                                                            {config.text}
                                                        </span>
                                                    );
                                                })()}
                                                                            </div>
                                                                            <div className="text-xs text-gray-500 mt-0.5 flex items-center gap-1">
                                                                                <Clock className="w-3 h-3" /> {timeStr}
                                                                            </div>
                                                                            <div className="text-xs text-gray-500 mt-0.5 flex items-center gap-1">
                                                                                <MapPin className="w-3 h-3" /> {r.checkInLocationName || r.address || '未記錄'}
                                                                            </div>
                                                                        </div>
                                                                        <div className="flex items-center gap-2">
                                                                            {(function(){
                                                                                const parts = (r.location || '').split(',');
                                                                                let mapImgUrl = null;
                                                                                if (parts.length === 2) {
                                                                                    const lat = parts[0];
                                                                                    const lng = parts[1];
                                                                                    mapImgUrl = `https://maps.googleapis.com/maps/api/staticmap?center=${lat},${lng}&zoom=15&size=100x100&maptype=roadmap&markers=color:red%7C${lat},${lng}&key=AIzaSyAzhLdWtycJgfz8UsXWlji63DkXpA4kmyY`;
                                                                                }
                                                                                return (
                                                                                    <button 
                                                                                        onClick={() => {
                                                                                            if (parts.length === 2) {
                                                                                                setMapPreviewTarget({
                                                                                                    lat: parseFloat(parts[0]),
                                                                                                    lng: parseFloat(parts[1]),
                                                                                                    name: r.userName + ' - ' + (r.address || '打卡位置'),
                                                                                                    radius: 10
                                                                                                });
                                                                                            } else {
                                                                                                alert('無座標資訊: ' + (r.address || ''));
                                                                                            }
                                                                                        }}
                                                                                        className="w-12 h-12 rounded-lg bg-gray-100 text-gray-500 flex items-center justify-center border border-gray-200 hover:opacity-90 transition-opacity overflow-hidden p-0"
                                                                                    >
                                                                                        {mapImgUrl ? (
                                                                                            <img src={mapImgUrl} className="w-full h-full object-cover" alt="地圖" />
                                                                                        ) : (
                                                                                            <MapPin className="w-5 h-5" />
                                                                                        )}
                                                                                    </button>
                                                                                );
                                                                            })()}
                                                                            {r.photoUrl && (
                                                                                <div className="w-12 h-12 rounded-lg bg-gray-100 overflow-hidden cursor-pointer border border-gray-200 hover:opacity-90 transition-opacity" onClick={() => setPreviewImageUrl(r.photoUrl)}>
                                                                                    <img src={r.photoUrl} className="w-full h-full object-cover" />
                                                                                </div>
                                                                            )}
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        );
                                                    })
                                                )}
                                            </div>
                                        </div>
                                        );
                                    })()}
                                    {cadreSubtab === 'schedule' && (
                                        <div>
                                            <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                                <Calendar className="w-5 h-5 mr-2 text-red-600" /> 班表
                                            </h3>
                                        </div>
                                    )}
                                    {cadreSubtab === 'approval' && (
                                        <div>
                                            <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                                <FileText className="w-5 h-5 mr-2 text-red-600" /> 簽呈
                                            </h3>
                                        </div>
                                    )}
                                    {cadreSubtab === 'account' && (
                                        <div>
                                            <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                                <Users className="w-5 h-5 mr-2 text-red-600" /> 帳號資料
                                            </h3>
                                            <div className="space-y-3">
                                                {(function() {
                                                    const targetCompany = companies.find(c => c.name === cadreCompany);
                                                    if (!targetCompany) return <div className="text-center text-gray-400">請選擇公司</div>;

                                                    // Filter: Company - Show all users EXCEPT excluded roles
                                                    const excludedRoles = ['manager', 'secretary', 'cleaner', 'mechanic', 'guard'];
                                                    
                                                    const filteredUsers = usersList.filter(u => 
                                                        ((u.companyIds && u.companyIds.some(cid => String(cid) === String(targetCompany.id))) || String(u.companyId) === String(targetCompany.id)) && 
                                                        !excludedRoles.includes(u.role) &&
                                                        (!cadreMapSelectedUserId || u.id === cadreMapSelectedUserId)
                                                    );

                                                    if (filteredUsers.length === 0) return <div className="text-center text-gray-400">尚無符合條件的帳號</div>;

                                                    return filteredUsers.map(u => (
                                                        <div key={u.id} className="p-3 bg-gray-50 rounded-2xl flex items-center gap-3">
                                                            <div className="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center font-bold text-gray-600 overflow-hidden">
                                                                {u.avatarUrl ? <img src={u.avatarUrl} className="w-full h-full object-cover" /> : (u.name?.[0] || '?')}
                                                            </div>
                                                            <div className="flex-1">
                                                                <div className="font-bold text-gray-800 flex items-center gap-2">
                                                                    {u.name}
                                                                    <span className={`text-xs px-2 py-0.5 rounded-full ${u.role === 'admin' ? 'bg-purple-100 text-purple-600' : 'bg-red-100 text-red-600'}`}>
                                                                        {u.role === 'admin' ? '系統管理員' : (roles.find(r => r.id === u.role)?.name || u.role)}
                                                                    </span>
                                                                </div>
                                                                <div className="text-xs text-gray-500">{u.title || '未設定職稱'}</div>
                                                            </div>
                                                            <div className="text-right text-xs text-gray-500">
                                                                <div>{u.email}</div>
                                                                <div>{u.phone}</div>
                                                            </div>
                                                        </div>
                                                    ));
                                                })()}
                                            </div>
                                        </div>
                                    )}
                                    {cadreSubtab === 'notification' && (
                                        <div>
                                            <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                                <AlertCircle className="w-5 h-5 mr-2 text-red-600" /> 通知
                                            </h3>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {activeTab === 'application' && hasPermission('application') && (
                            <div className="space-y-6">
                                <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                                    {applicationSubtab === 'signature' && (
                                        <div>
                                            <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                                <FileText className="w-5 h-5 mr-2 text-red-600" /> 電子簽呈
                                            </h3>
                                            <div className="text-center py-8 text-gray-400">
                                                尚無簽呈紀錄
                                            </div>
                                        </div>
                                    )}
                                    {applicationSubtab === 'equipment' && (
                                        <div>
                                            <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                                <FileText className="w-5 h-5 mr-2 text-red-600" /> 設備申請
                                            </h3>
                                            <div className="text-center py-8 text-gray-400">
                                                尚無設備申請紀錄
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {dbUser && activeTab === 'settings' && hasPermission('settings') && (
                            <div className="space-y-6">
                                <AdminDashboard 
                                    user={user}
                                    currentUser={dbUser} 
                                    users={usersList} 
                                    communities={communities}
                                    roles={roles}
                                    companies={companies}
                                    areas={areas}
                                    pages={availablePages}
                                    onAddUser={handleAddUser}
                                    onAddCommunity={handleAddCommunity}
                                    subtab={settingsSubtab}
                                />
                            </div>
                        )}
                        </div>
                    </main>

                    {/* Cadre Company Selection Bar - Only visible on Cadre tab */}
                    {activeTab === 'cadre' && (
                        <div className="fixed bottom-[8vh] left-0 right-0 z-40 bg-white bg-opacity-80 border-t border-gray-100 shadow-lg transform transition-transform duration-300">
                            <div className="max-w-md mx-auto px-4 py-3 flex items-center justify-center gap-3">
                                <div className="flex gap-2">
                                    {companies.map(company => {
                                        const name = company.name || '';
                                        const len = name.length;
                                        let displayName = name;
                                        
                                        if (len === 4) {
                                            displayName = <>{name.slice(0, 2)}<br/>{name.slice(2)}</>;
                                        } else if (len === 5) {
                                            displayName = <>{name.slice(0, 2)}<br/>{name.slice(2)}</>;
                                        } else if (len === 6) {
                                            displayName = <>{name.slice(0, 3)}<br/>{name.slice(3)}</>;
                                        }

                                        return (
                                            <button 
                                                key={company.id}
                                                onClick={() => {
                                                    setCadreCompany(name);
                                                    setCadreMapSelectedUserId(null);
                                                }}
                                                className={`w-[40px] h-[40px] flex items-center justify-center text-xs leading-tight font-bold rounded-2xl transition-colors shadow-md ${
                                                    cadreCompany === name 
                                                        ? 'bg-red-600 text-white' 
                                                        : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                                                }`}
                                            >
                                                {displayName}
                                            </button>
                                        );
                                    })}
                                    {companies.length === 0 && (
                                        <div className="text-xs text-gray-400 italic">尚無公司資料</div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="fixed bottom-0 left-0 right-0 z-50 h-[8vh] bg-white border-t border-gray-100">
                        <div className="max-w-md mx-auto h-full px-4 flex items-center justify-between">
                            {hasPermission('home') && (
                                <button onClick={() => switchTab('home')} className={`flex flex-col items-center font-bold text-xs ${activeTab === 'home' ? 'text-red-600' : 'text-gray-600'}`}>
                                    <Home className="w-5 h-5 mb-1" /> 首頁
                                </button>
                            )}
                            {hasPermission('overview') && (
                                <button onClick={() => switchTab('overview')} className={`flex flex-col items-center font-bold text-xs ${activeTab === 'overview' ? 'text-red-600' : 'text-gray-600'}`}>
                                    <BarChart3 className="w-5 h-5 mb-1" /> 總覽
                                </button>
                            )}
                            {hasPermission('clock') && (
                                <button onClick={() => switchTab('clock')} className={`flex flex-col items-center font-bold text-xs ${activeTab === 'clock' ? 'text-red-600' : 'text-gray-600'}`}>
                                    <ClipboardList className="w-5 h-5 mb-1" /> 打卡
                                </button>
                            )}
                            {hasPermission('community') && (
                                <button onClick={() => switchTab('community')} className={`flex flex-col items-center font-bold text-xs ${activeTab === 'community' ? 'text-red-600' : 'text-gray-600'}`}>
                                    <Building2 className="w-5 h-5 mb-1" /> 社區
                                </button>
                            )}
                            {hasPermission('function') && (
                                <button onClick={() => switchTab('function')} className={`flex flex-col items-center font-bold text-xs ${activeTab === 'function' ? 'text-red-600' : 'text-gray-600'}`}>
                                    <Briefcase className="w-5 h-5 mb-1" /> 功能
                                </button>
                            )}
                            {hasPermission('cadre') && (
                                <button onClick={() => switchTab('cadre')} className={`flex flex-col items-center font-bold text-xs ${activeTab === 'cadre' ? 'text-red-600' : 'text-gray-600'}`}>
                                    <Shield className="w-5 h-5 mb-1" /> 幹部
                                </button>
                            )}
                            {hasPermission('application') && (
                                <button onClick={() => switchTab('application')} className={`flex flex-col items-center font-bold text-xs ${activeTab === 'application' ? 'text-red-600' : 'text-gray-600'}`}>
                                    <FileText className="w-5 h-5 mb-1" /> 申請
                                </button>
                            )}
                            {hasPermission('hr') && (
                                <button onClick={() => switchTab('hr')} className={`flex flex-col items-center font-bold text-xs ${activeTab === 'hr' ? 'text-red-600' : 'text-gray-600'}`}>
                                    <Users className="w-5 h-5 mb-1" /> 人事
                                </button>
                            )}
                            {hasPermission('settings') && (
                                <button onClick={() => switchTab('settings')} className={`flex flex-col items-center font-bold text-xs ${activeTab === 'settings' ? 'text-red-600' : 'text-gray-600'}`}>
                                    <Settings className="w-5 h-5 mb-1" /> 設定
                                </button>
                            )}
                        </div>
                    </div>

                    {mapPreviewTarget && (
                        <div className="fixed inset-0 z-[70] bg-black/80 flex items-center justify-center p-4" onClick={()=>setMapPreviewTarget(null)}>
                            <div className="bg-white rounded-2xl shadow-xl w-full max-w-2xl h-[500px] overflow-hidden flex flex-col relative" onClick={e=>e.stopPropagation()}>
                                <div className="absolute top-4 right-4 z-10">
                                    <button onClick={()=>setMapPreviewTarget(null)} className="p-2 bg-white rounded-full shadow-lg hover:bg-gray-100">
                                        <X className="w-5 h-5" />
                                    </button>
                                </div>
                                <div className="flex-1 w-full h-full relative">
                                    <CompanyMapPreview 
                                        lat={mapPreviewTarget.lat} 
                                        lng={mapPreviewTarget.lng} 
                                        radius={mapPreviewTarget.radius} 
                                    />
                                    <div className="absolute bottom-4 left-4 bg-white/90 px-3 py-2 rounded-xl shadow-lg text-xs font-bold text-gray-700 pointer-events-none">
                                        <div className="text-sm mb-1">{mapPreviewTarget.name}</div>
                                        <div>打卡範圍: {mapPreviewTarget.radius || 100}m</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    <CameraModal 
                        isOpen={showCameraModal} 
                        onClose={() => setShowCameraModal(false)}
                        onConfirm={handleCameraConfirm}
                        type={clockType}
                        userName={dbUser?.name}
                        userAvatar={dbUser?.avatarUrl}
                        workSite={communities.find(c => c.id === dbUser?.communityId)}
                        checkInLocationName={checkInLocation ? checkInLocation.name : (dbUser?.communityName || '')}
                        availableLocations={availableClockInLocations}
                        checkInLocation={checkInLocation}
                        setCheckInLocation={setCheckInLocation}
                    />

                    <ImagePreviewModal 
                        url={previewImageUrl} 
                        onClose={() => setPreviewImageUrl(null)}
                    />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
