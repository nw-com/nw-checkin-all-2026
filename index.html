<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>2026西北社區打卡系統 - 登入</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root { --red:#d32f2f; --red-d:#b71c1c; --gray:#f4f5f7; --text:#222; --muted:#6b7280; }
    * { box-sizing:border-box; }
    html, body { height:100%; background:var(--gray); color:var(--text); font-family:"Noto Sans TC", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; }
    .wrap { min-height:100%; display:flex; align-items:center; justify-content:center; padding:24px; }
    .card { width:100%; max-width:420px; background:#fff; border-radius:16px; box-shadow:0 8px 24px rgba(0,0,0,.08); overflow:hidden; }
    .brand { display:flex; align-items:center; gap:12px; padding:16px 20px; background:linear-gradient(90deg,var(--red),var(--red-d)); color:#fff; }
    .logo { width:36px; height:36px; border-radius:50%; background:#fff2; display:flex; align-items:center; justify-content:center; font-weight:700; letter-spacing:1px; }
    .title { font-weight:700; font-size:16px; line-height:1.2; }
    .body { padding:20px; }
    .tabs { display:flex; background:#f8f8f8; border-radius:10px; padding:4px; margin-bottom:16px; }
    .tab { flex:1; text-align:center; padding:10px 12px; border-radius:8px; font-weight:500; color:var(--muted); cursor:pointer; }
    .tab.active { background:#fff; color:var(--red-d); box-shadow:0 1px 2px rgba(0,0,0,.04); }
    .field { display:flex; flex-direction:column; gap:6px; margin-bottom:12px; }
    .label { font-size:13px; color:#374151; }
    .input { width:100%; padding:12px 14px; border:1px solid #e5e7eb; border-radius:10px; font-size:16px; outline:none; transition:.15s; background:#fff; }
    .input:focus { border-color:var(--red); box-shadow:0 0 0 3px rgba(211,47,47,.15); }
    .password-row { position:relative; }
    .toggle { position:absolute; right:10px; top:50%; transform:translateY(-50%); background:#f3f4f6; border:1px solid #e5e7eb; color:#374151; padding:6px 10px; border-radius:8px; font-size:12px; cursor:pointer; }
    .row { display:flex; align-items:center; justify-content:space-between; gap:12px; margin:8px 0 16px; }
    .checkbox { display:flex; align-items:center; gap:8px; font-size:14px; color:#374151; }
    .btn { width:100%; padding:12px 14px; border:none; border-radius:10px; background:var(--red); color:#fff; font-weight:600; font-size:16px; cursor:pointer; transition:.15s; }
    .btn:active { transform:scale(.99); }
    .link { display:inline-block; color:var(--red-d); text-decoration:none; font-weight:500; }
    .help { font-size:12px; color:var(--muted); margin-top:8px; }
    .error { color:#b00020; font-size:13px; margin-top:8px; min-height:18px; }
    .divider { height:1px; background:#eee; margin:16px 0; }
    .center { text-align:center; }
    .hidden { display:none !important; }
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:flex-end; justify-content:center; padding:16px; }
    .modal { width:100%; max-width:420px; background:#fff; border-radius:16px 16px 0 0; padding:16px; box-shadow:0 -8px 24px rgba(0,0,0,.2); }
    .modal h3 { margin:0 0 8px; font-size:18px; }
    .modal-actions { display:flex; gap:10px; margin-top:8px; }
    .btn-outline { flex:1; padding:12px 14px; border:1px solid var(--red); border-radius:10px; background:#fff; color:var(--red); font-weight:600; font-size:16px; cursor:pointer; }
    .btn-primary { flex:1; padding:12px 14px; border:none; border-radius:10px; background:var(--red); color:#fff; font-weight:600; font-size:16px; cursor:pointer; }
    .role-badge { display:inline-block; padding:6px 10px; border-radius:999px; background:#f3f4f6; color:#374151; font-size:12px; margin:4px 6px 0 0; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="brand">
        <div class="logo">NW</div>
        <div class="title">2026西北社區打卡系統</div>
      </div>
      <div class="body">
        <div class="tabs">
          <div id="tab-email" class="tab active">電子郵件</div>
          <div id="tab-phone" class="tab">手機號碼</div>
        </div>

        <form id="form-email" autocomplete="on">
          <div class="field">
            <label class="label">電子郵件</label>
            <input id="email" class="input" type="email" inputmode="email" placeholder="name@example.com" required>
          </div>
          <div class="field password-row">
            <label class="label">密碼（至少6位英數）</label>
            <input id="password" class="input" type="password" placeholder="••••••" minlength="6" required>
            <button type="button" id="togglePwd" class="toggle">顯示</button>
          </div>
          <div class="row">
            <label class="checkbox"><input id="remember" type="checkbox" checked> 記住我</label>
            <a id="openRegister" class="link" href="#">註冊申請</a>
          </div>
          <button id="btnEmailLogin" type="submit" class="btn">登入</button>
          <div id="emailError" class="error"></div>
        </form>

        <form id="form-phone" class="hidden" autocomplete="off">
          <div class="field">
            <label class="label">手機號碼</label>
            <input id="phone" class="input" type="tel" inputmode="tel" placeholder="例如 0912345678 或 +886912345678" required>
            <div id="recaptcha-container" class="help"></div>
          </div>
          <div class="row">
            <button id="btnSendCode" type="button" class="btn">傳送驗證碼</button>
          </div>
          <div id="codeArea" class="hidden">
            <div class="field">
              <label class="label">簡訊驗證碼</label>
              <input id="smsCode" class="input" type="text" inputmode="numeric" placeholder="6位數字" minlength="6" maxlength="6" required>
            </div>
            <button id="btnVerifyCode" type="button" class="btn">完成登入</button>
          </div>
          <div id="phoneError" class="error"></div>
          <div class="help">登入後依個人設定指派角色與權限</div>
        </form>

        <div class="divider"></div>
        <div class="center">
          <span class="role-badge">系統管理員</span>
          <span class="role-badge">人事</span>
          <span class="role-badge">主管</span>
          <span class="role-badge">總幹事</span>
          <span class="role-badge">秘書</span>
          <span class="role-badge">清潔</span>
          <span class="role-badge">機電</span>
          <span class="role-badge">保全</span>
        </div>
      </div>
    </div>
  </div>

  <div id="registerModal" class="modal-backdrop">
    <div class="modal">
      <h3>註冊申請</h3>
      <div class="field"><label class="label">姓名</label><input id="regName" class="input" type="text" required></div>
      <div class="field"><label class="label">電子郵件（或手機）</label><input id="regContact" class="input" type="text" required></div>
      <div class="field">
        <label class="label">角色</label>
        <select id="regRole" class="input">
          <option>系統管理員</option>
          <option>人事</option>
          <option>主管</option>
          <option>總幹事</option>
          <option>秘書</option>
          <option>清潔</option>
          <option>機電</option>
          <option>保全</option>
        </select>
      </div>
      <div id="regError" class="error"></div>
      <div class="modal-actions">
        <button id="closeRegister" class="btn-outline" type="button">取消</button>
        <button id="submitRegister" class="btn-primary" type="button">送出申請</button>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBa3EfodIJk4hZgH0zEHTlEGqSxncpkIbs",
      authDomain: "nw-checkin-all-2026.firebaseapp.com",
      projectId: "nw-checkin-all-2026",
      storageBucket: "nw-checkin-all-2026.firebasestorage.app",
      messagingSenderId: "840454751760",
      appId: "1:840454751760:web:58bbfa83cb146f4fc7ac95",
      measurementId: "G-NQ0W45T9CK"
    };
    firebase.initializeApp(firebaseConfig);
    if (firebase.analytics) { try { firebase.analytics(); } catch(e){} }
    const auth = firebase.auth();
    const db = firebase.firestore();

    const tabEmail = document.getElementById('tab-email');
    const tabPhone = document.getElementById('tab-phone');
    const formEmail = document.getElementById('form-email');
    const formPhone = document.getElementById('form-phone');
    const emailEl = document.getElementById('email');
    const pwdEl = document.getElementById('password');
    const togglePwd = document.getElementById('togglePwd');
    const rememberEl = document.getElementById('remember');
    const emailError = document.getElementById('emailError');
    const phoneEl = document.getElementById('phone');
    const btnSendCode = document.getElementById('btnSendCode');
    const codeArea = document.getElementById('codeArea');
    const smsCodeEl = document.getElementById('smsCode');
    const btnVerifyCode = document.getElementById('btnVerifyCode');
    const phoneError = document.getElementById('phoneError');
    const openRegister = document.getElementById('openRegister');
    const registerModal = document.getElementById('registerModal');
    const closeRegister = document.getElementById('closeRegister');
    const submitRegister = document.getElementById('submitRegister');
    const regName = document.getElementById('regName');
    const regContact = document.getElementById('regContact');
    const regRole = document.getElementById('regRole');
    const regError = document.getElementById('regError');

    let confirmationResult = null;
    let recaptcha = null;

    function setActiveTab(tab) {
      if (tab === 'email') {
        tabEmail.classList.add('active');
        tabPhone.classList.remove('active');
        formEmail.classList.remove('hidden');
        formPhone.classList.add('hidden');
      } else {
        tabPhone.classList.add('active');
        tabEmail.classList.remove('active');
        formPhone.classList.remove('hidden');
        formEmail.classList.add('hidden');
      }
      emailError.textContent='';
      phoneError.textContent='';
    }

    tabEmail.addEventListener('click', () => setActiveTab('email'));
    tabPhone.addEventListener('click', () => setActiveTab('phone'));

    togglePwd.addEventListener('click', () => {
      const isPwd = pwdEl.getAttribute('type') === 'password';
      pwdEl.setAttribute('type', isPwd ? 'text' : 'password');
      togglePwd.textContent = isPwd ? '隱藏' : '顯示';
    });

    function isAlnum(str) { return /^[A-Za-z0-9]{6,}$/.test(str); }

    formEmail.addEventListener('submit', async (e) => {
      e.preventDefault();
      emailError.textContent='';
      const email = emailEl.value.trim();
      const pwd = pwdEl.value.trim();
      if (!isAlnum(pwd)) { emailError.textContent='密碼需至少6位英數組合'; return; }
      try {
        await auth.setPersistence(rememberEl.checked ? firebase.auth.Auth.Persistence.LOCAL : firebase.auth.Auth.Persistence.SESSION);
        await auth.signInWithEmailAndPassword(email, pwd);
        location.replace('./');
      } catch(err) {
        emailError.textContent = err && err.message ? err.message : '登入失敗';
      }
    });

    function toE164(t) {
      const s = t.replace(/\s|-/g,'');
      if (s.startsWith('+')) return s;
      if (/^09\d{8}$/.test(s)) return '+886' + s.slice(1);
      return s;
    }

    btnSendCode.addEventListener('click', async () => {
      phoneError.textContent='';
      const phoneRaw = phoneEl.value.trim();
      const phone = toE164(phoneRaw);
      if (!/^\+\d{10,15}$/.test(phone)) { phoneError.textContent='請輸入正確的國際格式電話'; return; }
      try {
        if (!recaptcha) recaptcha = new firebase.auth.RecaptchaVerifier('recaptcha-container', { size:'invisible' });
        confirmationResult = await auth.signInWithPhoneNumber(phone, recaptcha);
        codeArea.classList.remove('hidden');
      } catch(err) {
        phoneError.textContent = err && err.message ? err.message : '驗證碼傳送失敗';
      }
    });

    btnVerifyCode.addEventListener('click', async () => {
      phoneError.textContent='';
      const code = smsCodeEl.value.trim();
      if (!/^\d{6}$/.test(code)) { phoneError.textContent='請輸入6位數驗證碼'; return; }
      try {
        if (!confirmationResult) { phoneError.textContent='請先傳送驗證碼'; return; }
        await confirmationResult.confirm(code);
        location.replace('./');
      } catch(err) {
        phoneError.textContent = err && err.message ? err.message : '驗證碼錯誤';
      }
    });

    openRegister.addEventListener('click', (e) => { e.preventDefault(); registerModal.style.display='flex'; regError.textContent=''; });
    closeRegister.addEventListener('click', () => { registerModal.style.display='none'; });
    submitRegister.addEventListener('click', async () => {
      regError.textContent='';
      const name = regName.value.trim();
      const contact = regContact.value.trim();
      const role = regRole.value;
      if (!name || !contact) { regError.textContent='請完整填寫資料'; return; }
      try {
        await db.collection('registration_requests').add({ name, contact, role, status:'pending', createdAt: firebase.firestore.FieldValue.serverTimestamp() });
        registerModal.style.display='none';
        alert('已送出申請');
      } catch(err) {
        regError.textContent = err && err.message ? err.message : '送出失敗';
      }
    });
  </script>
</body>
</html>
